{
    "vfp_id": "vfp_00100",
    "project_name": "ChainSecurity_Gearbox_Permissionless_Audit.pdf",
    "findings": [
        {
            "id": 3,
            "category": {
                "1": [
                    "CWE-682"
                ]
            },
            "title": "Overwritten Version in AddressProvider",
            "description": "The AddressProvider._setAddress() function incorrectly computes subversions using the wrong variable (version instead of _version), causing all versions to be recorded with the same subversion values (e.g., 300, 310), even when targeting newer versions like 320. This breaks the versioning system's integrity. Attackers could exploit this to overwrite critical addresses under false version assumptions. The impact is corruption of the versioning mechanism, leading to potential misrouting of system calls.\n",
            "severity": "High",
            "location": [
                "AddressProvider.sol::_setAddress"
            ],
            "files": [
                "permissionless/contracts/instance/AddressProvider.sol"
            ]
        }
    ],
    "affected_files": {
        "AddressProvider.sol": "// SPDX-License-Identifier: BUSL-1.1\n// Gearbox Protocol. Generalized leverage for DeFi protocols\n// (c) Gearbox Foundation, 2024.\npragma solidity ^0.8.23;\n\nimport {EnumerableSet} from \"@openzeppelin/contracts/utils/structs/EnumerableSet.sol\";\n\nimport {LibString} from \"@solady/utils/LibString.sol\";\n\nimport {IVersion} from \"@gearbox-protocol/core-v3/contracts/interfaces/base/IVersion.sol\";\nimport {AddressNotFoundException} from \"@gearbox-protocol/core-v3/contracts/interfaces/IExceptions.sol\";\n\nimport {IAddressProvider, ContractValue} from \"../interfaces/IAddressProvider.sol\";\nimport {AP_ADDRESS_PROVIDER, NO_VERSION_CONTROL} from \"../libraries/ContractLiterals.sol\";\nimport {ImmutableOwnableTrait} from \"../traits/ImmutableOwnableTrait.sol\";\n\nstruct ContractKey {\n    string key;\n    uint256 version;\n}\n\n/// @title Address provider V3\n/// @notice Stores addresses of important contracts\ncontract AddressProvider is ImmutableOwnableTrait, IAddressProvider {\n    using EnumerableSet for EnumerableSet.AddressSet;\n    // using LibString for string;\n    using LibString for bytes32;\n\n    /// @notice Contract version\n    uint256 public constant override version = 3_10;\n    bytes32 public constant override contractType = AP_ADDRESS_PROVIDER;\n\n    /// @notice Mapping from (contract key, version) to contract addresses\n    mapping(string => mapping(uint256 => address)) public override addresses;\n\n    mapping(string => uint256) public latestVersions;\n    mapping(string => mapping(uint256 => uint256)) public latestMinorVersions;\n    mapping(string => mapping(uint256 => uint256)) public latestPatchVersions;\n\n    ContractKey[] internal contractKeys;\n\n    error VersionNotFoundException();\n\n    constructor(address _owner) ImmutableOwnableTrait(_owner) {\n        // The first event is emitted for the address provider itself to aid in contract discovery\n        emit SetAddress(AP_ADDRESS_PROVIDER.fromSmallString(), version, address(this));\n    }\n\n    /// @notice Returns the address of a contract with a given key and version\n    function getAddressOrRevert(string memory key, uint256 _version)\n        public\n        view\n        virtual\n        override\n        returns (address result)\n    {\n        result = addresses[key][_version];\n        if (result == address(0)) revert AddressNotFoundException();\n    }\n\n    /// @notice Returns the address of a contract with a given key and version\n    function getAddressOrRevert(bytes32 key, uint256 _version) public view virtual override returns (address result) {\n        return getAddressOrRevert(key.fromSmallString(), _version);\n    }\n\n    function getLatestVersion(string memory key) external view override returns (uint256) {\n        uint256 latestVersion = latestVersions[key];\n        if (latestVersion == 0) revert VersionNotFoundException();\n        return latestVersion;\n    }\n\n    function getLatestMinorVersion(string memory key, uint256 majorVersion) external view override returns (uint256) {\n        uint256 latestMinorVersion = latestMinorVersions[key][majorVersion];\n        if (latestMinorVersion == 0) revert VersionNotFoundException();\n        return latestMinorVersion;\n    }\n\n    function getLatestPatchVersion(string memory key, uint256 minorVersion) external view override returns (uint256) {\n        uint256 latestPatchVersion = latestPatchVersions[key][minorVersion];\n        if (latestPatchVersion == 0) revert VersionNotFoundException();\n        return latestPatchVersion;\n    }\n\n    /// @notice Sets the address for the passed contract key\n    /// @param key Contract key\n    /// @param value Contract address\n    /// @param saveVersion Whether to save contract's version\n    function setAddress(string memory key, address value, bool saveVersion) external override onlyOwner {\n        _setAddress(key, value, saveVersion ? IVersion(value).version() : NO_VERSION_CONTROL);\n    }\n\n    function setAddress(bytes32 key, address value, bool saveVersion) external override onlyOwner {\n        _setAddress(key.fromSmallString(), value, saveVersion ? IVersion(value).version() : NO_VERSION_CONTROL);\n    }\n\n    /// @notice Sets the address for the passed contract key\n    /// @param addr Contract address\n    /// @param saveVersion Whether to save contract's version\n    function setAddress(address addr, bool saveVersion) external override onlyOwner {\n        _setAddress(\n            IVersion(addr).contractType().fromSmallString(),\n            addr,\n            saveVersion ? IVersion(addr).version() : NO_VERSION_CONTROL\n        );\n    }\n\n    /// @dev Implementation of `setAddress`\n    function _setAddress(string memory key, address value, uint256 _version) internal virtual {\n        addresses[key][_version] = value;\n        uint256 latestVersion = latestVersions[key];\n\n        if (_version > latestVersion) {\n            latestVersions[key] = _version;\n            uint256 minorVersion = version / 100 * 100;\n            uint256 patchVersion = version / 10 * 10;\n            latestMinorVersions[key][minorVersion] = _version;\n            latestPatchVersions[key][patchVersion] = _version;\n        }\n        contractKeys.push(ContractKey(key, _version));\n\n        emit SetAddress(key, _version, value);\n    }\n\n    function getAllSavedContracts() external view returns (ContractValue[] memory) {\n        ContractValue[] memory result = new ContractValue[](contractKeys.length);\n        for (uint256 i = 0; i < contractKeys.length; i++) {\n            result[i] = ContractValue(\n                contractKeys[i].key, addresses[contractKeys[i].key][contractKeys[i].version], contractKeys[i].version\n            );\n        }\n        return result;\n    }\n}\n"
    }
}