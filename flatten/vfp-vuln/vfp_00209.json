{
    "vfp_id": "vfp_00209",
    "project_name": "ackee-blockchain-let's-get-hai-new-core-features-report.pdf",
    "findings": [
        {
            "id": 3,
            "category": {
                "1": [
                    "CWE-710"
                ],
                "2": [
                    "CWE-684"
                ],
                "3": [
                    "CWE-440"
                ]
            },
            "title": "External interface IPessimisticVeloLpOracle is outdated",
            "description": "The `IPessimisticVeloLpOracle` interface defines a function `getCurrentPoolPrice`, but the actual implementation at the provided address uses `getCurrentPrice`, making the two incompatible. This mismatch causes any call to `_getPriceValue` through the interface to revert, breaking functionality in dependent contracts such as `BeefyVeloVaultRelayer` and `YearnVeloVaultRelayer`. The root cause is a failure to synchronize the interface definition with the deployed implementation, likely due to a refactor that was not reflected in the audited codebase. An attacker cannot directly exploit this for financial gain, but any user or protocol component relying on these oracle functions will experience failed transactions, leading to a denial of service. The impact is high in terms of system usability, as core oracle functionality becomes non-operational, potentially halting dependent processes in the protocol.\n",
            "severity": "High",
            "location": [
                "IPessimisticVeloLpOracle.sol::getCurrentPoolPrice",
                "BeefyVeloVaultRelayer.sol::getResultWithValidity",
                "YearnVeloVaultRelayer.sol::read"
            ],
            "files": [
                "core/src/interfaces/external/IPessimisticVeloLpOracle.sol",
                "core/src/contracts/oracles/BeefyVeloVaultRelayer.sol"
            ]
        }
    ],
    "affected_files": {
        "IPessimisticVeloLpOracle.sol": "// SPDX-License-Identifier: MIT\npragma solidity 0.8.20;\n\ninterface IPessimisticVeloLpOracle {\n  function getCurrentPoolPrice(address _pool) external view returns (uint256 _price);\n}\n",
        "BeefyVeloVaultRelayer.sol": "// SPDX-License-Identifier: GPL-3.0\npragma solidity 0.8.20;\n\nimport {IBaseOracle} from '@interfaces/oracles/IBaseOracle.sol';\n\nimport {IBeefyVeloVaultRelayer} from '@interfaces/oracles/IBeefyVeloVaultRelayer.sol';\n\nimport {IBeefyVaultV7} from '@interfaces/external/IBeefyVaultV7.sol';\nimport {IVeloPool} from '@interfaces/external/IVeloPool.sol';\nimport {IPessimisticVeloLpOracle} from '@interfaces/external/IPessimisticVeloLpOracle.sol';\n\nimport {Math, WAD} from '@libraries/Math.sol';\n\nimport {AbstractVeloVaultRelayer} from './AbstractVeloVaultRelayer.sol';\n\n/**\n * @title  BeefyVeloVaultRelayer\n * @notice Deconstructs a Beefy Vault to it's Velodrome liquidity pool and that pool's constituent tokens to return a price feed\n * @dev  Requires an underlying Velodrome pool and price feeds for the pool's tokens\n */\ncontract BeefyVeloVaultRelayer is AbstractVeloVaultRelayer, IBeefyVeloVaultRelayer {\n  using Math for uint256;\n\n  // --- Registry ---\n  /// @inheritdoc IBeefyVeloVaultRelayer\n  IBeefyVaultV7 public beefyVault;\n\n  // --- Init ---\n\n  /**\n   *\n   * @param  _beefyVault The address of the beefy vault contract\n   * @param  _veloPool The address of the velo pool underlying the beefy vault\n   * @param _veloLpOracle The address of the pessimistic velo lp oracle\n   */\n  constructor(\n    IBeefyVaultV7 _beefyVault,\n    IVeloPool _veloPool,\n    IPessimisticVeloLpOracle _veloLpOracle\n  ) AbstractVeloVaultRelayer(_veloPool, _veloLpOracle, string(abi.encodePacked(_beefyVault.symbol(), ' / USD'))) {\n    if (address(_beefyVault) == address(0)) {\n      revert BeefyVeloVaultRelayer_NullBeefyVault();\n    }\n\n    beefyVault = _beefyVault;\n  }\n\n  /// @notice Returns the price of the moo token\n  function _getPriceValue() internal view override returns (uint256 _combinedPriceValue) {\n    // 1 mooToken\n    uint256 _mooTokenBalance = 1_000_000_000_000_000_000;\n\n    // # of velo LP tokens in 1 mooToken\n    uint256 _veloLpBalance = _mooTokenBalance.wmul(beefyVault.getPricePerFullShare());\n\n    // price of 1 velo LP token in chainlink price decimals (8)\n    uint256 _veloLpPrice = veloLpOracle.getCurrentPoolPrice(address(veloPool));\n\n    return (_veloLpBalance * _veloLpPrice) / 1e8;\n  }\n}\n"
    }
}