{
    "vfp_id": "vfp_00121",
    "project_name": "2025-05-caplabs-coveredagentprotocol-securityreview.pdf",
    "findings": [
        {
            "id": 60,
            "category": {
                "1": [
                    "CWE-664"
                ],
                "2": [
                    "CWE-221"
                ],
                "3": [
                    "CWE-223"
                ]
            },
            "title": "Unaccounted external vault investment losses can create withdrawal shortfalls",
            "description": "Losses from external vault investments are not accounted for in the protocol's accounting model, which can lead to insufficient funds when users attempt to withdraw. The cause is the lack of loss tracking from external strategies. An attacker could exploit market downturns or failed strategies to trigger withdrawals that exceed available funds. This results in withdrawal shortfalls and potential insolvency for the vault.\n",
            "severity": "Medium",
            "location": [
                "ExternalVaultAdapter.sol"
            ],
            "files": [
                "cap-contracts/contracts/vault/FractionalReserve.sol"
            ]
        }
    ],
    "affected_files": {
        "FractionalReserve.sol": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.28;\n\nimport { Access } from \"../access/Access.sol\";\n\nimport { IFractionalReserve } from \"../interfaces/IFractionalReserve.sol\";\nimport { FractionalReserveStorageUtils } from \"../storage/FractionalReserveStorageUtils.sol\";\nimport { FractionalReserveLogic } from \"./libraries/FractionalReserveLogic.sol\";\n\n/// @title Fractional Reserve\n/// @author kexley, @capLabs\n/// @notice Idle capital is put to work in fractional reserve vaults and can be recalled when\n/// withdrawing, redeeming or borrowing.\nabstract contract FractionalReserve is IFractionalReserve, Access, FractionalReserveStorageUtils {\n    /// @dev Initialize unchained\n    /// @param _feeAuction Fee auction address\n    function __FractionalReserve_init(address _feeAuction) internal onlyInitializing {\n        getFractionalReserveStorage().feeAuction = _feeAuction;\n    }\n\n    /// @notice Invest unborrowed capital in a fractional reserve vault (up to the reserve)\n    /// @param _asset Asset address\n    function investAll(address _asset) external checkAccess(this.investAll.selector) {\n        FractionalReserveLogic.invest(getFractionalReserveStorage(), _asset);\n    }\n\n    /// @notice Divest all of an asset from a fractional reserve vault and send any profit to fee auction\n    /// @dev If the vault has just been invested and no interest has been earned there could be a 1 wei revert since redemption wont equal loaned\n    /// @param _asset Asset address\n    function divestAll(address _asset) external checkAccess(this.divestAll.selector) {\n        FractionalReserveLogic.divest(getFractionalReserveStorage(), _asset);\n    }\n\n    /// @notice Divest some of an asset from a fractional reserve vault and send any profit to fee auction\n    /// @param _asset Asset address\n    /// @param _amountOut Amount of asset to divest\n    function divest(address _asset, uint256 _amountOut) internal {\n        FractionalReserveLogic.divest(getFractionalReserveStorage(), _asset, _amountOut);\n    }\n\n    /// @notice Divest some of many assets from a fractional reserve vault and send any profit to fee auction\n    /// @param _assets Asset addresses\n    /// @param _amountsOut Amounts of assets to divest\n    function divestMany(address[] memory _assets, uint256[] memory _amountsOut) internal {\n        FractionalReserveStorage storage $ = getFractionalReserveStorage();\n        for (uint256 i; i < _assets.length; ++i) {\n            FractionalReserveLogic.divest($, _assets[i], _amountsOut[i]);\n        }\n    }\n\n    /// @notice Set the fractional reserve vault for an asset, divesting the old vault entirely\n    /// @param _asset Asset address\n    /// @param _vault Fractional reserve vault\n    function setFractionalReserveVault(address _asset, address _vault)\n        external\n        checkAccess(this.setFractionalReserveVault.selector)\n    {\n        FractionalReserveStorage storage $ = getFractionalReserveStorage();\n        FractionalReserveLogic.divest($, _asset);\n        FractionalReserveLogic.setFractionalReserveVault($, _asset, _vault);\n    }\n\n    /// @notice Set the reserve level for an asset\n    /// @param _asset Asset address\n    /// @param _reserve Reserve level in asset decimals\n    function setReserve(address _asset, uint256 _reserve) external checkAccess(this.setReserve.selector) {\n        FractionalReserveLogic.setReserve(getFractionalReserveStorage(), _asset, _reserve);\n    }\n\n    /// @notice Realize interest from a fractional reserve vault and send to the fee auction\n    /// @dev Left permissionless so arbitrageurs can move fees to auction\n    /// @param _asset Asset address\n    function realizeInterest(address _asset) external {\n        FractionalReserveLogic.realizeInterest(getFractionalReserveStorage(), _asset);\n    }\n\n    /// @notice Interest from a fractional reserve vault\n    /// @param _asset Asset address\n    /// @return interest Claimable amount of asset\n    function claimableInterest(address _asset) external view returns (uint256 interest) {\n        interest = FractionalReserveLogic.claimableInterest(getFractionalReserveStorage(), _asset);\n    }\n\n    /// @notice Fractional reserve vault address for an asset\n    /// @param _asset Asset address\n    /// @return vaultAddress Vault address\n    function fractionalReserveVault(address _asset) external view returns (address vaultAddress) {\n        vaultAddress = getFractionalReserveStorage().vault[_asset];\n    }\n\n    /// @notice Reserve amount for an asset\n    /// @param _asset Asset address\n    /// @return reserveAmount Reserve amount\n    function reserve(address _asset) external view returns (uint256 reserveAmount) {\n        reserveAmount = getFractionalReserveStorage().reserve[_asset];\n    }\n\n    /// @notice Loaned amount for an asset\n    /// @param _asset Asset address\n    /// @return loanedAmount Loaned amount\n    function loaned(address _asset) external view returns (uint256 loanedAmount) {\n        loanedAmount = getFractionalReserveStorage().loaned[_asset];\n    }\n}\n"
    }
}