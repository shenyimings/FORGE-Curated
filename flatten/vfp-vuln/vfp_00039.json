{
    "vfp_id": "vfp_00039",
    "project_name": "2025.07.18 - Final - Notional Exponent Audit Report.pdf",
    "findings": [
        {
            "id": 13,
            "category": {
                "1": [
                    "CWE-682"
                ]
            },
            "title": "Incorrect tokensClaimed calculation in EthenaCooldownHolder::_finalizeCooldown() blocks withdrawals",
            "description": "When sUSDe.cooldownDuration() is 0, the _startCooldown function immediately redeems sUSDe to USDe and transfers it to the EthenaCooldownHolder contract. Later, during _finalizeCooldown, the function calculates tokensClaimed as balanceAfter - balanceBefore, but since the USDe was already transferred during _startCooldown, both balances are equal, resulting in tokensClaimed = 0. The root cause is the flawed assumption that the balance change occurs only during finalization, ignoring the earlier transfer. This leads to users being unable to claim any tokens from their withdrawal requests if initiated when cooldownDuration was 0. The impact is medium: affected users are permanently locked out of their funds unless the state is manually corrected. The issue stems from incorrect state tracking across two separate function calls in the withdrawal lifecycle.\n",
            "severity": "Medium",
            "location": [
                "Ethena.sol::_startCooldown#16",
                "Ethena.sol::_finalizeCooldown#30"
            ],
            "files": [
                "7e0abc3e118db0abb20c7521c6f53f1762fdf562/2025-06-notional-exponent/notional-v4/src/withdraws/Ethena.sol"
            ]
        }
    ],
    "affected_files": {
        "Ethena.sol": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity >=0.8.29;\n\nimport \"../interfaces/IEthena.sol\";\nimport {ClonedCoolDownHolder} from \"./ClonedCoolDownHolder.sol\";\nimport {AbstractWithdrawRequestManager} from \"./AbstractWithdrawRequestManager.sol\";\nimport {Clones} from \"@openzeppelin/contracts/proxy/Clones.sol\";\n\ncontract EthenaCooldownHolder is ClonedCoolDownHolder {\n\n    constructor(address _manager) ClonedCoolDownHolder(_manager) { }\n\n    /// @notice There is no way to stop a cool down\n    function _stopCooldown() internal pure override { revert(); }\n\n    function _startCooldown(uint256 cooldownBalance) internal override {\n        uint24 duration = sUSDe.cooldownDuration();\n        if (duration == 0) {\n            // If the cooldown duration is set to zero, can redeem immediately\n            sUSDe.redeem(cooldownBalance, address(this), address(this));\n        } else {\n            // If we execute a second cooldown while one exists, the cooldown end\n            // will be pushed further out. This holder should only ever have one\n            // cooldown ever.\n            require(sUSDe.cooldowns(address(this)).cooldownEnd == 0);\n            sUSDe.cooldownShares(cooldownBalance);\n        }\n    }\n\n    function _finalizeCooldown() internal override returns (uint256 tokensClaimed, bool finalized) {\n        uint24 duration = sUSDe.cooldownDuration();\n        IsUSDe.UserCooldown memory userCooldown = sUSDe.cooldowns(address(this));\n\n        if (block.timestamp < userCooldown.cooldownEnd && 0 < duration) {\n            // Cooldown has not completed, return a false for finalized\n            return (0, false);\n        }\n\n        uint256 balanceBefore = USDe.balanceOf(address(this));\n        // If a cooldown has been initiated, need to call unstake to complete it. If\n        // duration was set to zero then the USDe will be on this contract already.\n        if (0 < userCooldown.cooldownEnd) sUSDe.unstake(address(this));\n        uint256 balanceAfter = USDe.balanceOf(address(this));\n\n        // USDe is immutable. It cannot have a transfer tax and it is ERC20 compliant\n        // so we do not need to use the additional protections here.\n        tokensClaimed = balanceAfter - balanceBefore;\n        USDe.transfer(manager, tokensClaimed);\n        finalized = true;\n    }\n}\n\ncontract EthenaWithdrawRequestManager is AbstractWithdrawRequestManager {\n\n    address public HOLDER_IMPLEMENTATION;\n\n    constructor() AbstractWithdrawRequestManager(address(USDe), address(sUSDe), address(USDe)) { }\n\n    function _initialize(bytes calldata /* data */) internal override {\n        HOLDER_IMPLEMENTATION = address(new EthenaCooldownHolder(address(this)));\n    }\n\n    function _stakeTokens(\n        uint256 usdeAmount,\n        bytes memory /* stakeData */\n    ) internal override {\n        USDe.approve(address(sUSDe), usdeAmount);\n        sUSDe.deposit(usdeAmount, address(this));\n    }\n\n    function _initiateWithdrawImpl(\n        address /* account */,\n        uint256 balanceToTransfer,\n        bytes calldata /* data */\n    ) internal override returns (uint256 requestId) {\n        EthenaCooldownHolder holder = EthenaCooldownHolder(Clones.clone(HOLDER_IMPLEMENTATION));\n        sUSDe.transfer(address(holder), balanceToTransfer);\n        holder.startCooldown(balanceToTransfer);\n\n        return uint256(uint160(address(holder)));\n    }\n\n    function _finalizeWithdrawImpl(\n        address /* account */,\n        uint256 requestId\n    ) internal override returns (uint256 tokensClaimed, bool finalized) {\n        EthenaCooldownHolder holder = EthenaCooldownHolder(address(uint160(requestId)));\n        (tokensClaimed, finalized) = holder.finalizeCooldown();\n    }\n\n    function canFinalizeWithdrawRequest(uint256 requestId) public view override returns (bool) {\n        uint24 duration = sUSDe.cooldownDuration();\n        address holder = address(uint160(requestId));\n        // This valuation is the amount of USDe the account will receive at cooldown, once\n        // a cooldown is initiated the account is no longer receiving sUSDe yield. This balance\n        // of USDe is transferred to a Silo contract and guaranteed to be available once the\n        // cooldown has passed.\n        IsUSDe.UserCooldown memory userCooldown = sUSDe.cooldowns(holder);\n        return (userCooldown.cooldownEnd < block.timestamp || 0 == duration);\n    }\n\n}\n"
    }
}