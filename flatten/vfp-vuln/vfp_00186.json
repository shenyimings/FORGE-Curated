{
    "vfp_id": "vfp_00186",
    "project_name": "Uniswap Hooks Library Milestone 1 Audit.md",
    "findings": [
        {
            "id": 5,
            "category": {
                "1": [
                    "CWE-284"
                ],
                "2": [
                    "CWE-285"
                ],
                "3": [
                    "CWE-862"
                ]
            },
            "title": "BaseDynamicFee Hook Can Be Poked Arbitrarily",
            "description": "The BaseDynamicFee hook exposes a public `poke` function that allows anyone to trigger a fee update based on the `_getFee` function. If `_getFee` depends on external state (e.g., pool balances), this enables manipulation of the fee in a single transaction.\n\nThe root cause is the lack of access control on the `poke` function. An attacker can manipulate external conditions (e.g., via a flash loan), call `poke` to set a favorable fee, and execute low-fee swaps before the state is corrected.\n\nThis can be exploited to temporarily reduce swap fees, allowing cheap trades at the expense of the pool or protocol. The impact includes revenue loss for liquidity providers and potential market manipulation, especially if fee updates are not promptly corrected.\n",
            "severity": "Medium",
            "location": [
                "BaseDynamicFee.sol::poke#59",
                "BaseDynamicFee.sol::_getFee#37"
            ],
            "files": [
                "uniswap-hooks/src/fee/BaseDynamicFee.sol"
            ]
        },
        {
            "id": 7,
            "category": {
                "1": [
                    "CWE-710"
                ],
                "2": [
                    "CWE-1068"
                ]
            },
            "title": "Misleading Comments in Codebase",
            "description": "Multiple comments throughout the codebase are inaccurate or misleading, which can lead to incorrect assumptions by developers using or extending the hooks. Examples include incorrect unit descriptions (e.g., fee units described as hundredths of a percent instead of hundredths of a bip), incorrect modifier behavior (e.g., `onlyValidPools` does not validate `msg.sender`), and incorrect function return descriptions (e.g., `_getAddLiquidity` in BaseCustomCurve does not return encoded `ModifyLiquidityParams` as documented).\n\nThe root cause is outdated or imprecise documentation that does not reflect the actual implementation or Uniswap V4's internal logic. This creates a risk that inheriting contracts will be implemented based on false assumptions, leading to logic errors or security vulnerabilities.\n\nWhile not directly exploitable, an attacker could exploit misunderstandings caused by these comments. For example, a developer might incorrectly implement fee logic based on the wrong unit assumption, leading to unexpectedly high or low fees. The impact is reduced code reliability, increased risk of integration bugs, and potential security flaws in derived contracts.\n",
            "severity": "Medium",
            "location": [
                "BaseDynamicFee.sol#35",
                "BaseOverrideFee.sol#49",
                "BaseHook.sol#81",
                "BaseHook.sol#42",
                "BaseCustomAccounting.sol#128",
                "BaseOverrideFee.sol#72",
                "BaseCustomAccounting.sol#296",
                "BaseCustomCurve.sol#57",
                "BaseCustomCurve.sol#71",
                "BaseCustomCurve.sol#153",
                "BaseCustomCurve.sol#132",
                "BaseCustomCurve.sol#114",
                "BaseCustomCurve.sol#120"
            ],
            "files": [
                "uniswap-hooks/src/fee/BaseDynamicFee.sol"
            ]
        }
    ],
    "affected_files": {
        "BaseDynamicFee.sol": "// SPDX-License-Identifier: MIT\n// OpenZeppelin Uniswap Hooks (last updated v0.1.0) (src/fee/BaseDynamicFee.sol)\n\npragma solidity ^0.8.24;\n\nimport {BaseHook} from \"src/base/BaseHook.sol\";\nimport {Hooks} from \"v4-core/src/libraries/Hooks.sol\";\nimport {PoolKey} from \"v4-core/src/types/PoolKey.sol\";\nimport {IPoolManager} from \"v4-core/src/interfaces/IPoolManager.sol\";\nimport {LPFeeLibrary} from \"v4-core/src/libraries/LPFeeLibrary.sol\";\n\n/**\n * @dev Base implementation to apply a dynamic fee via the `PoolManager`'s `updateDynamicLPFee` function.\n *\n * WARNING: This is experimental software and is provided on an \"as is\" and \"as available\" basis. We do\n * not give any warranties and will not be liable for any losses incurred through any use of this code\n * base.\n *\n * _Available since v0.1.0_\n */\nabstract contract BaseDynamicFee is BaseHook {\n    using LPFeeLibrary for uint24;\n\n    /**\n     * @dev The hook was attempted to be initialized with a non-dynamic fee.\n     */\n    error NotDynamicFee();\n\n    /**\n     * @dev Set the `PoolManager` address.\n     */\n    constructor(IPoolManager _poolManager) BaseHook(_poolManager) {}\n\n    /**\n     * @dev Returns a fee, denominated in hundredths of a bip, to be applied to the pool after it is initialized.\n     */\n    function _getFee(PoolKey calldata key) internal virtual returns (uint24);\n\n    /**\n     * @dev Set the fee after the pool is initialized.\n     */\n    function _afterInitialize(address, PoolKey calldata key, uint160, int24)\n        internal\n        virtual\n        override\n        returns (bytes4)\n    {\n        if (!key.fee.isDynamicFee()) revert NotDynamicFee();\n        poolManager.updateDynamicLPFee(key, _getFee(key));\n        return this.afterInitialize.selector;\n    }\n\n    /**\n     * @dev Updates the dynamic LP fee for the given pool, which must have a key\n     * that contains this hook's address.\n     *\n     * WARNING: This function can be called by anyone at any time. If `_getFee` implementation\n     * depends on external conditions (e.g., oracle prices, other pool states, token balances),\n     * it may be vulnerable to manipulation. An attacker could potentially:\n     * 1. Manipulate the external conditions that `_getFee` depends on\n     * 2. Call `poke()` to update the fee to a more favorable rate\n     * 3. Execute trades at the manipulated fee rate\n     *\n     * Inheriting contracts should consider implementing access controls on this function,\n     * make the logic in `_getFee` resistant to short-term manipulation, or accept the risk\n     * of fee manipulation.\n     *\n     * @param key The pool key to update the dynamic LP fee for.\n     */\n    function poke(PoolKey calldata key) external virtual onlyValidPools(key.hooks) {\n        poolManager.updateDynamicLPFee(key, _getFee(key));\n    }\n\n    /**\n     * @dev Set the hook permissions, specifically `afterInitialize`.\n     *\n     * @return permissions The hook permissions.\n     */\n    function getHookPermissions() public pure virtual override returns (Hooks.Permissions memory permissions) {\n        return Hooks.Permissions({\n            beforeInitialize: false,\n            afterInitialize: true,\n            beforeAddLiquidity: false,\n            afterAddLiquidity: false,\n            beforeRemoveLiquidity: false,\n            afterRemoveLiquidity: false,\n            beforeSwap: false,\n            afterSwap: false,\n            beforeDonate: false,\n            afterDonate: false,\n            beforeSwapReturnDelta: false,\n            afterSwapReturnDelta: false,\n            afterAddLiquidityReturnDelta: false,\n            afterRemoveLiquidityReturnDelta: false\n        });\n    }\n}\n"
    }
}