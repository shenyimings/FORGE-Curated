{
    "vfp_id": "vfp_00138",
    "project_name": "cantina_rocketpool_jun2025.pdf",
    "findings": [
        {
            "id": 4,
            "category": {
                "1": [
                    "CWE-664"
                ],
                "2": [
                    "CWE-665"
                ],
                "3": [
                    "CWE-909"
                ]
            },
            "title": "Missing contracts from the RocketUpgradeOneDotFour upgrade contract",
            "description": "The RocketUpgradeOneDotFour upgrade contract omits two critical contracts: RocketMinipoolManager (an existing contract needing upgrade) and RocketMegapoolPenalties (a new contract).\n\nThe root cause is an incomplete upgrade script that fails to register these contracts during the deployment process. This oversight means that state changes or new functionality intended for these contracts will not be properly initialized or linked.\n\nAn attacker could potentially exploit the missing upgrade of RocketMinipoolManager to operate under outdated logic, or the absence of RocketMegapoolPenalties could allow malicious node operators to avoid penalties. While not directly exploitable, the missing contracts introduce functional gaps.\n\nThe impact is incomplete protocol upgrades, leading to missing features, inconsistent state, and potential security risks due to unapplied logic or unenforced penalties.\n",
            "severity": "High",
            "location": [
                "RocketUpgradeOneDotFour.sol",
                "RocketMinipoolManager.sol",
                "RocketMegapoolPenalties.sol"
            ],
            "files": [
                "rocketpool/contracts/contract/upgrade/RocketUpgradeOneDotFour.sol"
            ]
        }
    ],
    "affected_files": {
        "RocketUpgradeOneDotFour.sol": "// SPDX-License-Identifier: GPL-3.0-only\npragma solidity 0.8.30;\n\nimport {RocketStorageInterface} from \"../../interface/RocketStorageInterface.sol\";\nimport {RocketNetworkRevenuesInterface} from \"../../interface/network/RocketNetworkRevenuesInterface.sol\";\nimport {RocketBase} from \"../RocketBase.sol\";\n\ninterface InitialiseInterface {\n    function initialise() external;\n}\n\n/// @notice v1.4 Saturn 1 upgrade contract\ncontract RocketUpgradeOneDotFour is RocketBase {\n    // Whether the upgrade has been performed or not\n    bool internal executed;\n\n    // Upgrade contracts\n    address public immutable rocketMegapoolDelegate;\n    address public immutable rocketMegapoolFactory;\n    address public immutable rocketMegapoolProxy;\n    address public immutable rocketMegapoolManager;\n    address public immutable rocketNodeManager;\n    address public immutable rocketNodeDeposit;\n    address public immutable rocketNodeStaking;\n    address public immutable rocketDepositPool;\n    address public immutable linkedListStorage;\n    address public immutable rocketDAOProtocol;\n    address public immutable rocketDAOProtocolProposals;\n    address public immutable rocketDAOProtocolSettingsNode;\n    address public immutable rocketDAOProtocolSettingsDeposit;\n    address public immutable rocketDAOProtocolSettingsNetwork;\n    address public immutable rocketDAOProtocolSettingsSecurity;\n    address public immutable rocketDAOProtocolSettingsMegapool;\n    address public immutable rocketDAOProtocolSettingsMinipool;\n    address public immutable rocketDAOSecurityUpgrade;\n    address public immutable rocketDAOSecurityProposals;\n    address public immutable rocketDAONodeTrustedUpgrade;\n    address public immutable rocketNetworkRevenues;\n    address public immutable rocketNetworkBalances;\n    address public immutable rocketNetworkSnapshots;\n    address public immutable rocketNetworkPenalties;\n    address public immutable rocketRewardsPool;\n    address public immutable blockRoots;\n    address public immutable beaconStateVerifier;\n    address public immutable rocketNodeDistributorDelegate;\n    address public immutable rocketClaimDAO;\n    address public immutable rocketMinipoolBonderReducer;\n    address public immutable rocketNetworkVoting;\n    address public immutable rocketMerkleDistributorMainnet;\n\n    // Upgrade ABIs\n    string[32] public abis;\n\n    // Construct\n    constructor(\n        RocketStorageInterface _rocketStorageAddress,\n        address[32] memory _addresses,\n        string[32] memory _abis\n    ) RocketBase(_rocketStorageAddress) {\n        // Version\n        version = 1;\n\n        // Set contract addresses\n        rocketMegapoolDelegate = _addresses[0];\n        rocketMegapoolFactory = _addresses[1];\n        rocketMegapoolProxy = _addresses[2];\n        rocketMegapoolManager = _addresses[3];\n        rocketNodeManager = _addresses[4];\n        rocketNodeDeposit = _addresses[5];\n        rocketNodeStaking = _addresses[6];\n        rocketDepositPool = _addresses[7];\n        linkedListStorage = _addresses[8];\n        rocketDAOProtocol = _addresses[9];\n        rocketDAOProtocolProposals = _addresses[10];\n        rocketDAOProtocolSettingsNode = _addresses[11];\n        rocketDAOProtocolSettingsDeposit = _addresses[12];\n        rocketDAOProtocolSettingsNetwork = _addresses[13];\n        rocketDAOProtocolSettingsSecurity = _addresses[14];\n        rocketDAOProtocolSettingsMegapool = _addresses[15];\n        rocketDAOProtocolSettingsMinipool = _addresses[16];\n        rocketDAOSecurityUpgrade = _addresses[17];\n        rocketDAOSecurityProposals = _addresses[18];\n        rocketDAONodeTrustedUpgrade = _addresses[19];\n        rocketNetworkRevenues = _addresses[20];\n        rocketNetworkBalances = _addresses[21];\n        rocketNetworkSnapshots = _addresses[22];\n        rocketNetworkPenalties = _addresses[23];\n        rocketRewardsPool = _addresses[24];\n        blockRoots = _addresses[25];\n        beaconStateVerifier = _addresses[26];\n        rocketNodeDistributorDelegate = _addresses[27];\n        rocketClaimDAO = _addresses[28];\n        rocketMinipoolBonderReducer = _addresses[29];\n        rocketNetworkVoting = _addresses[30];\n        rocketMerkleDistributorMainnet = _addresses[31];\n\n        // Set ABIs\n        abis = _abis;\n    }\n\n    /// @notice Returns the address of the RocketStorage contract\n    function getRocketStorageAddress() external view returns (address) {\n        return address(rocketStorage);\n    }\n\n    /// @notice Once this contract has been voted in by oDAO, guardian can perform the upgrade\n    function execute() external onlyGuardian {\n        require(!executed);\n        executed = true;\n\n        // Add new contracts\n        _addContract(\"rocketMegapoolDelegate\", rocketMegapoolDelegate, abis[0]);\n        _addContract(\"rocketMegapoolFactory\", rocketMegapoolFactory, abis[1]);\n        _addContract(\"rocketMegapoolProxy\", rocketMegapoolProxy, abis[2]);\n        _addContract(\"rocketMegapoolManager\", rocketMegapoolManager, abis[3]);\n        _addContract(\"linkedListStorage\", linkedListStorage, abis[8]);\n        _addContract(\"rocketNetworkRevenues\", rocketNetworkRevenues, abis[20]);\n        _addContract(\"blockRoots\", blockRoots, abis[23]);\n        _addContract(\"beaconStateVerifier\", beaconStateVerifier, abis[24]);\n        _addContract(\"rocketDAOProtocolSettingsMegapool\", rocketDAOProtocolSettingsMegapool, abis[15]);\n        _addContract(\"rocketDAOSecurityUpgrade\", rocketDAOSecurityUpgrade, abis[17]);\n\n        // Upgrade existing contracts\n        _upgradeContract(\"rocketNodeManager\", rocketNodeManager, abis[4]);\n        _upgradeContract(\"rocketNodeDeposit\", rocketNodeDeposit, abis[5]);\n        _upgradeContract(\"rocketNodeStaking\", rocketNodeStaking, abis[6]);\n        _upgradeContract(\"rocketNetworkBalances\", rocketNetworkBalances, abis[21]);\n        _upgradeContract(\"rocketNetworkPenalties\", rocketNetworkPenalties, abis[23]);\n        _upgradeContract(\"rocketDepositPool\", rocketDepositPool, abis[7]);\n        _upgradeContract(\"rocketNetworkSnapshots\", rocketNetworkSnapshots, abis[22]);\n        _upgradeContract(\"rocketDAOProtocol\", rocketDAOProtocol, abis[9]);\n        _upgradeContract(\"rocketDAOProtocolProposals\", rocketDAOProtocolProposals, abis[10]);\n        _upgradeContract(\"rocketDAOProtocolSettingsNode\", rocketDAOProtocolSettingsNode, abis[11]);\n        _upgradeContract(\"rocketDAOProtocolSettingsDeposit\", rocketDAOProtocolSettingsDeposit, abis[12]);\n        _upgradeContract(\"rocketDAOProtocolSettingsNetwork\", rocketDAOProtocolSettingsNetwork, abis[13]);\n        _upgradeContract(\"rocketDAOProtocolSettingsSecurity\", rocketDAOProtocolSettingsSecurity, abis[14]);\n        _upgradeContract(\"rocketDAOProtocolSettingsMinipool\", rocketDAOProtocolSettingsMinipool, abis[16]);\n        _upgradeContract(\"rocketDAONodeTrustedUpgrade\", rocketDAONodeTrustedUpgrade, abis[19]);\n        _upgradeContract(\"rocketDAOSecurityProposals\", rocketDAOSecurityProposals, abis[18]);\n        _upgradeContract(\"rocketNodeDistributorDelegate\", rocketNodeDistributorDelegate, abis[27]);\n        _upgradeContract(\"rocketRewardsPool\", rocketRewardsPool, abis[24]);\n        _upgradeContract(\"rocketClaimDAO\", rocketClaimDAO, abis[28]);\n        _upgradeContract(\"rocketMinipoolBondReducer\", rocketMinipoolBonderReducer, abis[29]);\n        _upgradeContract(\"rocketNetworkVoting\", rocketNetworkVoting, abis[30]);\n        _upgradeContract(\"rocketMerkleDistributorMainnet\", rocketMerkleDistributorMainnet, abis[31]);\n\n        // Initialise the rewards relay address\n        InitialiseInterface(rocketMerkleDistributorMainnet).initialise();\n\n        // Initialise the megapool factory\n        InitialiseInterface(rocketMegapoolFactory).initialise();\n\n        // Initialise the new megapool settings contract\n        InitialiseInterface(rocketDAOProtocolSettingsMegapool).initialise();\n\n        // Add new security council allowed parameter\n        setBool(keccak256(abi.encodePacked(\"dao.security.allowed.setting\", \"network\", \"network.node.commission.share.security.council.adder\")), true);\n\n        // Deposit settings\n        {\n            bytes32 settingNameSpace = keccak256(abi.encodePacked(\"dao.protocol.setting.\", \"deposit\"));\n            // Set socialised assignments to 0 per RPIP-59\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"deposit.assign.socialised.maximum\")), 0);\n            // Set default express queue settings per RPIP-59\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"express.queue.rate\")), 2);\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"express.queue.tickets.base.provision\")), 2);\n        }\n\n        // Network settings\n        {\n            bytes32 settingNameSpace = keccak256(abi.encodePacked(\"dao.protocol.setting.\", \"network\"));\n            // Initialise UARS setting defaults per RPIP-46\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"network.node.commission.share\")), 0.05 ether);                        // 5% (RPIP-46)\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"network.node.commission.share.security.council.adder\")), 0 ether);    // 0% (RPIP-46)\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"network.voter.share\")), 0.09 ether);                                  // 9% (RPIP-46)\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"network.pdao.share\")), 0 ether);                                      // 0% (RPIP-72)\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"network.max.node.commission.share.council.adder\")), 0.01 ether);      // 1% (RPIP-46)\n            // Initialise max rETH delta per RPIP-61\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"network.max.reth.balance.delta\")), 0.02 ether);                       // 2% (RPIP-61)\n        }\n\n        // Node settings\n        {\n            bytes32 settingNameSpace = keccak256(abi.encodePacked(\"dao.protocol.setting.\", \"node\"));\n            // Initialised reduced_bond and unstaking_period setting per RPIP-42 and RPIP-30\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"reduced.bond\")), 4 ether);                    // 4 ether (RPIP-42)\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"node.unstaking.period\")), 28 days);           // 28 days (RPIP-30)\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"node.megapool.minimum.stake\")), 0.15 ether);  // 15% (RPIP-30)\n        }\n\n        // Minipool settings\n        {\n            bytes32 settingNameSpace = keccak256(abi.encodePacked(\"dao.protocol.setting.\", \"minipool\"));\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"minipool.maximum.penalty.count\")), 2500);     // 2,500 penalties (RPIP-58)\n        }\n\n        // Security settings\n        {\n            bytes32 settingNameSpace = keccak256(abi.encodePacked(\"dao.protocol.setting.\", \"security\"));\n            // Set protocol upgrade settings per RPIP-60\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"upgrade.delay\")), 7 days);\n            setUint(keccak256(abi.encodePacked(settingNameSpace, \"upgradeveto.quorum\")), 0.33 ether);\n        }\n\n        // Initialise UARS system\n        RocketNetworkRevenuesInterface rocketNetworkRevenuesInstance = RocketNetworkRevenuesInterface(rocketNetworkRevenues);\n        rocketNetworkRevenuesInstance.initialise(0.05 ether, 0.09 ether, 0); // 5% node share, 9% voter share, 0% pdao share (RPIP-46)\n\n        // Set a protocol version value in storage for convenience with bindings\n        setString(keccak256(abi.encodePacked(\"protocol.version\")), \"1.4\");\n    }\n\n    /// @dev Upgrade a network contract\n    function _upgradeContract(string memory _name, address _contractAddress, string memory _contractAbi) internal {\n        // Get old contract address & check contract exists\n        address oldContractAddress = getAddress(keccak256(abi.encodePacked(\"contract.address\", _name)));\n        require(oldContractAddress != address(0x0));\n        // Check new contract address\n        require(_contractAddress != address(0x0));\n        require(_contractAddress != oldContractAddress);\n        require(!getBool(keccak256(abi.encodePacked(\"contract.exists\", _contractAddress))));\n        // Check ABI isn't empty\n        require(bytes(_contractAbi).length > 0);\n        // Register new contract\n        setBool(keccak256(abi.encodePacked(\"contract.exists\", _contractAddress)), true);\n        setString(keccak256(abi.encodePacked(\"contract.name\", _contractAddress)), _name);\n        setAddress(keccak256(abi.encodePacked(\"contract.address\", _name)), _contractAddress);\n        setString(keccak256(abi.encodePacked(\"contract.abi\", _name)), _contractAbi);\n        // Deregister old contract\n        deleteString(keccak256(abi.encodePacked(\"contract.name\", oldContractAddress)));\n        deleteBool(keccak256(abi.encodePacked(\"contract.exists\", oldContractAddress)));\n    }\n\n    /// @dev Add a new network contract\n    function _addContract(string memory _name, address _contractAddress, string memory _contractAbi) internal {\n        // Check contract name\n        require(bytes(_name).length > 0);\n        // Cannot add contract if it already exists (use upgradeContract instead)\n        require(getAddress(keccak256(abi.encodePacked(\"contract.address\", _name))) == address(0x0));\n        // Cannot add contract if already in use as ABI only\n        string memory existingAbi = getString(keccak256(abi.encodePacked(\"contract.abi\", _name)));\n        require(bytes(existingAbi).length == 0);\n        // Check contract address\n        require(_contractAddress != address(0x0));\n        require(!getBool(keccak256(abi.encodePacked(\"contract.exists\", _contractAddress))));\n        // Check ABI isn't empty\n        require(bytes(_contractAbi).length > 0);\n        // Register contract\n        setBool(keccak256(abi.encodePacked(\"contract.exists\", _contractAddress)), true);\n        setString(keccak256(abi.encodePacked(\"contract.name\", _contractAddress)), _name);\n        setAddress(keccak256(abi.encodePacked(\"contract.address\", _name)), _contractAddress);\n        setString(keccak256(abi.encodePacked(\"contract.abi\", _name)), _contractAbi);\n    }\n}\n"
    }
}