{
    "vfp_id": "vfp_00053",
    "project_name": "cantina_liminal_oct2025.pdf",
    "findings": [
        {
            "id": 4,
            "category": {
                "1": [
                    "CWE-693"
                ]
            },
            "title": "Privileged Role Can Arbitrarily Set NAV and Drain Instant Redeemable Funds Due to Circumventable & Missing Safeguards",
            "description": "The NAVOracle contract allows the VALUATION_MANAGER_ROLE to call setTotalAssets and directly overwrite the Net Asset Value (NAV). While a maxPercentageIncrease check exists, it can be bypassed via sequential calls in the same block or by setting NAV to zero first (which skips the check), then inflating it.\nThe root cause is the lack of downside protection (maxPercentageDecrease) and intra-block cooldown mechanisms, making the safeguard easily circumventable.\nAn attacker could set NAV to near-zero, deposit a small amount to mint nearly all shares, then reset NAV to steal all assets. Alternatively, they could inflate NAV before redeeming to extract excessive assets.\nThe impact includes total loss of funds for depositors and redemption holders, enabling complete vault draining by a privileged role.\n",
            "severity": "Medium",
            "location": [
                "NAVOracle.sol#L182-L205"
            ],
            "files": [
                "55346a53cccfbaa5ef9d3ec8e73a1ab2e40a9aae/liminal-contracts/src/NAVOracle.sol"
            ]
        }
    ],
    "affected_files": {
        "NAVOracle.sol": "// SPDX-License-Identifier: BUSL-1.1\n// Terms: https://liminal.money/xtokens/license\n\npragma solidity 0.8.28;\n\nimport {AccessControlUpgradeable} from \"@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol\";\nimport {Math} from \"@openzeppelin/contracts/utils/math/Math.sol\";\nimport {IERC20Metadata} from \"@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol\";\n\ncontract NAVOracle is AccessControlUpgradeable {\n    using Math for uint256;\n\n    bytes32 public constant VALUATION_MANAGER_ROLE = keccak256(\"VALUATION_MANAGER_ROLE\");\n\n    bytes32 public constant VAULT_ROLE = keccak256(\"VAULT_ROLE\");\n\n    struct NAVOracleStorage {\n        uint256 currentTotalAssets;\n        uint256 lastUpdateTime;\n        uint256 maxPercentageIncrease;\n        uint256 maxPercentageDecrease;\n        IERC20Metadata underlyingAsset;\n        address timeLockController;\n        uint256 lastSetTotalAssetsBlock;\n    }\n\n    bytes32 private constant NAV_ORACLE_STORAGE_LOCATION =\n        0x530b86cfd76ace1cbd39c58faa3d0b7c3932db3408b4deb9aecf4ab72aef1d00;\n\n    function _getNAVOracleStorage() private pure returns (NAVOracleStorage storage $) {\n        assembly {\n            $.slot := NAV_ORACLE_STORAGE_LOCATION\n        }\n    }\n\n    event NAVUpdated(uint256 newNAV, uint256 timestamp);\n    event NAVUpdatedVault(uint256 newNAV, uint256 timestamp);\n    event NAVIncreased(uint256 amount, uint256 newNAV, uint256 timestamp);\n    event NAVDecreased(uint256 amount, uint256 newNAV, uint256 timestamp);\n    event MaxPercentageIncreaseUpdated(uint256 oldValue, uint256 newValue);\n    event MaxPercentageDecreaseUpdated(uint256 oldValue, uint256 newValue);\n    event TimelockControllerSet(address indexed oldTimelock, address indexed newTimelock);\n    event UnderlyingAssetUpdated(address indexed oldAsset, address indexed newAsset);\n\n    error NAVIncreaseExceedsLimit(uint256 currentNAV, uint256 newNAV, uint256 maxAllowed);\n    error NAVDecreaseExceedsLimit(uint256 currentNAV, uint256 newNAV, uint256 maxAllowed);\n    error InvalidPercentage(uint256 percentage);\n    error IntraBlockCooldownActive(uint256 lastBlock, uint256 currentBlock);\n\n    modifier onlyTimelock() {\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        require(msg.sender == $.timeLockController, \"NAVOracle: only timelock\");\n        _;\n    }\n\n    constructor() {\n        _disableInitializers();\n    }\n\n    function initialize(\n        address _deployer,\n        address _valuationManager,\n        uint256 _initialNAV,\n        uint256 _maxPercentageIncrease,\n        uint256 _maxPercentageDecrease,\n        address _underlyingAsset,\n        address _timeLockController\n    ) external initializer {\n        require(_deployer != address(0), \"NAVOracle: zero deployer\");\n        require(_valuationManager != address(0), \"NAVOracle: zero address\");\n        require(_underlyingAsset != address(0), \"NAVOracle: zero address\");\n        require(_timeLockController != address(0), \"NAVOracle: zero timelock\");\n        if (_maxPercentageIncrease == 0 || _maxPercentageIncrease > 10_000) {\n            revert InvalidPercentage(_maxPercentageIncrease);\n        }\n        if (_maxPercentageDecrease == 0 || _maxPercentageDecrease > 10_000) {\n            revert InvalidPercentage(_maxPercentageDecrease);\n        }\n\n        __AccessControl_init();\n\n        _grantRole(DEFAULT_ADMIN_ROLE, _deployer);\n        _grantRole(VALUATION_MANAGER_ROLE, _valuationManager);\n\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        $.currentTotalAssets = _initialNAV;\n        $.maxPercentageIncrease = _maxPercentageIncrease;\n        $.maxPercentageDecrease = _maxPercentageDecrease;\n        $.underlyingAsset = IERC20Metadata(_underlyingAsset);\n        $.timeLockController = _timeLockController;\n        $.lastUpdateTime = block.timestamp;\n        emit NAVUpdated(_initialNAV, block.timestamp);\n    }\n\n    function setMaxPercentageIncrease(uint16 _newMaxPercentage) external onlyTimelock {\n        if (_newMaxPercentage == 0 || _newMaxPercentage > 10_000) {\n            revert InvalidPercentage(_newMaxPercentage);\n        }\n\n        uint256 oldValue = _getNAVOracleStorage().maxPercentageIncrease;\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        $.maxPercentageIncrease = _newMaxPercentage;\n        emit MaxPercentageIncreaseUpdated(oldValue, _newMaxPercentage);\n    }\n\n    function setMaxPercentageDecrease(uint256 _newMaxPercentage) external onlyTimelock {\n        if (_newMaxPercentage == 0 || _newMaxPercentage > 10_000) {\n            revert InvalidPercentage(_newMaxPercentage);\n        }\n\n        uint256 oldValue = _getNAVOracleStorage().maxPercentageDecrease;\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        $.maxPercentageDecrease = _newMaxPercentage;\n        emit MaxPercentageDecreaseUpdated(oldValue, _newMaxPercentage);\n    }\n\n    function _normalizeToDecimals18(uint256 amount) private view returns (uint256) {\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        uint8 underlyingDecimals = $.underlyingAsset.decimals();\n        if (underlyingDecimals < 18) {\n            return amount * (10 ** (18 - underlyingDecimals));\n        }\n        return amount;\n    }\n\n    function increaseTotalAssets(uint256 amount) external onlyRole(VAULT_ROLE) {\n        require(amount > 0, \"NAVOracle: zero amount\");\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n\n        uint256 normalizedAmount = _normalizeToDecimals18(amount);\n\n        $.currentTotalAssets += normalizedAmount;\n        $.lastUpdateTime = block.timestamp;\n        emit NAVIncreased(normalizedAmount, $.currentTotalAssets, block.timestamp);\n    }\n\n    function decreaseTotalAssets(uint256 amount) external onlyRole(VAULT_ROLE) {\n        require(amount > 0, \"NAVOracle: zero amount\");\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n\n        uint256 normalizedAmount = _normalizeToDecimals18(amount);\n\n        require($.currentTotalAssets >= normalizedAmount, \"NAVOracle: insufficient NAV\");\n        $.currentTotalAssets -= normalizedAmount;\n        $.lastUpdateTime = block.timestamp;\n        emit NAVDecreased(normalizedAmount, $.currentTotalAssets, block.timestamp);\n    }\n\n    function setTotalAssets(uint256 newTotalAssets, uint256 expectedNav) external onlyRole(VALUATION_MANAGER_ROLE) {\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n\n        if ($.lastSetTotalAssetsBlock == block.number) {\n            revert IntraBlockCooldownActive($.lastSetTotalAssetsBlock, block.number);\n        }\n\n        uint256 currentNAV = $.currentTotalAssets;\n        require(currentNAV == expectedNav, \"NAVOracle: expected NAV mismatch\");\n\n        if (newTotalAssets > currentNAV && currentNAV > 0) {\n            uint256 maxAllowed = currentNAV + currentNAV.mulDiv($.maxPercentageIncrease, 10_000);\n\n            if (newTotalAssets > maxAllowed) {\n                revert NAVIncreaseExceedsLimit(currentNAV, newTotalAssets, maxAllowed);\n            }\n        }\n\n        if (newTotalAssets < currentNAV && currentNAV > 0) {\n            uint256 maxAllowed = currentNAV - currentNAV.mulDiv($.maxPercentageDecrease, 10_000);\n\n            if (newTotalAssets < maxAllowed) {\n                revert NAVDecreaseExceedsLimit(currentNAV, newTotalAssets, maxAllowed);\n            }\n        }\n\n        $.currentTotalAssets = newTotalAssets;\n        $.lastUpdateTime = block.timestamp;\n        $.lastSetTotalAssetsBlock = block.number;\n        emit NAVUpdated(newTotalAssets, block.timestamp);\n    }\n\n    function setUnderlyingAsset(address _newUnderlyingAsset) external onlyTimelock {\n        require(_newUnderlyingAsset != address(0), \"NAVOracle: zero address\");\n\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        address oldAsset = address($.underlyingAsset);\n        require(oldAsset != _newUnderlyingAsset, \"NAVOracle: same asset\");\n\n        $.underlyingAsset = IERC20Metadata(_newUnderlyingAsset);\n\n        emit UnderlyingAssetUpdated(oldAsset, _newUnderlyingAsset);\n    }\n\n    function setTimelockController(address _timeLockController) external onlyTimelock {\n        require(_timeLockController != address(0), \"NAVOracle: zero timelock\");\n\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        address oldTimelock = $.timeLockController;\n        $.timeLockController = _timeLockController;\n\n        emit TimelockControllerSet(oldTimelock, _timeLockController);\n    }\n\n    function getNAV() external view returns (uint256) {\n        return _getNAVOracleStorage().currentTotalAssets;\n    }\n\n    function getMaxAllowedNAV() external view returns (uint256) {\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        return $.currentTotalAssets + $.currentTotalAssets.mulDiv($.maxPercentageIncrease, 10_000);\n    }\n\n    function getMinAllowedNAV() external view returns (uint256) {\n        NAVOracleStorage storage $ = _getNAVOracleStorage();\n        return $.currentTotalAssets - $.currentTotalAssets.mulDiv($.maxPercentageDecrease, 10_000);\n    }\n\n    function maxPercentageIncrease() external view returns (uint256) {\n        return _getNAVOracleStorage().maxPercentageIncrease;\n    }\n\n    function maxPercentageDecrease() external view returns (uint256) {\n        return _getNAVOracleStorage().maxPercentageDecrease;\n    }\n\n    function lastUpdateTime() external view returns (uint256) {\n        return _getNAVOracleStorage().lastUpdateTime;\n    }\n\n    function getUnderlyingAsset() external view returns (address) {\n        return address(_getNAVOracleStorage().underlyingAsset);\n    }\n\n    function timeLockController() external view returns (address) {\n        return _getNAVOracleStorage().timeLockController;\n    }\n\n    function lastSetTotalAssetsBlock() external view returns (uint256) {\n        return _getNAVOracleStorage().lastSetTotalAssetsBlock;\n    }\n}\n"
    }
}