{
    "vfp_id": "vfp_00196",
    "project_name": "cantina_sky_grove_alm_controller_july2025.pdf",
    "findings": [
        {
            "id": 1,
            "category": {
                "1": [
                    "CWE-664"
                ],
                "2": [
                    "CWE-665"
                ],
                "3": [
                    "CWE-909"
                ],
                "4": [
                    "CWE-456"
                ]
            },
            "title": "Missing initialization of centrifugeRecipients in deployment scripts",
            "description": "1. **Description:** The initialization scripts set mintRecipients for CCTP and layerZeroRecipients for LayerZero bridges but fail to initialize centrifugeRecipients for similar functionality.\n\n2. **Cause:** The deployment scripts omit a call to setCentrifugeRecipient after setting other recipient types, creating an inconsistent state.\n\n3. **Exploitation:** If the system relies on centrifugeRecipients for message routing or access control, the uninitialized state could block legitimate operations or allow unauthorized behavior.\n\n4. **Impact:** This could lead to a denial of service for Centrifuge-related functionality or inconsistent behavior across bridge mechanisms. The impact depends on whether centrifugeRecipients are enforced in the logic.\n",
            "severity": "Medium",
            "location": [
                "ForeignControllerInit"
            ],
            "files": [
                "grove-alm-controller/deploy/ForeignControllerInit.sol"
            ]
        }
    ],
    "affected_files": {
        "ForeignControllerInit.sol": "// SPDX-License-Identifier: AGPL-3.0-or-later\npragma solidity >=0.8.0;\n\nimport { ForeignController } from \"../src/ForeignController.sol\";\n\nimport { IALMProxy }   from \"../src/interfaces/IALMProxy.sol\";\nimport { IRateLimits } from \"../src/interfaces/IRateLimits.sol\";\n\nimport { ControllerInstance } from \"./ControllerInstance.sol\";\n\ninterface IPSM3Like {\n    function susds() external view returns (address);\n    function totalAssets() external view returns (uint256);\n    function totalShares() external view returns (uint256);\n    function usdc() external view returns (address);\n    function usds() external view returns (address);\n}\n\nlibrary ForeignControllerInit {\n\n    /**********************************************************************************************/\n    /*** Structs and constants                                                                  ***/\n    /**********************************************************************************************/\n\n    struct CheckAddressParams {\n        address admin;\n        address psm;\n        address cctp;\n        address usdc;\n        // address susds;\n        // address usds;\n    }\n\n    struct ConfigAddressParams {\n        address   freezer;\n        address[] relayers;\n        address   oldController;\n    }\n\n    struct MintRecipient {\n        uint32  domain;\n        bytes32 mintRecipient;\n    }\n\n    struct LayerZeroRecipient {\n        uint32  destinationEndpointId;\n        bytes32 recipient;\n    }\n\n    struct CentrifugeRecipient {\n        uint16  destinationCentrifugeId;\n        bytes32 recipient;\n    }\n\n    bytes32 constant DEFAULT_ADMIN_ROLE = 0x00;\n\n    /**********************************************************************************************/\n    /*** Internal library functions                                                             ***/\n    /**********************************************************************************************/\n\n    function initAlmSystem(\n        ControllerInstance    memory controllerInst,\n        ConfigAddressParams   memory configAddresses,\n        CheckAddressParams    memory checkAddresses,\n        MintRecipient[]       memory mintRecipients,\n        LayerZeroRecipient[]  memory layerZeroRecipients,\n        CentrifugeRecipient[] memory centrifugeRecipients\n    )\n        internal\n    {\n        // Step 1: Do sanity checks outside of the controller\n\n        require(IALMProxy(controllerInst.almProxy).hasRole(DEFAULT_ADMIN_ROLE, checkAddresses.admin),     \"ForeignControllerInit/incorrect-admin-almProxy\");\n        require(IRateLimits(controllerInst.rateLimits).hasRole(DEFAULT_ADMIN_ROLE, checkAddresses.admin), \"ForeignControllerInit/incorrect-admin-rateLimits\");\n\n        // Step 2: Initialize the controller\n\n        _initController(controllerInst, configAddresses, checkAddresses, mintRecipients, layerZeroRecipients, centrifugeRecipients);\n    }\n\n    function upgradeController(\n        ControllerInstance    memory controllerInst,\n        ConfigAddressParams   memory configAddresses,\n        CheckAddressParams    memory checkAddresses,\n        MintRecipient[]       memory mintRecipients,\n        LayerZeroRecipient[]  memory layerZeroRecipients,\n        CentrifugeRecipient[] memory centrifugeRecipients\n    )\n        internal\n    {\n        _initController(controllerInst, configAddresses, checkAddresses, mintRecipients, layerZeroRecipients, centrifugeRecipients);\n\n        IALMProxy   almProxy   = IALMProxy(controllerInst.almProxy);\n        IRateLimits rateLimits = IRateLimits(controllerInst.rateLimits);\n\n        require(configAddresses.oldController != address(0), \"ForeignControllerInit/old-controller-zero-address\");\n\n        require(almProxy.hasRole(almProxy.CONTROLLER(), configAddresses.oldController),     \"ForeignControllerInit/old-controller-not-almProxy-controller\");\n        require(rateLimits.hasRole(rateLimits.CONTROLLER(), configAddresses.oldController), \"ForeignControllerInit/old-controller-not-rateLimits-controller\");\n\n        almProxy.revokeRole(almProxy.CONTROLLER(), configAddresses.oldController);\n        rateLimits.revokeRole(rateLimits.CONTROLLER(), configAddresses.oldController);\n    }\n\n    /**********************************************************************************************/\n    /*** Private helper functions                                                               ***/\n    /**********************************************************************************************/\n\n    function _initController(\n        ControllerInstance    memory controllerInst,\n        ConfigAddressParams   memory configAddresses,\n        CheckAddressParams    memory checkAddresses,\n        MintRecipient[]       memory mintRecipients,\n        LayerZeroRecipient[]  memory layerZeroRecipients,\n        CentrifugeRecipient[] memory centrifugeRecipients\n    )\n        private\n    {\n        // Step 1: Perform controller sanity checks\n\n        ForeignController newController = ForeignController(controllerInst.controller);\n\n        require(newController.hasRole(DEFAULT_ADMIN_ROLE, checkAddresses.admin), \"ForeignControllerInit/incorrect-admin-controller\");\n\n        require(address(newController.proxy())      == controllerInst.almProxy,   \"ForeignControllerInit/incorrect-almProxy\");\n        require(address(newController.rateLimits()) == controllerInst.rateLimits, \"ForeignControllerInit/incorrect-rateLimits\");\n\n        require(address(newController.psm())  == checkAddresses.psm,  \"ForeignControllerInit/incorrect-psm\");\n        require(address(newController.usdc()) == checkAddresses.usdc, \"ForeignControllerInit/incorrect-usdc\");\n        require(address(newController.cctp()) == checkAddresses.cctp, \"ForeignControllerInit/incorrect-cctp\");\n\n        require(configAddresses.oldController != address(newController), \"ForeignControllerInit/old-controller-is-new-controller\");\n\n        // Step 2: Perform PSM sanity checks\n\n        // IPSM3Like psm = IPSM3Like(checkAddresses.psm);\n\n        // require(psm.totalAssets() >= 1e18, \"ForeignControllerInit/psm-totalAssets-not-seeded\");\n        // require(psm.totalShares() >= 1e18, \"ForeignControllerInit/psm-totalShares-not-seeded\");\n\n        // require(psm.usdc()  == checkAddresses.usdc,  \"ForeignControllerInit/psm-incorrect-usdc\");\n        // require(psm.usds()  == checkAddresses.usds,  \"ForeignControllerInit/psm-incorrect-usds\");\n        // require(psm.susds() == checkAddresses.susds, \"ForeignControllerInit/psm-incorrect-susds\");\n\n        // Step 3: Configure ACL permissions controller, almProxy, and rateLimits\n\n        IALMProxy   almProxy   = IALMProxy(controllerInst.almProxy);\n        IRateLimits rateLimits = IRateLimits(controllerInst.rateLimits);\n\n        almProxy.grantRole(almProxy.CONTROLLER(),        address(newController));\n        newController.grantRole(newController.FREEZER(), configAddresses.freezer);\n        rateLimits.grantRole(rateLimits.CONTROLLER(),    address(newController));\n\n        for (uint256 i; i < configAddresses.relayers.length; ++i) {\n            newController.grantRole(newController.RELAYER(), configAddresses.relayers[i]);\n        }\n\n        // Step 4: Configure the mint recipients on other domains\n\n        for (uint256 i; i < mintRecipients.length; ++i) {\n            newController.setMintRecipient(mintRecipients[i].domain, mintRecipients[i].mintRecipient);\n        }\n\n        // Step 5: Configure LayerZero recipients\n\n        for (uint256 i; i < layerZeroRecipients.length; ++i) {\n            newController.setLayerZeroRecipient(layerZeroRecipients[i].destinationEndpointId, layerZeroRecipients[i].recipient);\n        }\n\n        // Step 6: Configure the centrifuge recipients\n\n        for (uint256 i; i < centrifugeRecipients.length; ++i) {\n            newController.setCentrifugeRecipient(centrifugeRecipients[i].destinationCentrifugeId, centrifugeRecipients[i].recipient);\n        }\n    }\n\n}\n"
    }
}