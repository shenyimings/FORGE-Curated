{
    "vfp_id": "vfp_00183",
    "project_name": "Uniswap Hooks Library Milestone 1 Audit.md",
    "findings": [
        {
            "id": 6,
            "category": {
                "1": [
                    "CWE-691"
                ],
                "2": [
                    "CWE-841"
                ]
            },
            "title": "BaseAsyncSwap Operation Is Unclear",
            "description": "The BaseAsyncSwap hook skips normal swap logic for exact-input swaps by minting ERC-6909 claim tokens to itself, but it does not specify how these tokens should be handled. There is no mechanism to track which user or pool the tokens belong to, nor any logic for distributing or refunding them.\n\nThe root cause is incomplete design and lack of required override guidance. The hook receives tokens from multiple pools but does not separate accounting by user or pool. Additionally, it does not handle exact-output swaps, allowing users to bypass the hook entirely.\n\nThis can be exploited by users who perform exact-output swaps to avoid the hook's logic. The impact includes undefined behavior, potential loss of user funds, and integration difficulties due to unclear responsibilities for inheriting contracts. The lack of user tracking prevents proper accounting and redemption.\n",
            "severity": "Medium",
            "location": [
                "BaseNoOp.sol::BaseAsyncSwap#27",
                "BaseNoOp.sol#54"
            ],
            "files": [
                "uniswap-hooks/src/base/BaseAsyncSwap.sol"
            ]
        }
    ],
    "affected_files": {
        "BaseAsyncSwap.sol": "// SPDX-License-Identifier: MIT\n// OpenZeppelin Uniswap Hooks (last updated v0.1.0) (src/base/BaseAsyncSwap.sol)\n\npragma solidity ^0.8.24;\n\nimport {BaseHook} from \"src/base/BaseHook.sol\";\nimport {Hooks} from \"v4-core/src/libraries/Hooks.sol\";\nimport {PoolKey} from \"v4-core/src/types/PoolKey.sol\";\nimport {IPoolManager} from \"v4-core/src/interfaces/IPoolManager.sol\";\nimport {BeforeSwapDelta, BeforeSwapDeltaLibrary, toBeforeSwapDelta} from \"v4-core/src/types/BeforeSwapDelta.sol\";\nimport {Currency} from \"v4-core/src/types/Currency.sol\";\nimport {SafeCast} from \"v4-core/src/libraries/SafeCast.sol\";\nimport {CurrencySettler} from \"src/utils/CurrencySettler.sol\";\n\n/**\n * @dev Base implementation for async swaps, which skip the v3-like swap implementation of the `PoolManager`\n * by taking the full swap input amount and returning a delta that nets out the specified amount to 0.\n *\n * This base hook allows developers to implement arbitrary logic to handle swaps, including use-cases like\n * asynchronous swaps and custom swap-ordering. However, given this flexibility, developers should ensure\n * that any logic implemented interacts safely with the `PoolManager` and works correctly.\n *\n * In order to handle async swaps, the hook mints ERC-6909 claim tokens for the specified currency and amount.\n * Inheriting contracts are free to handle these claim tokens as necessary, which can be redeemed for the\n * underlying currency by using the `settle` function from the `CurrencySettler` library.\n *\n * IMPORTANT: If the hook is used for multiple pools, the ERC-6909 tokens must be separated and managed\n * independently for each pool in order to prevent draining of ERC-6909 tokens from one pool to another.\n *\n * NOTE: The hook only supports async exact-input swaps. Exact-output swaps will be processed normally\n * by the `PoolManager`.\n *\n * WARNING: This is experimental software and is provided on an \"as is\" and \"as available\" basis. We do\n * not give any warranties and will not be liable for any losses incurred through any use of this code\n * base.\n *\n * _Available since v0.1.0_\n */\nabstract contract BaseAsyncSwap is BaseHook {\n    using SafeCast for uint256;\n    using CurrencySettler for Currency;\n\n    /**\n     * @dev Set the `PoolManager` address.\n     */\n    constructor(IPoolManager _poolManager) BaseHook(_poolManager) {}\n\n    /**\n     * @dev Skip the v3-like swap implementation of the `PoolManager` by returning a delta that nets out the\n     * specified amount to 0 to enable asynchronous swaps.\n     */\n    function _beforeSwap(address, PoolKey calldata key, IPoolManager.SwapParams calldata params, bytes calldata)\n        internal\n        virtual\n        override\n        returns (bytes4, BeforeSwapDelta, uint24)\n    {\n        // Async swaps are only possible on exact-input swaps, so exact-output swaps are executed by the `PoolManager` as normal\n        if (params.amountSpecified < 0) {\n            // Determine which currency is specified\n            Currency specified = params.zeroForOne ? key.currency0 : key.currency1;\n\n            // Get the positive specified amount\n            uint256 specifiedAmount = uint256(-params.amountSpecified);\n\n            // Mint ERC-6909 claim token for the specified currency and amount\n            specified.take(poolManager, address(this), specifiedAmount, true);\n\n            // Return delta that nets out specified amount to 0.\n            return (this.beforeSwap.selector, toBeforeSwapDelta(specifiedAmount.toInt128(), 0), 0);\n        } else {\n            return (this.beforeSwap.selector, BeforeSwapDeltaLibrary.ZERO_DELTA, 0);\n        }\n    }\n\n    /**\n     * @dev Set the hook permissions, specifically `beforeSwap` and `beforeSwapReturnDelta`.\n     *\n     * @return permissions The hook permissions.\n     */\n    function getHookPermissions() public pure virtual override returns (Hooks.Permissions memory permissions) {\n        return Hooks.Permissions({\n            beforeInitialize: false,\n            afterInitialize: false,\n            beforeAddLiquidity: false,\n            beforeRemoveLiquidity: false,\n            afterAddLiquidity: false,\n            afterRemoveLiquidity: false,\n            beforeSwap: true,\n            afterSwap: false,\n            beforeDonate: false,\n            afterDonate: false,\n            beforeSwapReturnDelta: true,\n            afterSwapReturnDelta: false,\n            afterAddLiquidityReturnDelta: false,\n            afterRemoveLiquidityReturnDelta: false\n        });\n    }\n}\n"
    }
}