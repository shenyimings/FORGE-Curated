{
    "vfp_id": "vfp_00056",
    "project_name": "Likwid - Zenith Audit Report.pdf",
    "findings": [
        {
            "id": 1,
            "category": {
                "1": [
                    "CWE-682"
                ]
            },
            "title": "The implementation of setStageLeavePart is incorrect",
            "description": "The setStageLeavePart function in MarginState.sol is intended to clear a 24-bit field in a packed storage variable before inserting a new value. However, the masking operation uses incorrect constants (STAGE_SIZE and STAGE_LEAVE_PART) instead of the proper bitmask (MASK_24_BITS), resulting in failure to zero out the target bits. This leads to corrupted state storage where old bits remain, potentially altering other packed variables like StageSize. An attacker could manipulate the state by crafting inputs that exploit the bit overlap, leading to undefined behavior, incorrect protocol logic, and potential loss of funds due to miscalculated margins or fees.\n",
            "severity": "High",
            "location": [
                "MarginState.sol#L174"
            ],
            "files": [
                "likwid-margin/src/types/MarginState.sol"
            ]
        }
    ],
    "affected_files": {
        "MarginState.sol": "// SPDX-License-Identifier: MIT\npragma solidity ^0.8.0;\n\ntype MarginState is bytes32;\n\nusing MarginStateLibrary for MarginState global;\n\n/// @notice Library for getting and setting values in the MarginState type\nlibrary MarginStateLibrary {\n    uint24 internal constant MASK_24_BITS = 0xFFFFFF;\n\n    uint8 internal constant USE_MIDDLE_LEVEL_OFFSET = 24;\n    uint8 internal constant USE_HIGH_LEVEL_OFFSET = 48;\n    uint8 internal constant M_LOW_OFFSET = 72;\n    uint8 internal constant M_MIDDLE_OFFSET = 96;\n    uint8 internal constant M_HIGH_OFFSET = 120;\n    uint8 internal constant MAX_PRICE_MOVE_PER_SECOND_OFFSET = 144;\n    uint8 internal constant STAGE_DURATION = 168;\n    uint8 internal constant STAGE_SIZE = 192;\n    uint8 internal constant STAGE_LEAVE_PART = 216;\n\n    // #### GETTERS ####\n    function rateBase(MarginState _packed) internal pure returns (uint24 _rateBase) {\n        assembly (\"memory-safe\") {\n            _rateBase := and(MASK_24_BITS, _packed)\n        }\n    }\n\n    function useMiddleLevel(MarginState _packed) internal pure returns (uint24 _useMiddleLevel) {\n        assembly (\"memory-safe\") {\n            _useMiddleLevel := and(MASK_24_BITS, shr(USE_MIDDLE_LEVEL_OFFSET, _packed))\n        }\n    }\n\n    function useHighLevel(MarginState _packed) internal pure returns (uint24 _useHighLevel) {\n        assembly (\"memory-safe\") {\n            _useHighLevel := and(MASK_24_BITS, shr(USE_HIGH_LEVEL_OFFSET, _packed))\n        }\n    }\n\n    function mLow(MarginState _packed) internal pure returns (uint24 _mLow) {\n        assembly (\"memory-safe\") {\n            _mLow := and(MASK_24_BITS, shr(M_LOW_OFFSET, _packed))\n        }\n    }\n\n    function mMiddle(MarginState _packed) internal pure returns (uint24 _mMiddle) {\n        assembly (\"memory-safe\") {\n            _mMiddle := and(MASK_24_BITS, shr(M_MIDDLE_OFFSET, _packed))\n        }\n    }\n\n    function mHigh(MarginState _packed) internal pure returns (uint24 _mHigh) {\n        assembly (\"memory-safe\") {\n            _mHigh := and(MASK_24_BITS, shr(M_HIGH_OFFSET, _packed))\n        }\n    }\n\n    function maxPriceMovePerSecond(MarginState _packed) internal pure returns (uint24 _maxPriceMovePerSecond) {\n        assembly (\"memory-safe\") {\n            _maxPriceMovePerSecond := and(MASK_24_BITS, shr(MAX_PRICE_MOVE_PER_SECOND_OFFSET, _packed))\n        }\n    }\n\n    function stageDuration(MarginState _packed) internal pure returns (uint24 _stageDuration) {\n        assembly (\"memory-safe\") {\n            _stageDuration := and(MASK_24_BITS, shr(STAGE_DURATION, _packed))\n        }\n    }\n\n    function stageSize(MarginState _packed) internal pure returns (uint24 _stageSize) {\n        assembly (\"memory-safe\") {\n            _stageSize := and(MASK_24_BITS, shr(STAGE_SIZE, _packed))\n        }\n    }\n\n    function stageLeavePart(MarginState _packed) internal pure returns (uint24 _stageLeavePart) {\n        assembly (\"memory-safe\") {\n            _stageLeavePart := and(MASK_24_BITS, shr(STAGE_LEAVE_PART, _packed))\n        }\n    }\n\n    // #### SETTERS ####\n    function setRateBase(MarginState _packed, uint24 _rateBase) internal pure returns (MarginState _result) {\n        assembly (\"memory-safe\") {\n            _result := or(and(not(MASK_24_BITS), _packed), and(MASK_24_BITS, _rateBase))\n        }\n    }\n\n    function setUseMiddleLevel(MarginState _packed, uint24 _useMiddleLevel)\n        internal\n        pure\n        returns (MarginState _result)\n    {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(\n                    and(not(shl(USE_MIDDLE_LEVEL_OFFSET, MASK_24_BITS)), _packed),\n                    shl(USE_MIDDLE_LEVEL_OFFSET, and(MASK_24_BITS, _useMiddleLevel))\n                )\n        }\n    }\n\n    function setUseHighLevel(MarginState _packed, uint24 _useHighLevel) internal pure returns (MarginState _result) {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(\n                    and(not(shl(USE_HIGH_LEVEL_OFFSET, MASK_24_BITS)), _packed),\n                    shl(USE_HIGH_LEVEL_OFFSET, and(MASK_24_BITS, _useHighLevel))\n                )\n        }\n    }\n\n    function setMLow(MarginState _packed, uint24 _mLow) internal pure returns (MarginState _result) {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(and(not(shl(M_LOW_OFFSET, MASK_24_BITS)), _packed), shl(M_LOW_OFFSET, and(MASK_24_BITS, _mLow)))\n        }\n    }\n\n    function setMMiddle(MarginState _packed, uint24 _mMiddle) internal pure returns (MarginState _result) {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(and(not(shl(M_MIDDLE_OFFSET, MASK_24_BITS)), _packed), shl(M_MIDDLE_OFFSET, and(MASK_24_BITS, _mMiddle)))\n        }\n    }\n\n    function setMHigh(MarginState _packed, uint24 _mHigh) internal pure returns (MarginState _result) {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(and(not(shl(M_HIGH_OFFSET, MASK_24_BITS)), _packed), shl(M_HIGH_OFFSET, and(MASK_24_BITS, _mHigh)))\n        }\n    }\n\n    function setMaxPriceMovePerSecond(MarginState _packed, uint24 _maxPriceMovePerSecond)\n        internal\n        pure\n        returns (MarginState _result)\n    {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(\n                    and(not(shl(MAX_PRICE_MOVE_PER_SECOND_OFFSET, MASK_24_BITS)), _packed),\n                    shl(MAX_PRICE_MOVE_PER_SECOND_OFFSET, and(MASK_24_BITS, _maxPriceMovePerSecond))\n                )\n        }\n    }\n\n    function setStageDuration(MarginState _packed, uint24 _stageDuration) internal pure returns (MarginState _result) {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(\n                    and(not(shl(STAGE_DURATION, MASK_24_BITS)), _packed),\n                    shl(STAGE_DURATION, and(MASK_24_BITS, _stageDuration))\n                )\n        }\n    }\n\n    function setStageSize(MarginState _packed, uint24 _stageSize) internal pure returns (MarginState _result) {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(and(not(shl(STAGE_SIZE, MASK_24_BITS)), _packed), shl(STAGE_SIZE, and(MASK_24_BITS, _stageSize)))\n        }\n    }\n\n    function setStageLeavePart(MarginState _packed, uint24 _stageLeavePart)\n        internal\n        pure\n        returns (MarginState _result)\n    {\n        assembly (\"memory-safe\") {\n            _result :=\n                or(\n                    and(not(shl(STAGE_SIZE, STAGE_LEAVE_PART)), _packed),\n                    shl(STAGE_LEAVE_PART, and(MASK_24_BITS, _stageLeavePart))\n                )\n        }\n    }\n}\n"
    }
}