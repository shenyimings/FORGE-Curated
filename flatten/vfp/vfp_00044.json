{
    "vfp_id": "vfp_00044",
    "project_name": "ChainSecurity_MellowFinance_Multivault_Audit.pdf",
    "findings": [
        {
            "id": 8,
            "category": {
                "1": [
                    "CWE-682"
                ],
                "2": [
                    "CWE-1339"
                ]
            },
            "title": "Implicit Minimum Deposit for EigenLayer",
            "description": "Although EigenLayer does not enforce an explicit minimum deposit, it requires at least one share to be minted, creating an implicit minimum deposit threshold. This is not handled gracefully in isolated vaults. The `underlyingToSharesView` function can return 0 even for non-insignificant deposits due to its formula `(amountUnderlying * (totalShares + 1000)) / (_tokenBalance() + 1000)`, which may result in zero shares being minted when strategy yield is high. Users attempting small deposits may have their transactions silently reverted or ignored, especially when `_tokenBalance()` is large relative to `totalShares`. This could lead to users losing funds or being unable to deposit, violating the expectation of no hard deposit limits and leading to a poor user experience and potential fund loss.\n",
            "severity": "Low",
            "location": [
                "IsolatedEigenLayerVault",
                "IsolatedEigenLayerWstETHVault"
            ],
            "files": [
                "simple-lrt/test/unit/MultiVault.t.sol"
            ]
        },
        {
            "id": 6,
            "category": {
                "1": [
                    "CWE-707"
                ],
                "2": [
                    "CWE-20"
                ],
                "3": [
                    "CWE-1288"
                ]
            },
            "title": "Problems With Configurations",
            "description": "Several configuration-related issues pose risks. Removing a subvault can create arbitrage opportunities due to artificially lowered share prices. Updating an adapter may cause inconsistencies in withdrawal queue tracking, leading to loss of pending or claimable assets. Changing the default collateral without validation risks incompatibility. Additionally, missing sanity checks—such as validating addresses against factories or ensuring meaningful ratio configurations—can lead to incorrect setups. The root cause is the lack of validation and safeguards during configuration changes. While some checks are partially implemented (e.g., Symbiotic adapter validates vaults), others are missing. The impact includes potential loss of funds, operational errors, and reduced system integrity, especially during migrations or upgrades.\n",
            "severity": "Low",
            "location": [
                "MultiVault::removeSubvault",
                "MultiVault::setAdapter",
                "MultiVault::setDefaultCollateral",
                "RatioStrategy::setRatios"
            ],
            "files": [
                "simple-lrt/test/unit/MultiVault.t.sol"
            ]
        },
        {
            "id": 7,
            "category": {
                "1": [
                    "CWE-664"
                ],
                "2": [
                    "CWE-1329"
                ]
            },
            "title": "EigenLayer Not Ready to Be Integrated With Without Upgrades",
            "description": "The EigenLayer contracts were initially deployed in a non-upgradeable fashion despite ongoing development, particularly around slashing logic, which is not yet finalized. This creates a risk as future changes to EigenLayer (e.g., via PR 679) could break existing integrations. The cause is the deployment of non-upgradeable contracts in an environment where the underlying protocol (EigenLayer) is still under active development and subject to breaking changes. If the integration assumptions made during the audit are invalidated by future EigenLayer upgrades, the system may fail to operate as intended, especially since the withdrawal queue is not upgradeable. This could lead to loss of funds, particularly because critical components like the withdrawal queue cannot be upgraded to adapt to changes in EigenLayer.\n",
            "severity": "Low",
            "location": [
                "EigenLayerWithdrawalQueue",
                "EigenLayerWstETHWithdrawalQueue",
                "SymbioticWithdrawalQueue",
                "IsolatedEigenLayerVault",
                "IsolatedEigenLayerWstETHVault"
            ],
            "files": [
                "simple-lrt/test/unit/MultiVault.t.sol"
            ]
        }
    ],
    "affected_files": {
        "MultiVault.t.sol": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity 0.8.25;\n\nimport \"../BaseTest.sol\";\nimport \"../mocks/MockSymbioticFarm.sol\";\n\ncontract Unit is BaseTest {\n    using RandomLib for RandomLib.Storage;\n\n    function testConstructor() external {\n        MultiVault c = new MultiVault(\"test\", 1);\n        assertNotEq(address(c), address(0));\n    }\n\n    function testInitialize() external {\n        MultiVault c;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            c = MultiVault(address(c_));\n        }\n\n        assertEq(c.getRoleMemberCount(c.DEFAULT_ADMIN_ROLE()), 0);\n        assertEq(c.limit(), 0);\n        assertEq(c.depositPause(), false);\n        assertEq(c.withdrawalPause(), false);\n        assertEq(c.depositWhitelist(), false);\n        assertEq(c.asset(), address(0));\n        assertEq(c.name(), \"\");\n        assertEq(c.symbol(), \"\");\n        assertEq(address(c.depositStrategy()), address(0));\n        assertEq(address(c.withdrawalStrategy()), address(0));\n        assertEq(address(c.rebalanceStrategy()), address(0));\n        assertEq(address(c.defaultCollateral()), address(0));\n        assertEq(address(c.symbioticAdapter()), address(0));\n        assertEq(address(c.eigenLayerAdapter()), address(0));\n        assertEq(address(c.erc4626Adapter()), address(0));\n\n        IMultiVault.InitParams memory initParams;\n        initParams.admin = rnd.randAddress();\n        initParams.limit = rnd.randInt(100 ether);\n        initParams.depositPause = true;\n        initParams.withdrawalPause = true;\n        initParams.depositWhitelist = true;\n        initParams.asset = Constants.WSTETH();\n        initParams.name = \"MultiVault test\";\n        initParams.symbol = \"MVTEST\";\n        initParams.depositStrategy = address(1);\n        initParams.withdrawalStrategy = address(2);\n        initParams.rebalanceStrategy = address(3);\n        initParams.defaultCollateral = Constants.WSTETH_SYMBIOTIC_COLLATERAL();\n        initParams.symbioticAdapter = address(4);\n        initParams.eigenLayerAdapter = address(5);\n        initParams.erc4626Adapter = address(6);\n        c.initialize(initParams);\n\n        assertEq(c.getRoleMemberCount(c.DEFAULT_ADMIN_ROLE()), 1);\n        assertEq(c.limit(), initParams.limit);\n        assertEq(c.depositPause(), initParams.depositPause);\n        assertEq(c.withdrawalPause(), initParams.withdrawalPause);\n        assertEq(c.depositWhitelist(), initParams.depositWhitelist);\n        assertEq(c.asset(), initParams.asset);\n        assertEq(c.name(), initParams.name);\n        assertEq(c.symbol(), initParams.symbol);\n        assertEq(address(c.depositStrategy()), initParams.depositStrategy);\n        assertEq(address(c.withdrawalStrategy()), initParams.withdrawalStrategy);\n        assertEq(address(c.rebalanceStrategy()), initParams.rebalanceStrategy);\n        assertEq(address(c.defaultCollateral()), initParams.defaultCollateral);\n        assertEq(address(c.symbioticAdapter()), initParams.symbioticAdapter);\n        assertEq(address(c.eigenLayerAdapter()), initParams.eigenLayerAdapter);\n        assertEq(address(c.erc4626Adapter()), initParams.erc4626Adapter);\n    }\n\n    function testAddSubvault() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        (address symbioticSubvault,,,) =\n            symbioticHelper.createDefaultSymbioticVault(Constants.WSTETH());\n\n        vm.expectRevert();\n        vault.addSubvault(symbioticSubvault, IMultiVaultStorage.Protocol.SYMBIOTIC);\n\n        vault.grantRole(vault.ADD_SUBVAULT_ROLE(), vaultAdmin);\n        vault.addSubvault(symbioticSubvault, IMultiVaultStorage.Protocol.SYMBIOTIC);\n        assertEq(vault.subvaultsCount(), 1);\n\n        (address symbioticSubvaultWrongAsset,,,) =\n            symbioticHelper.createDefaultSymbioticVault(Constants.STETH());\n        vm.expectRevert();\n        vault.addSubvault(symbioticSubvaultWrongAsset, IMultiVaultStorage.Protocol.SYMBIOTIC);\n\n        vm.stopPrank();\n    }\n\n    function testRemoveSubvault() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        (address symbioticSubvault,,,) =\n            symbioticHelper.createDefaultSymbioticVault(Constants.WSTETH());\n\n        vm.expectRevert();\n        vault.addSubvault(symbioticSubvault, IMultiVaultStorage.Protocol.SYMBIOTIC);\n\n        vault.grantRole(vault.ADD_SUBVAULT_ROLE(), vaultAdmin);\n        vault.addSubvault(symbioticSubvault, IMultiVaultStorage.Protocol.SYMBIOTIC);\n        assertEq(vault.subvaultsCount(), 1);\n\n        (address symbioticSubvaultWrongAsset,,,) =\n            symbioticHelper.createDefaultSymbioticVault(Constants.STETH());\n        vm.expectRevert();\n        vault.addSubvault(symbioticSubvaultWrongAsset, IMultiVaultStorage.Protocol.SYMBIOTIC);\n\n        vm.expectRevert();\n        vault.removeSubvault(symbioticSubvault);\n\n        vault.grantRole(vault.REMOVE_SUBVAULT_ROLE(), vaultAdmin);\n        vault.removeSubvault(symbioticSubvault);\n        assertEq(vault.subvaultsCount(), 0);\n\n        vm.expectRevert();\n        vault.removeSubvault(symbioticSubvaultWrongAsset);\n\n        vm.stopPrank();\n    }\n\n    function testSetDepositStrategy() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        vm.expectRevert();\n        vault.setDepositStrategy(address(strategy));\n\n        assertEq(address(vault.depositStrategy()), address(strategy));\n\n        vault.grantRole(vault.SET_STRATEGY_ROLE(), vaultAdmin);\n        vault.setDepositStrategy(address(strategy));\n\n        assertEq(address(vault.depositStrategy()), address(strategy));\n\n        vault.setDepositStrategy(address(123));\n\n        assertEq(address(vault.depositStrategy()), address(123));\n\n        vm.expectRevert(\"MultiVault: deposit strategy cannot be zero address\");\n        vault.setDepositStrategy(address(0));\n\n        vm.stopPrank();\n    }\n\n    function testSetWithdrawalStrategy() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        vm.expectRevert();\n        vault.setWithdrawalStrategy(address(strategy));\n\n        assertEq(address(vault.withdrawalStrategy()), address(strategy));\n\n        vault.grantRole(vault.SET_STRATEGY_ROLE(), vaultAdmin);\n        vault.setWithdrawalStrategy(address(strategy));\n\n        assertEq(address(vault.withdrawalStrategy()), address(strategy));\n\n        vault.setWithdrawalStrategy(address(123));\n\n        assertEq(address(vault.withdrawalStrategy()), address(123));\n\n        vm.expectRevert(\"MultiVault: withdrawal strategy cannot be zero address\");\n        vault.setWithdrawalStrategy(address(0));\n\n        vm.stopPrank();\n    }\n\n    function testSetRebalanceStrategy() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        vm.expectRevert();\n        vault.setRebalanceStrategy(address(strategy));\n\n        assertEq(address(vault.rebalanceStrategy()), address(strategy));\n\n        vault.grantRole(vault.SET_STRATEGY_ROLE(), vaultAdmin);\n        vault.setRebalanceStrategy(address(strategy));\n\n        assertEq(address(vault.rebalanceStrategy()), address(strategy));\n\n        vault.setRebalanceStrategy(address(123));\n\n        assertEq(address(vault.rebalanceStrategy()), address(123));\n\n        vm.expectRevert(\"MultiVault: rebalance strategy cannot be zero address\");\n        vault.setRebalanceStrategy(address(0));\n\n        vm.stopPrank();\n    }\n\n    function testSetDefaultCollateral() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: address(0),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        address wstethDefaultCollateral = Constants.WSTETH_SYMBIOTIC_COLLATERAL();\n\n        vm.expectRevert();\n        vault.setDefaultCollateral(wstethDefaultCollateral);\n\n        assertEq(address(vault.defaultCollateral()), address(0));\n\n        vault.grantRole(vault.SET_DEFAULT_COLLATERAL_ROLE(), vaultAdmin);\n\n        vm.expectRevert(\"MultiVault: default collateral already set or cannot be zero address\");\n        vault.setDefaultCollateral(address(0));\n\n        vault.setDefaultCollateral(wstethDefaultCollateral);\n        assertEq(address(vault.defaultCollateral()), wstethDefaultCollateral);\n\n        vm.expectRevert(\"MultiVault: default collateral already set or cannot be zero address\");\n        vault.setDefaultCollateral(wstethDefaultCollateral);\n\n        vm.stopPrank();\n    }\n\n    function testSetSymbioticAdapter() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        vm.expectRevert();\n        vault.setSymbioticAdapter(address(symbioticAdapter));\n\n        assertEq(address(vault.symbioticAdapter()), address(symbioticAdapter));\n\n        vault.grantRole(vault.SET_ADAPTER_ROLE(), vaultAdmin);\n        vault.setSymbioticAdapter(address(symbioticAdapter));\n\n        assertEq(address(vault.symbioticAdapter()), address(symbioticAdapter));\n\n        vault.setSymbioticAdapter(address(123));\n\n        assertEq(address(vault.symbioticAdapter()), address(123));\n\n        vm.expectRevert(\"MultiVault: adapter cannot be zero address\");\n        vault.setSymbioticAdapter(address(0));\n\n        vm.stopPrank();\n    }\n\n    function testSetEigenLayerAdapter() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        vm.expectRevert();\n        vault.setEigenLayerAdapter(address(eigenLayerAdapter));\n\n        assertEq(address(vault.eigenLayerAdapter()), address(eigenLayerAdapter));\n\n        vault.grantRole(vault.SET_ADAPTER_ROLE(), vaultAdmin);\n        vault.setEigenLayerAdapter(address(eigenLayerAdapter));\n        assertEq(address(vault.eigenLayerAdapter()), address(eigenLayerAdapter));\n\n        vault.setEigenLayerAdapter(address(123));\n        assertEq(address(vault.eigenLayerAdapter()), address(123));\n\n        vm.expectRevert(\"MultiVault: adapter cannot be zero address\");\n        vault.setEigenLayerAdapter(address(0));\n\n        vm.stopPrank();\n    }\n\n    function testSetERC4626Adapter() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        vm.expectRevert();\n        vault.setERC4626Adapter(address(erc4626Adapter));\n\n        assertEq(address(vault.erc4626Adapter()), address(erc4626Adapter));\n\n        vault.grantRole(vault.SET_ADAPTER_ROLE(), vaultAdmin);\n        vault.setERC4626Adapter(address(erc4626Adapter));\n        assertEq(address(vault.erc4626Adapter()), address(erc4626Adapter));\n\n        vault.setERC4626Adapter(address(123));\n        assertEq(address(vault.erc4626Adapter()), address(123));\n\n        vm.expectRevert(\"MultiVault: adapter cannot be zero address\");\n        vault.setERC4626Adapter(address(0));\n\n        vm.stopPrank();\n    }\n\n    function testSetRewardsData() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        vm.startPrank(vaultAdmin);\n\n        vm.expectRevert();\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 0,\n                distributionFarm: address(2),\n                curatorTreasury: address(0),\n                protocol: IMultiVaultStorage.Protocol.SYMBIOTIC,\n                data: new bytes(0)\n            })\n        );\n\n        vault.grantRole(vault.SET_FARM_ROLE(), vaultAdmin);\n        vm.expectRevert(\"MultiVault: curator fee exceeds 100%\");\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6 + 1,\n                distributionFarm: address(0),\n                curatorTreasury: address(0),\n                protocol: IMultiVaultStorage.Protocol.SYMBIOTIC,\n                data: new bytes(0)\n            })\n        );\n\n        vm.expectRevert(\"MultiVault: distribution farm address cannot be zero\");\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(0),\n                curatorTreasury: address(0),\n                protocol: IMultiVaultStorage.Protocol.SYMBIOTIC,\n                data: new bytes(0)\n            })\n        );\n\n        vm.expectRevert(\"MultiVault: curator treasury address cannot be zero when fee is set\");\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(0),\n                protocol: IMultiVaultStorage.Protocol.SYMBIOTIC,\n                data: new bytes(0)\n            })\n        );\n\n        vm.expectRevert(\"SymbioticAdapter: invalid reward data\");\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.SYMBIOTIC,\n                data: new bytes(0)\n            })\n        );\n\n        vm.expectRevert(\"SymbioticAdapter: invalid reward data\");\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.SYMBIOTIC,\n                data: abi.encode(address(0))\n            })\n        );\n\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.SYMBIOTIC,\n                data: abi.encode(address(1))\n            })\n        );\n\n        vm.expectRevert(\"EigenLayerAdapter: invalid reward data\");\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.EIGEN_LAYER,\n                data: new bytes(0)\n            })\n        );\n\n        vm.expectRevert(\"EigenLayerAdapter: invalid reward data\");\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.EIGEN_LAYER,\n                data: abi.encode(address(0))\n            })\n        );\n\n        vm.expectRevert(\"EigenLayerAdapter: invalid reward data\");\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.EIGEN_LAYER,\n                data: abi.encode(address(1))\n            })\n        );\n\n        ISignatureUtils.SignatureWithExpiry memory signature;\n        (address isolatedVault,) = factory.getOrCreate(\n            address(vault),\n            0x7D704507b76571a51d9caE8AdDAbBFd0ba0e63d3,\n            0xbF8a8B0d0450c8812ADDf04E1BcB7BfBA0E82937,\n            abi.encode(signature, bytes32(0))\n        );\n\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.EIGEN_LAYER,\n                data: abi.encode(isolatedVault)\n            })\n        );\n\n        vm.expectRevert();\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(1),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.ERC4626,\n                data: new bytes(0)\n            })\n        );\n\n        // removal of rewards data\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: address(0),\n                curatorFeeD6: 1e6,\n                distributionFarm: address(1),\n                curatorTreasury: address(2),\n                protocol: IMultiVaultStorage.Protocol.ERC4626,\n                data: new bytes(0)\n            })\n        );\n\n        vm.stopPrank();\n    }\n\n    function testPushRewards() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        address wsteth = Constants.WSTETH();\n        address delegationManager = Constants.HOLESKY_EL_DELEGATION_MANAGER;\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        address distributionFarm = rnd.randAddress();\n        address curatorTreasury = rnd.randAddress();\n\n        vm.startPrank(vaultAdmin);\n        vault.grantRole(vault.SET_FARM_ROLE(), vaultAdmin);\n        MockSymbioticFarm mockSymbioticFarm = new MockSymbioticFarm();\n        vault.setRewardsData(\n            0,\n            IMultiVaultStorage.RewardData({\n                token: Constants.WETH(),\n                curatorFeeD6: 1e5,\n                distributionFarm: distributionFarm,\n                curatorTreasury: curatorTreasury,\n                protocol: IMultiVaultStorage.Protocol.SYMBIOTIC,\n                data: abi.encode(address(mockSymbioticFarm))\n            })\n        );\n\n        deal(Constants.WETH(), address(mockSymbioticFarm), 1 ether);\n        vm.stopPrank();\n\n        IERC20 weth = IERC20(Constants.WETH());\n        assertEq(weth.balanceOf(distributionFarm), 0, \"distribution farm balance should be zero\");\n        assertEq(weth.balanceOf(curatorTreasury), 0, \"curator treasury balance should be zero\");\n\n        vault.pushRewards(0, new bytes(0));\n\n        assertEq(\n            weth.balanceOf(distributionFarm),\n            0.9 ether,\n            \"distribution farm balance should be 90% of 1 ether\"\n        );\n        assertEq(\n            weth.balanceOf(curatorTreasury),\n            0.1 ether,\n            \"curator treasury balance should be 10% of 1 ether\"\n        );\n\n        vault.pushRewards(0, new bytes(0));\n\n        assertEq(\n            weth.balanceOf(distributionFarm),\n            0.9 ether,\n            \"distribution farm balance should not change\"\n        );\n        assertEq(\n            weth.balanceOf(curatorTreasury), 0.1 ether, \"curator treasury balance should not change\"\n        );\n\n        vm.expectRevert(\"MultiVault: farm not found\");\n        vault.pushRewards(1, new bytes(0));\n    }\n\n    function testDeposit() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        // deposit without subvaults\n\n        address user = rnd.randAddress();\n\n        vm.startPrank(user);\n\n        IERC20 wsteth = IERC20(Constants.WSTETH());\n        deal(address(wsteth), user, 1 ether);\n        wsteth.approve(address(vault), type(uint256).max);\n        vault.deposit(1 ether, user);\n        IDefaultCollateral defaultCollateral = vault.defaultCollateral();\n        assertEq(defaultCollateral.balanceOf(address(vault)), 1 ether);\n        assertEq(wsteth.balanceOf(address(vault)), 0);\n        assertEq(vault.balanceOf(user), 1 ether);\n\n        uint256 leftover = defaultCollateral.limit() - defaultCollateral.totalSupply();\n\n        deal(address(wsteth), user, 10000 ether);\n        vault.deposit(10000 ether, user);\n        assertEq(\n            defaultCollateral.balanceOf(address(vault)) + wsteth.balanceOf(address(vault)),\n            10001 ether\n        );\n        assertEq(defaultCollateral.balanceOf(address(vault)), 1 ether + leftover);\n        assertEq(wsteth.balanceOf(address(vault)), 10000 ether - leftover);\n        assertEq(vault.balanceOf(user), 10001 ether);\n\n        deal(address(wsteth), user, 1 ether);\n        vault.deposit(1 ether, user);\n        assertEq(\n            defaultCollateral.balanceOf(address(vault)) + wsteth.balanceOf(address(vault)),\n            10002 ether\n        );\n        assertEq(defaultCollateral.balanceOf(address(vault)), 1 ether + leftover);\n        assertEq(wsteth.balanceOf(address(vault)), 10001 ether - leftover);\n        assertEq(vault.balanceOf(user), 10002 ether);\n\n        vm.stopPrank();\n    }\n\n    function testWithdrawal() external {\n        MultiVault vault;\n        {\n            TransparentUpgradeableProxy c_ = new TransparentUpgradeableProxy(\n                address(new MultiVault(\"test\", 1)), vm.createWallet(\"proxyAdmin\").addr, new bytes(0)\n            );\n            vault = MultiVault(address(c_));\n        }\n        address vaultAdmin = rnd.randAddress();\n        RatiosStrategy strategy = new RatiosStrategy();\n        Claimer claimer = new Claimer();\n        SymbioticAdapter symbioticAdapter = new SymbioticAdapter(\n            address(vault),\n            Constants.symbioticDeployment().vaultFactory,\n            address(new SymbioticWithdrawalQueue(address(new Claimer()))),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        IsolatedEigenLayerVaultFactory factory = new IsolatedEigenLayerVaultFactory(\n            Constants.HOLESKY_EL_DELEGATION_MANAGER,\n            address(new IsolatedEigenLayerWstETHVault(Constants.WSTETH())),\n            address(\n                new EigenLayerWstETHWithdrawalQueue(\n                    address(claimer), Constants.HOLESKY_EL_DELEGATION_MANAGER\n                )\n            ),\n            vm.createWallet(\"proxyAdmin\").addr\n        );\n        EigenLayerAdapter eigenLayerAdapter = new EigenLayerAdapter(\n            address(factory),\n            address(vault),\n            IStrategyManager(Constants.HOLESKY_EL_STRATEGY_MANAGER),\n            IRewardsCoordinator(Constants.HOLESKY_EL_REWARDS_COORDINATOR)\n        );\n        ERC4626Adapter erc4626Adapter = new ERC4626Adapter(address(vault));\n        vault.initialize(\n            IMultiVault.InitParams({\n                admin: vaultAdmin,\n                limit: type(uint256).max,\n                depositPause: false,\n                withdrawalPause: false,\n                depositWhitelist: false,\n                asset: Constants.WSTETH(),\n                name: \"MultiVault test\",\n                symbol: \"MVT\",\n                depositStrategy: address(strategy),\n                withdrawalStrategy: address(strategy),\n                rebalanceStrategy: address(strategy),\n                defaultCollateral: Constants.WSTETH_SYMBIOTIC_COLLATERAL(),\n                symbioticAdapter: address(symbioticAdapter),\n                eigenLayerAdapter: address(eigenLayerAdapter),\n                erc4626Adapter: address(erc4626Adapter)\n            })\n        );\n\n        // deposit without subvaults\n\n        address user = rnd.randAddress();\n\n        vm.startPrank(user);\n\n        IERC20 wsteth = IERC20(Constants.WSTETH());\n        deal(address(wsteth), user, 20001 ether);\n        wsteth.approve(address(vault), type(uint256).max);\n\n        vault.deposit(1 ether, user);\n        vault.redeem(vault.balanceOf(user), user, user);\n\n        vault.deposit(10000 ether, user);\n        vault.redeem(vault.balanceOf(user), user, user);\n\n        vault.deposit(20000 ether, user);\n        address user2 = rnd.randAddress();\n        vault.approve(user2, 10000 ether);\n        vm.stopPrank();\n\n        vm.startPrank(user2);\n        vault.redeem(vault.balanceOf(user2), user2, user);\n        vm.stopPrank();\n\n        vm.startPrank(vaultAdmin);\n        vault.grantRole(vault.ADD_SUBVAULT_ROLE(), vaultAdmin);\n        vault.grantRole(vault.REBALANCE_ROLE(), vaultAdmin);\n        vault.grantRole(strategy.RATIOS_STRATEGY_SET_RATIOS_ROLE(), vaultAdmin);\n\n        (address symbioticVault,,,) =\n            symbioticHelper.createDefaultSymbioticVault(Constants.WSTETH());\n        vault.addSubvault(symbioticVault, IMultiVaultStorage.Protocol.SYMBIOTIC);\n        address[] memory subvaults = new address[](1);\n        subvaults[0] = symbioticVault;\n        IRatiosStrategy.Ratio[] memory ratios = new IRatiosStrategy.Ratio[](1);\n        ratios[0] = IRatiosStrategy.Ratio(0, 1 ether);\n        strategy.setRatios(address(vault), subvaults, ratios);\n        vault.rebalance();\n        ratios[0] = IRatiosStrategy.Ratio(0, 0.5 ether);\n        strategy.setRatios(address(vault), subvaults, ratios);\n        vault.rebalance();\n        skip(3 weeks);\n        vm.stopPrank();\n\n        vm.startPrank(user);\n        vault.redeem(vault.balanceOf(user), user, user);\n        vault.withdraw(0, user, user);\n        vault.deposit(0, user);\n        vault.deposit(0, user, user);\n        vault.mint(0, user);\n        // vault.maxDeposit(0);\n        // vault.assetsOf(0);\n        vault.totalAssets();\n\n        vm.stopPrank();\n    }\n}\n"
    }
}