{
    "vfp_id": "vfp_00504",
    "project_name": "2025.08.14 - Final - Malda Audit Report.pdf",
    "findings": [
        {
            "id": 2,
            "category": {
                "1": [
                    "CWE-682"
                ]
            },
            "title": "First depositor can brick market by forcing very large borrow rate",
            "description": "The JumpRateModelV4 calculates the borrow rate based on utilization, which is defined as borrows / (cash + borrows - reserves). However, this formula can result in utilization exceeding 1e18 when cash + borrows - reserves is less than borrows. A malicious first depositor can manipulate the market state by borrowing nearly all liquidity, letting interest accrue, repaying most of the debt, and then redeeming all shares, leaving a small borrow amount with zero cash. This results in an extremely high utilization rate, which causes the borrow rate to exceed the maximum allowed value (0.0005e16). As a result, the _accrueInterest function reverts on every call, effectively bricking the market. The root cause is the lack of a cap on utilization rate. The impact is a denial of service for all market operations, rendering the market unusable.\n",
            "severity": "Medium",
            "location": [
                "JumpRateModelV4.sol#140-150",
                "JumpRateModelV4.sol#127-135",
                "mToken.sol#36-39",
                "mTokenStorage.sol#351-356"
            ],
            "files": [
                "798d00b879b8412ca4049ba09dba5ae42464cfe7/2025-07-malda/malda-lending/src/interest/JumpRateModelV4.sol"
            ]
        }
    ],
    "affected_files": {
        "JumpRateModelV4.sol": "// Copyright (c) 2025 Merge Layers Inc.\n//\n// This source code is licensed under the Business Source License 1.1\n// (the \"License\"); you may not use this file except in compliance with the\n// License. You may obtain a copy of the License at\n//\n//     https://github.com/malda-protocol/malda-lending/blob/main/LICENSE-BSL\n//\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//\n// This file contains code derived from or inspired by Compound V2,\n// originally licensed under the BSD 3-Clause License. See LICENSE-COMPOUND-V2\n// for original license terms and attributions.\n\n// SPDX-License-Identifier: BSL-1.1\npragma solidity =0.8.28;\n\nimport {Ownable} from \"@openzeppelin/contracts/access/Ownable.sol\";\nimport {IInterestRateModel} from \"src/interfaces/IInterestRateModel.sol\";\n\n/*\n _____ _____ __    ____  _____ \n|     |  _  |  |  |    \\|  _  |\n| | | |     |  |__|  |  |     |\n|_|_|_|__|__|_____|____/|__|__|   \n*/\n\n/**\n * @title JumpRateModelV4\n * @notice Implementation of the IInterestRateModel interface for calculating interest rates\n */\ncontract JumpRateModelV4 is IInterestRateModel, Ownable {\n    // ----------- STORAGE ------------\n\n    error JumpRateModelV4_MultiplierNotValid();\n    error JumpRateModelV4_InputNotValid();\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    uint256 public override blocksPerYear;\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    uint256 public override multiplierPerBlock;\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    uint256 public override baseRatePerBlock;\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    uint256 public override jumpMultiplierPerBlock;\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    uint256 public override kink;\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    string public override name;\n\n    /**\n     * @notice Construct an interest rate model\n     * @param blocksPerYear_ The estimated number of blocks per year\n     * @param baseRatePerYear The base APR, scaled by 1e18\n     * @param multiplierPerYear The rate increase in interest wrt utilization, scaled by 1e18\n     * @param jumpMultiplierPerYear The multiplier per block after utilization point\n     * @param kink_ The utilization point where the jump multiplier applies\n     * @param owner_ The owner of the contract\n     * @param name_ A user-friendly name for the contract\n     */\n    constructor(\n        uint256 blocksPerYear_,\n        uint256 baseRatePerYear,\n        uint256 multiplierPerYear,\n        uint256 jumpMultiplierPerYear,\n        uint256 kink_,\n        address owner_,\n        string memory name_\n    ) Ownable(owner_) {\n        blocksPerYear = blocksPerYear_;\n        name = name_;\n        _updateJumpRateModel(baseRatePerYear, multiplierPerYear, jumpMultiplierPerYear, kink_);\n    }\n\n    // ----------- OWNER ------------\n\n    /**\n     * @notice Update the parameters of the interest rate model (only callable by owner, i.e. Timelock)\n     * @param baseRatePerYear The approximate target base APR, as a mantissa (scaled by 1e18)\n     * @param multiplierPerYear The rate of increase in interest rate wrt utilization (scaled by 1e18)\n     * @param jumpMultiplierPerYear The multiplierPerBlock after hitting a specified utilization point\n     * @param kink_ The utilization point at which the jump multiplier is applied\n     */\n    function updateJumpRateModel(\n        uint256 baseRatePerYear,\n        uint256 multiplierPerYear,\n        uint256 jumpMultiplierPerYear,\n        uint256 kink_\n    ) external onlyOwner {\n        _updateJumpRateModel(baseRatePerYear, multiplierPerYear, jumpMultiplierPerYear, kink_);\n    }\n\n    /**\n     * @notice Updates the blocksPerYear in order to make interest calculations simpler\n     * @param blocksPerYear_ The new estimated eth blocks per year.\n     */\n    function updateBlocksPerYear(uint256 blocksPerYear_) external onlyOwner {\n        blocksPerYear = blocksPerYear_;\n    }\n\n    // ----------- PUBLIC ------------\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    function isInterestRateModel() external pure override returns (bool) {\n        return true;\n    }\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    function utilizationRate(uint256 cash, uint256 borrows, uint256 reserves) public pure override returns (uint256) {\n        if (borrows == 0) {\n            return 0;\n        }\n        return borrows * 1e18 / (cash + borrows - reserves);\n    }\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    function getBorrowRate(uint256 cash, uint256 borrows, uint256 reserves) public view override returns (uint256) {\n        uint256 util = utilizationRate(cash, borrows, reserves);\n\n        if (util <= kink) {\n            return util * multiplierPerBlock / 1e18 + baseRatePerBlock;\n        } else {\n            uint256 normalRate = kink * multiplierPerBlock / 1e18 + baseRatePerBlock;\n            uint256 excessUtil = util - kink;\n            return excessUtil * jumpMultiplierPerBlock / 1e18 + normalRate;\n        }\n    }\n\n    /**\n     * @inheritdoc IInterestRateModel\n     */\n    function getSupplyRate(uint256 cash, uint256 borrows, uint256 reserves, uint256 reserveFactorMantissa)\n        external\n        view\n        override\n        returns (uint256)\n    {\n        uint256 oneMinusReserveFactor = 1e18 - reserveFactorMantissa;\n        uint256 borrowRate = getBorrowRate(cash, borrows, reserves);\n        uint256 rateToPool = borrowRate * oneMinusReserveFactor / 1e18;\n        return utilizationRate(cash, borrows, reserves) * rateToPool / 1e18;\n    }\n\n    // ----------- PRIVATE ------------\n    /**\n     * @notice Internal function to update the parameters of the interest rate model\n     * @param baseRatePerYear The base APR, scaled by 1e18\n     * @param multiplierPerYear The rate increase wrt utilization, scaled by 1e18\n     * @param jumpMultiplierPerYear The multiplier per block after utilization point\n     * @param kink_ The utilization point where the jump multiplier applies\n     */\n    function _updateJumpRateModel(\n        uint256 baseRatePerYear,\n        uint256 multiplierPerYear,\n        uint256 jumpMultiplierPerYear,\n        uint256 kink_\n    ) private {\n        baseRatePerBlock = baseRatePerYear / blocksPerYear;\n        multiplierPerBlock = multiplierPerYear * 1e18 / (blocksPerYear * kink_);\n        jumpMultiplierPerBlock = jumpMultiplierPerYear / blocksPerYear;\n        kink = kink_;\n\n        emit NewInterestParams(baseRatePerBlock, multiplierPerBlock, jumpMultiplierPerBlock, kink);\n    }\n}\n"
    }
}