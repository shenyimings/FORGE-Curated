{
    "vfp_id": "vfp_00533",
    "project_name": "cantina_centrifuge_aug2025.pdf",
    "findings": [
        {
            "id": 16,
            "category": {
                "1": [
                    "CWE-693"
                ],
                "2": [
                    "CWE-807"
                ]
            },
            "title": "_verifyAdmin() check isn't foolproof",
            "description": "The _verifyAdmin() function performs checks that can be bypassed by a malicious contract that implements isOwner() to always return true. The root cause is reliance on external contract behavior without additional safeguards. This could allow a fake admin contract to pass verification, leading to unauthorized access or configuration changes. The check should be strengthened with additional validation, such as verifying contract code or using a trusted registry.\n",
            "severity": null,
            "location": [
                "_verifyAdmin"
            ],
            "files": [
                "protocol-v3/script/FullDeployer.s.sol"
            ]
        }
    ],
    "affected_files": {
        "FullDeployer.s.sol": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity 0.8.28;\n\nimport {CommonInput} from \"./CommonDeployer.s.sol\";\nimport {ExtendedHubDeployer, ExtendedHubActionBatcher} from \"./ExtendedHubDeployer.s.sol\";\nimport {ExtendedSpokeDeployer, ExtendedSpokeActionBatcher} from \"./ExtendedSpokeDeployer.s.sol\";\nimport {\n    WormholeInput,\n    AxelarInput,\n    AdaptersInput,\n    AdaptersDeployer,\n    AdaptersActionBatcher\n} from \"./AdaptersDeployer.s.sol\";\n\nimport {ISafe} from \"../src/common/interfaces/IGuardian.sol\";\n\nimport \"forge-std/Script.sol\";\n\ncontract FullActionBatcher is ExtendedHubActionBatcher, ExtendedSpokeActionBatcher, AdaptersActionBatcher {}\n\n/**\n * @title FullDeployer\n * @notice Deploys the complete Centrifuge protocol stack (hub + spoke + adapters + base integrations)\n */\ncontract FullDeployer is ExtendedHubDeployer, ExtendedSpokeDeployer, AdaptersDeployer {\n    function deployFull(CommonInput memory commonInput, AdaptersInput memory adaptersInput, FullActionBatcher batcher)\n        public\n    {\n        _preDeployFull(commonInput, adaptersInput, batcher);\n        _postDeployFull(batcher);\n    }\n\n    function _preDeployFull(\n        CommonInput memory commonInput,\n        AdaptersInput memory adaptersInput,\n        FullActionBatcher batcher\n    ) internal {\n        _preDeployExtendedHub(commonInput, batcher);\n        _preDeployExtendedSpoke(commonInput, batcher);\n        _preDeployAdapters(commonInput, adaptersInput, batcher);\n    }\n\n    function _postDeployFull(FullActionBatcher batcher) internal {\n        _postDeployExtendedHub(batcher);\n        _postDeployExtendedSpoke(batcher);\n        _postDeployAdapters(batcher);\n    }\n\n    function removeFullDeployerAccess(FullActionBatcher batcher) public {\n        removeExtendedHubDeployerAccess(batcher);\n        removeExtendedSpokeDeployerAccess(batcher);\n        removeAdaptersDeployerAccess(batcher);\n    }\n\n    function run() public virtual {\n        vm.startBroadcast();\n\n        string memory network;\n        string memory config;\n        try vm.envString(\"NETWORK\") returns (string memory _network) {\n            network = _network;\n            string memory configFile = string.concat(\"env/\", network, \".json\");\n            config = vm.readFile(configFile);\n        } catch {\n            console.log(\"NETWORK environment variable is not set, this must be a mocked test\");\n            revert(\"NETWORK environment variable is required\");\n        }\n\n        uint16 centrifugeId = uint16(vm.parseJsonUint(config, \"$.network.centrifugeId\"));\n        string memory environment = vm.parseJsonString(config, \"$.network.environment\");\n\n        // Parse maxBatchGasLimit with defaults\n        uint256 maxBatchGasLimit;\n        try vm.parseJsonUint(config, \"$.network.maxBatchGasLimit\") returns (uint256 _batchGasLimit) {\n            maxBatchGasLimit = _batchGasLimit;\n        } catch {\n            maxBatchGasLimit = 25_000_000; // 25M gas\n        }\n\n        console.log(\"Network:\", network);\n        console.log(\"Environment:\", environment);\n        console.log(\"Version:\", vm.envOr(\"VERSION\", string(\"\")));\n        console.log(\"\\n\\n---------\\n\\nStarting deployment for chain ID: %s\\n\\n\", vm.toString(block.chainid));\n\n        startDeploymentOutput();\n\n        CommonInput memory commonInput = CommonInput({\n            centrifugeId: centrifugeId,\n            adminSafe: ISafe(vm.envAddress(\"ADMIN\")),\n            maxBatchGasLimit: uint128(maxBatchGasLimit),\n            version: keccak256(abi.encodePacked(vm.envOr(\"VERSION\", string(\"\"))))\n        });\n\n        AdaptersInput memory adaptersInput = AdaptersInput({\n            wormhole: WormholeInput({\n                shouldDeploy: _parseJsonBoolOrDefault(config, \"$.adapters.wormhole.deploy\"),\n                relayer: _parseJsonAddressOrDefault(config, \"$.adapters.wormhole.relayer\")\n            }),\n            axelar: AxelarInput({\n                shouldDeploy: _parseJsonBoolOrDefault(config, \"$.adapters.axelar.deploy\"),\n                gateway: _parseJsonAddressOrDefault(config, \"$.adapters.axelar.gateway\"),\n                gasService: _parseJsonAddressOrDefault(config, \"$.adapters.axelar.gasService\")\n            })\n        });\n\n        FullActionBatcher batcher = new FullActionBatcher();\n\n        if (commonInput.version == keccak256(abi.encodePacked((\"3\")))) _verifyAdmin(commonInput);\n\n        deployFull(commonInput, adaptersInput, batcher);\n\n        removeFullDeployerAccess(batcher);\n\n        batcher.lock();\n\n        if (commonInput.version == keccak256(abi.encodePacked((\"3\")))) _verifyMainnetAddresses();\n\n        saveDeploymentOutput();\n\n        vm.stopBroadcast();\n    }\n\n    function _parseJsonBoolOrDefault(string memory config, string memory path) private pure returns (bool) {\n        try vm.parseJsonBool(config, path) returns (bool value) {\n            return value;\n        } catch {\n            return false;\n        }\n    }\n\n    function _parseJsonAddressOrDefault(string memory config, string memory path) private pure returns (address) {\n        try vm.parseJsonAddress(config, path) returns (address value) {\n            return value;\n        } catch {\n            return address(0);\n        }\n    }\n\n    function _isSafeOwner(ISafe safe, address addr) internal view returns (bool) {\n        try safe.isOwner(addr) returns (bool isOwner) {\n            return isOwner;\n        } catch {\n            return false;\n        }\n    }\n\n    function _verifyAdmin(CommonInput memory commonInput) internal view {\n        require(_isSafeOwner(commonInput.adminSafe, 0x4d47a7a89478745200Bd51c26bA87664538Df541));\n        require(_isSafeOwner(commonInput.adminSafe, 0xc599bb54E3BFb6393c7feAf0EC97a947753aC0c8));\n        require(_isSafeOwner(commonInput.adminSafe, 0xE9441B34f71659cCA2bfE90d98ee0e57D9CAD28F));\n        require(_isSafeOwner(commonInput.adminSafe, 0x5e7A86178252Aeae9cBDa30f9C342c71799A3EE1));\n        require(_isSafeOwner(commonInput.adminSafe, 0x9eDec77dd2651Ce062ab17e941347018AD4eAEA9));\n        require(_isSafeOwner(commonInput.adminSafe, 0xd55114BfE98a2ca16202Aa741BeE571765292616));\n        require(_isSafeOwner(commonInput.adminSafe, 0x790c2c860DDC993f3da92B19cB440cF8338C59a6));\n        require(_isSafeOwner(commonInput.adminSafe, 0xc4576CE4603552c5BeAa056c449b0795D48fcf92));\n    }\n\n    function _verifyMainnetAddresses() internal view {\n        require(address(root) == 0x7Ed48C31f2fdC40d37407cBaBf0870B2b688368f);\n        require(address(guardian) == 0xFEE13c017693a4706391D516ACAbF6789D5c3157);\n        require(address(gasService) == 0x295262f96186505Ce67c67B9d29e36ad1f9EAe88);\n        require(address(gateway) == 0x51eA340B3fe9059B48f935D5A80e127d587B6f89);\n        require(address(multiAdapter) == 0x457C91384C984b1659157160e8543adb12BC5317);\n        require(address(messageProcessor) == 0xE994149c6D00Fe8708f843dc73973D1E7205530d);\n        require(address(messageDispatcher) == 0x21AF0C29611CFAaFf9271C8a3F84F2bC31d59132);\n        require(address(poolEscrowFactory) == 0xD166B3210edBeEdEa73c7b2e8aB64BDd30c980E9);\n        require(address(tokenRecoverer) == 0x94269dBaBA605b63321221679df1356be0c00E63);\n        require(address(hubRegistry) == 0x12044ef361Cc3446Cb7d36541C8411EE4e6f52cb);\n        require(address(accounting) == 0xE999a426D92c30fEE4f074B3a53071A6e935419F);\n        require(address(holdings) == 0x0261FA29b3F2784AF17874428b58d971b6652C47);\n        require(address(shareClassManager) == 0xe88e712d60bfd23048Dbc677FEb44E2145F2cDf4);\n        require(address(hubHelpers) == 0xA30D9E76a80675A719d835a74d09683AD2CB71EE);\n        require(address(hub) == 0x9c8454A506263549f07c80698E276e3622077098);\n        require(address(tokenFactory) == 0xC8eDca090b772C48BcE5Ae14Eb7dd517cd70A32C);\n        require(address(spoke) == 0xd30Da1d7F964E5f6C2D9fE2AAA97517F6B23FA2B);\n        require(address(balanceSheet) == 0xBcC8D02d409e439D98453C0b1ffa398dFFb31fda);\n        require(address(contractUpdater) == 0x8dD5a3d4e9ec54388dAd23B8a1f3B2159B2f2D85);\n        require(address(routerEscrow) == 0xB86B6AE94E6d05AAc086665534A73fee557EE9F6);\n        require(address(globalEscrow) == 0x43d51be0B6dE2199A2396bA604114d24383F91E9);\n        require(address(asyncRequestManager) == 0x58d57896EBbF000c293327ADf33689D0a7Fd3d9A);\n        require(address(syncManager) == 0x0D82d9fa76CFCd6F4cc59F053b2458665C6CE773);\n        require(address(asyncVaultFactory) == 0xE01Ce2e604CCe985A06FA4F4bCD17f1F08417BF3);\n        require(address(syncDepositVaultFactory) == 0x3568184784E8ACCaacF51A7F710a3DE0144E4f29);\n        require(address(vaultRouter) == 0xdbCcee499563D4AC2D3788DeD3acb14FB92B175D);\n        require(address(freezeOnlyHook) == 0xBb7ABFB0E62dfb36e02CeeCDA59ADFD71f50c88e);\n        require(address(fullRestrictionsHook) == 0xa2C98F0F76Da0C97039688CA6280d082942d0b48);\n        require(address(freelyTransferableHook) == 0xbce8C1f411484C28a64f7A6e3fA63C56b6f3dDDE);\n        require(address(redemptionRestrictionsHook) == 0xf0C36EFD5F6465D18B9679ee1407a3FC9A2955dD);\n        require(address(onOfframpManagerFactory) == 0xcb084F79e8AE54e1373130F4F7119214FCe972a9);\n        require(address(merkleProofManagerFactory) == 0xaBd3cDc17C15a9E7771876cE24aB10A8E722781d);\n        require(address(vaultDecoder) == 0x72B188c37bD8Eb002d0D9c63CCd77F2Ff71d272e);\n        require(address(circleDecoder) == 0x6fce63E718fED6E20bAa8179e313C24cbF2EDa24);\n        require(address(identityValuation) == 0x3b8FaE903a6511f9707A2f45747a0de3B747711f);\n    }\n}\n"
    }
}