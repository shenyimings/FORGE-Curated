{
    "vfp_id": "vfp_00508",
    "project_name": "Uniswap Calibur Audit.md",
    "findings": [
        {
            "id": 4,
            "category": {
                "1": [
                    "CWE-693"
                ],
                "2": [
                    "CWE-345"
                ],
                "3": [
                    "CWE-346"
                ]
            },
            "title": "Domain Separator Does Not Include Delegate Address",
            "description": "The EIP-712 domain separator in the `EIP712.sol` contract does not include the delegate contract address, relying only on `address(this)` which refers to the EOA. This means that if an EOA re-delegates to a different implementation contract with the same domain name and version, the domain separator remains unchanged. The cause is an incomplete domain construction that omits the implementation address. An attacker could exploit this by replaying old signatures from a previous delegation context if nonces or deadlines are not properly managed. The impact is potential signature replay attacks across different wallet implementations, leading to unauthorized execution of outdated or invalid transactions.\n",
            "severity": "Low",
            "location": [
                "EIP712.sol::domainSeparator#73"
            ],
            "files": [
                "732a20a8d82f034573c6c7e44160f1860233a946/minimal-delegation/src/EIP712.sol"
            ]
        }
    ],
    "affected_files": {
        "EIP712.sol": "// SPDX-License-Identifier: UNLICENSED\npragma solidity ^0.8.23;\n\nimport {IERC5267} from \"@openzeppelin/contracts/interfaces/IERC5267.sol\";\nimport {MessageHashUtils} from \"@openzeppelin/contracts/utils/cryptography/MessageHashUtils.sol\";\nimport {IEIP712} from \"./interfaces/IEIP712.sol\";\n\n/// @title EIP712\n/// @dev This contract does not cache the domain separator and calculates it on the fly since it will change when delegated to.\n/// @notice It is not compatible with use by proxy contracts since the domain name and version are cached on deployment.\ncontract EIP712 is IEIP712, IERC5267 {\n    /// @dev `keccak256(\"EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)\")`.\n    bytes32 internal constant _DOMAIN_TYPEHASH = 0x8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f;\n\n    /// @dev Cached name and version hashes for cheaper runtime gas costs.\n    bytes32 private immutable _cachedNameHash;\n    bytes32 private immutable _cachedVersionHash;\n\n    constructor() {\n        string memory name;\n        string memory version;\n        (name, version) = _domainNameAndVersion();\n        _cachedNameHash = keccak256(bytes(name));\n        _cachedVersionHash = keccak256(bytes(version));\n    }\n\n    /// @notice Returns information about the `EIP712Domain` used to create EIP-712 compliant hashes.\n    ///\n    /// @dev Follows ERC-5267 (see https://eips.ethereum.org/EIPS/eip-5267).\n    ///\n    /// @return fields The bitmap of used fields.\n    /// @return name The value of the `EIP712Domain.name` field.\n    /// @return version The value of the `EIP712Domain.version` field.\n    /// @return chainId The value of the `EIP712Domain.chainId` field.\n    /// @return verifyingContract The value of the `EIP712Domain.verifyingContract` field.\n    /// @return salt The value of the `EIP712Domain.salt` field.\n    /// @return extensions The list of EIP numbers, that extends EIP-712 with new domain fields.\n    function eip712Domain()\n        public\n        view\n        virtual\n        returns (\n            bytes1 fields,\n            string memory name,\n            string memory version,\n            uint256 chainId,\n            address verifyingContract,\n            bytes32 salt,\n            uint256[] memory extensions\n        )\n    {\n        fields = hex\"0f\"; // `0b1111`.\n        (name, version) = _domainNameAndVersion();\n        chainId = block.chainid;\n        verifyingContract = address(this);\n        salt = bytes32(0);\n        extensions = new uint256[](0);\n    }\n\n    /// @notice Encode the EIP-5267 domain into bytes\n    /// @dev for use in ERC-7739\n    function domainBytes() public view returns (bytes memory) {\n        // _eip712Domain().fields and _eip712Domain().extensions are not used\n        (, string memory name, string memory version, uint256 chainId, address verifyingContract, bytes32 salt,) =\n            eip712Domain();\n        return abi.encode(keccak256(bytes(name)), keccak256(bytes(version)), chainId, verifyingContract, salt);\n    }\n\n    /// @notice Returns the `domainSeparator` used to create EIP-712 compliant hashes.\n    /// @return The 32 bytes domain separator result.\n    function domainSeparator() public view returns (bytes32) {\n        return\n            keccak256(abi.encode(_DOMAIN_TYPEHASH, _cachedNameHash, _cachedVersionHash, block.chainid, address(this)));\n    }\n\n    /// @notice Public getter for `_hashTypedData()` to produce a EIP-712 hash using this account's domain separator\n    /// @param hash The nested typed data. Assumes the hash is the result of applying EIP-712 `hashStruct`.\n    function hashTypedData(bytes32 hash) public view virtual returns (bytes32) {\n        return MessageHashUtils.toTypedDataHash(domainSeparator(), hash);\n    }\n\n    /// @notice Returns the domain name and version to use when creating EIP-712 signatures.\n    /// @return name    The user readable name of signing domain.\n    /// @return version The current major version of the signing domain.\n    function _domainNameAndVersion() internal pure returns (string memory name, string memory version) {\n        return (\"Uniswap Minimal Delegation\", \"1\");\n    }\n}\n"
    }
}