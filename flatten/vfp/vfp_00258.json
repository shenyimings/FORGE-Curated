{
    "vfp_id": "vfp_00258",
    "project_name": "2025-05-caplabs-coveredagentprotocol-securityreview.pdf",
    "findings": [
        {
            "id": 16,
            "category": {
                "1": [
                    "CWE-682"
                ]
            },
            "title": "Wrong capTokenDecimals value used in StakedCapAdapter.price causes inaccurate prices",
            "description": "The StakedCapAdapter library incorrectly uses the decimal count (e.g., 18) instead of the corresponding scaling factor (10^18) in price calculations, leading to wildly inaccurate prices. The root cause is a fundamental misunderstanding of how decimal scaling works in the price function: it passes the decimal count to convertToAssets, which expects a share amount, and divides by the decimal count rather than the scaling factor. This results in price miscalculations by several orders of magnitude. An attacker can exploit this by observing the incorrect prices and executing trades that take advantage of the disparity between the reported and actual values. The impact includes potential manipulation of minting and burning operations, incorrect valuation of collateral, and possible insolvency due to erroneous price feeds being used in critical financial operations.\n",
            "severity": "High",
            "location": [
                "contracts/oracle/libraries/StakedCapAdapter.sol#L15-L21",
                "StakedCapAdapter.sol::price"
            ],
            "files": [
                "cap-contracts/contracts/oracle/libraries/StakedCapAdapter.sol"
            ]
        }
    ],
    "affected_files": {
        "StakedCapAdapter.sol": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity ^0.8.28;\n\nimport { IOracle } from \"../../interfaces/IOracle.sol\";\nimport { IERC4626 } from \"@openzeppelin/contracts/interfaces/IERC4626.sol\";\nimport { IERC20Metadata } from \"@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol\";\n\n/// @title Staked Cap Token Adapter\n/// @notice Prices are calculated based on the underlying cap token price and accrued yield\nlibrary StakedCapAdapter {\n    /// @notice Fetch price for a staked cap token\n    /// @param _asset Staked cap token address\n    /// @return latestAnswer Price of the staked cap token fixed to 8 decimals\n    /// @return lastUpdated Latest timestamp of the price\n    function price(address _asset) external view returns (uint256 latestAnswer, uint256 lastUpdated) {\n        address capToken = IERC4626(_asset).asset();\n        (latestAnswer, lastUpdated) = IOracle(msg.sender).getPrice(capToken);\n        uint256 capTokenDecimals = IERC20Metadata(capToken).decimals();\n        uint256 pricePerFullShare = IERC4626(_asset).convertToAssets(capTokenDecimals);\n        latestAnswer = latestAnswer * pricePerFullShare / capTokenDecimals;\n    }\n}\n"
    }
}