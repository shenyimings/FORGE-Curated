{
    "vfp_id": "vfp_00143",
    "project_name": "Likwid - Zenith Audit Report.pdf",
    "findings": [
        {
            "id": 9,
            "category": {
                "1": [
                    "CWE-707"
                ],
                "2": [
                    "CWE-20"
                ],
                "3": [
                    "CWE-1284"
                ]
            },
            "title": "Unused borrowAmountMax parameter allows excessive borrowing beyond userâ€™s expected limit",
            "description": "The borrowAmountMax parameter in the CreateParams struct is intended to cap the maximum borrow amount during leveraged position creation, serving as a slippage protection mechanism. However, this parameter is never enforced in the _margin() function. The actual borrow amount is calculated based on pool reserves and dynamic fees without validation against borrowAmountMax. This allows users to borrow more than intended, especially during high volatility or fee spikes, increasing their liquidation risk and potentially leading to unexpected losses due to over-leveraging.\n",
            "severity": "High",
            "location": [
                "IMarginPositionManager.sol#L200",
                "LikwidMarginPosition.sol#L209"
            ],
            "files": [
                "likwid-margin/src/interfaces/IMarginPositionManager.sol"
            ]
        },
        {
            "id": 53,
            "category": {
                "1": [
                    "CWE-710"
                ],
                "2": [
                    "CWE-1076"
                ],
                "3": [
                    "CWE-1078"
                ],
                "4": [
                    "CWE-1099"
                ]
            },
            "title": "Parameter name mismatch between interface and implementation in close()",
            "description": "The close() function parameter is named closeAmountMin in implementation but profitAmountMin in the interface, creating inconsistency. The root cause is naming divergence. This can confuse developers and integrators. The impact is reduced code clarity and potential integration errors.\n",
            "severity": "Informational",
            "location": [
                "IMarginPositionManager.sol",
                "MarginPositionManager.sol"
            ],
            "files": [
                "likwid-margin/src/interfaces/IMarginPositionManager.sol"
            ]
        }
    ],
    "affected_files": {
        "IMarginPositionManager.sol": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity ^0.8.26;\n\nimport {PoolId} from \"../types/PoolId.sol\";\nimport {PoolKey} from \"../types/PoolKey.sol\";\nimport {MarginLevels} from \"../types/MarginLevels.sol\";\nimport {IBasePositionManager} from \"./IBasePositionManager.sol\";\nimport {MarginPosition} from \"../libraries/MarginPosition.sol\";\n\ninterface IMarginPositionManager is IBasePositionManager {\n    /// @notice Thrown when the provided level is invalid\n    error InvalidLevel();\n\n    /// @notice Thrown when the received borrow amount is insufficient\n    error InsufficientBorrowReceived();\n\n    /// @notice Thrown when the received close amount is insufficient\n    error InsufficientCloseReceived();\n\n    /// @notice Thrown when the received amount is insufficient\n    error InsufficientReceived();\n\n    /// @notice Thrown when the position is not liquidated\n    error PositionNotLiquidated();\n\n    /// @notice Thrown when the mirror amount is too high\n    error MirrorTooMuch();\n\n    /// @notice Thrown when the borrow amount is too high\n    error BorrowTooMuch();\n\n    /// @notice Thrown when the reserves are not enough\n    error ReservesNotEnough();\n\n    /// @notice Thrown when margin is banned for low fee pools\n    error LowFeePoolMarginBanned();\n\n    /// @notice Emitted when the margin level is changed\n    /// @param oldLevel The old margin level\n    /// @param newLevel The new margin level\n    event MarginLevelChanged(bytes32 oldLevel, bytes32 newLevel);\n\n    /// @notice Emitted when the margin fee is changed\n    /// @param oldFee The old margin fee\n    /// @param newFee The new margin fee\n    event MarginFeeChanged(uint24 oldFee, uint24 newFee);\n\n    /// @notice Emitted when a margin position is created or increased\n    /// @param poolId The ID of the pool\n    /// @param owner The owner of the position\n    /// @param tokenId The ID of the position token\n    /// @param marginAmount The amount of margin added\n    /// @param marginTotal The total margin of the position\n    /// @param debtAmount The total debt of the position\n    /// @param marginForOne Whether the margin is for currency1\n    event Margin(\n        PoolId indexed poolId,\n        address indexed owner,\n        uint256 tokenId,\n        uint256 marginAmount,\n        uint256 marginTotal,\n        uint256 debtAmount,\n        bool marginForOne\n    );\n\n    /// @notice Emitted when a margin position is repaid\n    /// @param poolId The ID of the pool\n    /// @param sender The address of the repayer\n    /// @param tokenId The ID of the position token\n    /// @param marginAmount The amount of margin in the position\n    /// @param marginTotal The total margin of the position\n    /// @param debtAmount The total debt of the position\n    /// @param releaseAmount The amount of margin released\n    /// @param repayAmount The amount of debt repaid\n    event Repay(\n        PoolId indexed poolId,\n        address indexed sender,\n        uint256 tokenId,\n        uint256 marginAmount,\n        uint256 marginTotal,\n        uint256 debtAmount,\n        uint256 releaseAmount,\n        uint256 repayAmount\n    );\n\n    /// @notice Emitted when a margin position is closed\n    /// @param poolId The ID of the pool\n    /// @param sender The address of the closer\n    /// @param tokenId The ID of the position token\n    /// @param marginAmount The amount of margin in the position\n    /// @param marginTotal The total margin of the position\n    /// @param debtAmount The total debt of the position\n    /// @param releaseAmount The amount of margin released\n    /// @param repayAmount The amount of debt repaid\n    /// @param closeAmount The amount received after closing\n    event Close(\n        PoolId indexed poolId,\n        address indexed sender,\n        uint256 tokenId,\n        uint256 marginAmount,\n        uint256 marginTotal,\n        uint256 debtAmount,\n        uint256 releaseAmount,\n        uint256 repayAmount,\n        uint256 closeAmount\n    );\n\n    /// @notice Emitted when a margin position is modified\n    /// @param poolId The ID of the pool\n    /// @param sender The address of the modifier\n    /// @param tokenId The ID of the position token\n    /// @param marginAmount The amount of margin in the position\n    /// @param marginTotal The total margin of the position\n    /// @param debtAmount The total debt of the position\n    /// @param changeAmount The amount of change in the position\n    event Modify(\n        PoolId indexed poolId,\n        address indexed sender,\n        uint256 tokenId,\n        uint256 marginAmount,\n        uint256 marginTotal,\n        uint256 debtAmount,\n        int256 changeAmount\n    );\n\n    /// @notice Emitted when a margin position is liquidated by burning\n    /// @param poolId The ID of the pool\n    /// @param sender The address of the liquidator\n    /// @param tokenId The ID of the position token\n    /// @param marginAmount The amount of margin in the position\n    /// @param marginTotal The total margin of the position\n    /// @param debtAmount The total debt of the position\n    /// @param truncatedReserves The truncated reserves of the pool\n    /// @param pairReserves The pair reserves of the pool\n    /// @param releaseAmount The amount of margin released\n    /// @param repayAmount The amount of debt repaid\n    /// @param profitAmount The profit from the liquidation\n    /// @param lostAmount The loss from the liquidation\n    event LiquidateBurn(\n        PoolId indexed poolId,\n        address indexed sender,\n        uint256 tokenId,\n        uint256 marginAmount,\n        uint256 marginTotal,\n        uint256 debtAmount,\n        uint256 truncatedReserves,\n        uint256 pairReserves,\n        uint256 releaseAmount,\n        uint256 repayAmount,\n        uint256 profitAmount,\n        uint256 lostAmount\n    );\n\n    /// @notice Emitted when a margin position is liquidated by calling\n    /// @param poolId The ID of the pool\n    /// @param sender The address of the liquidator\n    /// @param tokenId The ID of the position token\n    /// @param marginAmount The amount of margin in the position\n    /// @param marginTotal The total margin of the position\n    /// @param debtAmount The total debt of the position\n    /// @param truncatedReserves The truncated reserves of the pool\n    /// @param pairReserves The pair reserves of the pool\n    /// @param releaseAmount The amount of margin released\n    /// @param repayAmount The amount of debt repaid\n    /// @param needRepayAmount The amount of debt that needs to be repaid\n    /// @param lostAmount The loss from the liquidation\n    event LiquidateCall(\n        PoolId indexed poolId,\n        address indexed sender,\n        uint256 tokenId,\n        uint256 marginAmount,\n        uint256 marginTotal,\n        uint256 debtAmount,\n        uint256 truncatedReserves,\n        uint256 pairReserves,\n        uint256 releaseAmount,\n        uint256 repayAmount,\n        uint256 needRepayAmount,\n        uint256 lostAmount\n    );\n\n    /// @notice Gets the state of a position\n    /// @param tokenId The ID of the position token\n    /// @return position The state of the position\n    function getPositionState(uint256 tokenId) external view returns (MarginPosition.State memory position);\n\n    struct CreateParams {\n        /// @notice true: currency1 is marginToken, false: currency0 is marginToken\n        bool marginForOne;\n        /// @notice Leverage factor of the margin position.\n        uint24 leverage;\n        /// @notice The amount of margin\n        uint256 marginAmount;\n        /// @notice The borrow amount of the margin position.When the parameter is passed in, it is 0.\n        uint256 borrowAmount;\n        /// @notice The maximum borrow amount of the margin position.\n        uint256 borrowAmountMax;\n        /// @notice The address of recipient\n        address recipient;\n        /// @notice Deadline for the transaction\n        uint256 deadline;\n    }\n\n    /// @notice Create/Add a position\n    /// @param key The key of pool\n    /// @param params The parameters of the margin position\n    /// @return tokenId The id of position\n    /// @return borrowAmount The borrow amount\n    /// @return swapFeeAmount The swap amount in margin\n    function addMargin(PoolKey memory key, IMarginPositionManager.CreateParams calldata params)\n        external\n        payable\n        returns (uint256 tokenId, uint256 borrowAmount, uint256 swapFeeAmount);\n\n    struct MarginParams {\n        uint256 tokenId;\n        /// @notice Leverage factor of the margin position.\n        uint24 leverage;\n        /// @notice The amount of margin\n        uint256 marginAmount;\n        /// @notice The borrow amount of the margin position.When the parameter is passed in, it is 0.\n        uint256 borrowAmount;\n        /// @notice The maximum borrow amount of the margin position.\n        uint256 borrowAmountMax;\n        /// @notice Deadline for the transaction\n        uint256 deadline;\n    }\n\n    /// @notice Margin a position\n    /// @param params The parameters of the margin position\n    /// @return borrowAmount The borrow amount\n    /// @return swapFeeAmount The swap amount in margin\n    function margin(IMarginPositionManager.MarginParams memory params)\n        external\n        payable\n        returns (uint256 borrowAmount, uint256 swapFeeAmount);\n\n    /// @notice Release the margin position by repaying the debt\n    /// @param tokenId The id of position\n    /// @param repayAmount The amount to repay\n    /// @param deadline Deadline for the transaction\n    function repay(uint256 tokenId, uint256 repayAmount, uint256 deadline) external payable;\n\n    /// @notice Close the margin position\n    /// @param tokenId The id of position\n    /// @param closeMillionth The repayment ratio is calculated as one millionth\n    /// @param profitAmountMin The minimum profit amount to be received after closing the position\n    /// @param deadline Deadline for the transaction\n    function close(uint256 tokenId, uint24 closeMillionth, uint256 profitAmountMin, uint256 deadline) external;\n\n    /// @notice Liquidates a position by burning the position token.\n    /// @param tokenId The ID of the position to liquidate.\n    /// @return profit The profit from the liquidation.\n    function liquidateBurn(uint256 tokenId) external returns (uint256 profit);\n\n    /// @notice Liquidates a position by making a call.\n    /// @param tokenId The ID of the position to liquidate.\n    /// @return profit The profit from the liquidation.\n    /// @return repayAmount The amount repaid.\n    function liquidateCall(uint256 tokenId) external payable returns (uint256 profit, uint256 repayAmount);\n\n    /// @notice Modify the margin position\n    /// @param tokenId The id of position\n    /// @param changeAmount The amount to modify\n    function modify(uint256 tokenId, int128 changeAmount) external payable;\n\n    /// @notice Gets the default margin fee\n    /// @return defaultMarginFee The default margin fee\n    function defaultMarginFee() external view returns (uint24 defaultMarginFee);\n\n    /// @notice Gets the margin levels\n    /// @return marginLevel The margin levels\n    function marginLevels() external view returns (MarginLevels marginLevel);\n}\n"
    }
}