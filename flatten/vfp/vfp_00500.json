{
    "vfp_id": "vfp_00500",
    "project_name": "2025.08.14 - Final - Malda Audit Report.pdf",
    "findings": [
        {
            "id": 14,
            "category": {
                "1": [
                    "CWE-697"
                ],
                "2": [
                    "CWE-1024"
                ]
            },
            "title": "MixedPriceOracleV4 returns stale prices due to decimal mismatch",
            "description": "The MixedPriceOracleV4 contract compares prices from API3 (18 decimals) and EO (8 decimals) oracles without normalizing decimals, causing _absDiff to produce an incorrect, disproportionately large delta. The root cause is the lack of decimal adjustment before comparison. This leads to the function always selecting the EO oracle's price, even when it is stale. If the EO price is stale, the function reverts with MixedPriceOracle_eOracleStalePrice, despite a fresh API3 price being available. The exploitation occurs during any price query for affected tokens. The impact is a denial of service for price feeds, preventing operations like borrowing or liquidation, even when valid price data exists.\n",
            "severity": "Medium",
            "location": [
                "MixedPriceOracleV4.sol#114",
                "MixedPriceOracleV4.sol::_getLatestPrice"
            ],
            "files": [
                "798d00b879b8412ca4049ba09dba5ae42464cfe7/2025-07-malda/malda-lending/src/oracles/MixedPriceOracleV4.sol"
            ]
        }
    ],
    "affected_files": {
        "MixedPriceOracleV4.sol": "// Copyright (c) 2025 Merge Layers Inc.\n//\n// This source code is licensed under the Business Source License 1.1\n// (the \"License\"); you may not use this file except in compliance with the\n// License. You may obtain a copy of the License at\n//\n//     https://github.com/malda-protocol/malda-lending/blob/main/LICENSE-BSL\n//\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\n// SPDX-License-Identifier: BSL-1.1\npragma solidity =0.8.28;\n\nimport {IRoles} from \"src/interfaces/IRoles.sol\";\nimport {ImTokenMinimal} from \"src/interfaces/ImToken.sol\";\nimport {IOracleOperator} from \"src/interfaces/IOracleOperator.sol\";\nimport {IDefaultAdapter} from \"src/interfaces/IDefaultAdapter.sol\";\n\ncontract MixedPriceOracleV4 is IOracleOperator {\n    uint256 public immutable STALENESS_PERIOD;\n\n    // ----------- STORAGE ------------\n    struct PriceConfig {\n        address api3Feed;\n        address eOracleFeed;\n        string toSymbol;\n        uint256 underlyingDecimals;\n    }\n\n    mapping(string => PriceConfig) public configs;\n    mapping(string => uint256) public stalenessPerSymbol;\n    mapping(string => uint256) public deltaPerSymbol;\n\n    uint256 public maxPriceDelta = 1.5e3; //1.5%\n    uint256 public constant PRICE_DELTA_EXP = 1e5;\n    IRoles public immutable roles;\n\n    error MixedPriceOracle_Unauthorized();\n    error MixedPriceOracle_ApiV3StalePrice();\n    error MixedPriceOracle_eOracleStalePrice();\n    error MixedPriceOracle_InvalidPrice();\n    error MixedPriceOracle_InvalidRound();\n    error MixedPriceOracle_InvalidConfig();\n    error MixedPriceOracle_InvalidConfigDecimals();\n    error MixedPriceOracle_DeltaTooHigh();\n    error MixedPriceOracle_MissingFeed();\n\n    event ConfigSet(string symbol, PriceConfig config);\n    event StalenessUpdated(string symbol, uint256 val);\n    event PriceDeltaUpdated(uint256 oldVal, uint256 newVal);\n    event PriceSymbolDeltaUpdated(uint256 oldVal, uint256 newVal, string symbol);\n\n    constructor(string[] memory symbols_, PriceConfig[] memory configs_, address roles_, uint256 stalenessPeriod_) {\n        roles = IRoles(roles_);\n        for (uint256 i = 0; i < symbols_.length; i++) {\n            configs[symbols_[i]] = configs_[i];\n        }\n        STALENESS_PERIOD = stalenessPeriod_;\n    }\n\n    function setStaleness(string memory symbol, uint256 val) external {\n        if (!roles.isAllowedFor(msg.sender, roles.GUARDIAN_ORACLE())) {\n            revert MixedPriceOracle_Unauthorized();\n        }\n        stalenessPerSymbol[symbol] = val;\n        emit StalenessUpdated(symbol, val);\n    }\n\n    function setConfig(string memory symbol, PriceConfig memory config) external {\n        if (!roles.isAllowedFor(msg.sender, roles.GUARDIAN_ORACLE())) {\n            revert MixedPriceOracle_Unauthorized();\n        }\n        if (config.api3Feed == address(0) || config.eOracleFeed == address(0)) {\n            revert MixedPriceOracle_InvalidConfig();\n        }\n\n        configs[symbol] = config;\n        emit ConfigSet(symbol, config);\n    }\n\n    function setMaxPriceDelta(uint256 _delta) external {\n        if (!roles.isAllowedFor(msg.sender, roles.GUARDIAN_ORACLE())) {\n            revert MixedPriceOracle_Unauthorized();\n        }\n\n        require(_delta <= PRICE_DELTA_EXP, MixedPriceOracle_DeltaTooHigh());\n\n        emit PriceDeltaUpdated(maxPriceDelta, _delta);\n        maxPriceDelta = _delta;\n    }\n\n    function setSymbolMaxPriceDelta(uint256 _delta, string calldata _symbol) external {\n        if (!roles.isAllowedFor(msg.sender, roles.GUARDIAN_ORACLE())) {\n            revert MixedPriceOracle_Unauthorized();\n        }\n\n        require(_delta <= PRICE_DELTA_EXP, MixedPriceOracle_DeltaTooHigh());\n\n        emit PriceSymbolDeltaUpdated(deltaPerSymbol[_symbol], _delta, _symbol);\n        deltaPerSymbol[_symbol] = _delta;\n    }\n\n    function getPrice(address mToken) public view returns (uint256) {\n        string memory symbol = ImTokenMinimal(mToken).symbol();\n        return _getPriceUSD(symbol);\n    }\n\n    // price is extended for operator usage based on decimals of exchangeRate\n    function getUnderlyingPrice(address mToken) external view override returns (uint256) {\n        // ImTokenMinimal cast is needed for `.symbol()` call. No need to import a different interface\n        string memory symbol = ImTokenMinimal(ImTokenMinimal(mToken).underlying()).symbol();\n        PriceConfig memory config = configs[symbol];\n        uint256 priceUsd = _getPriceUSD(symbol);\n        return priceUsd * 10 ** (18 - config.underlyingDecimals);\n    }\n\n    function _getPriceUSD(string memory symbol) internal view returns (uint256) {\n        PriceConfig memory config = configs[symbol];\n        (uint256 feedPrice, uint256 feedDecimals) = _getLatestPrice(symbol, config);\n        uint256 price = feedPrice * 10 ** (18 - feedDecimals);\n\n        if (keccak256(abi.encodePacked(config.toSymbol)) != keccak256(abi.encodePacked(\"USD\"))) {\n            price = (price * _getPriceUSD(config.toSymbol)) / 10 ** 18;\n        }\n\n        return price;\n    }\n\n    function _getLatestPrice(string memory symbol, PriceConfig memory config)\n        internal\n        view\n        returns (uint256, uint256)\n    {\n        if (config.api3Feed == address(0) || config.eOracleFeed == address(0)) revert MixedPriceOracle_MissingFeed();\n\n        //get both prices\n        (, int256 apiV3Price,, uint256 apiV3UpdatedAt,) = IDefaultAdapter(config.api3Feed).latestRoundData();\n        (, int256 eOraclePrice,, uint256 eOracleUpdatedAt,) = IDefaultAdapter(config.eOracleFeed).latestRoundData();\n\n        // check if ApiV3 price is up to date\n        uint256 _staleness = _getStaleness(symbol);\n        bool apiV3Fresh = block.timestamp - apiV3UpdatedAt <= _staleness;\n\n        // check delta\n        uint256 delta = _absDiff(apiV3Price, eOraclePrice);\n        uint256 deltaBps = (delta * PRICE_DELTA_EXP) / uint256(eOraclePrice < 0 ? -eOraclePrice : eOraclePrice);\n\n        uint256 deltaSymbol = deltaPerSymbol[symbol];\n        if (deltaSymbol == 0) {\n            deltaSymbol = maxPriceDelta;\n        }\n\n        uint256 decimals;\n        uint256 uPrice;\n        if (!apiV3Fresh || deltaBps > deltaSymbol) {\n            require(block.timestamp - eOracleUpdatedAt < _staleness, MixedPriceOracle_eOracleStalePrice());\n            decimals = IDefaultAdapter(config.eOracleFeed).decimals();\n            uPrice = uint256(eOraclePrice);\n        } else {\n            require(block.timestamp - apiV3UpdatedAt < _staleness, MixedPriceOracle_ApiV3StalePrice());\n            decimals = IDefaultAdapter(config.api3Feed).decimals();\n            uPrice = uint256(apiV3Price);\n        }\n\n        return (uPrice, decimals);\n    }\n\n    function _absDiff(int256 a, int256 b) internal pure returns (uint256) {\n        return uint256(a >= b ? a - b : b - a);\n    }\n\n    function _getStaleness(string memory symbol) internal view returns (uint256) {\n        uint256 _registered = stalenessPerSymbol[symbol];\n        return _registered > 0 ? _registered : STALENESS_PERIOD;\n    }\n}\n"
    }
}