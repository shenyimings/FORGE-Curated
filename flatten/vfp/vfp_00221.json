{
    "vfp_id": "vfp_00221",
    "project_name": "cantina_steakhouse_nov2025.pdf",
    "findings": [
        {
            "id": 23,
            "category": {
                "1": [
                    "CWE-707"
                ],
                "2": [
                    "CWE-20"
                ]
            },
            "title": "No oracle scale normalization",
            "description": "The contract assumes all oracles return prices scaled to 1e36 without accounting for token or base asset decimals. This assumption can lead to incorrect valuations if the oracle price is not pre-scaled appropriately. ORACLE_PRECISION is hardcoded to 1e36, and the code multiplies token balances by oracle prices and divides by 1e36 without adjusting for differences in token decimals. There is no on-chain validation that the oracle output matches the expected scale. An incorrectly scaled oracle feed (e.g., a true 36-decimal price for a token with 6 decimals) would result in massive miscalculations of value, potentially allowing undercollateralized mints or blocking legitimate swaps. Incorrect NAV calculations, broken slippage checks, and flawed deposit previews could destabilize the vaultâ€™s accounting, leading to financial loss or operational failure.\n",
            "severity": "Informational",
            "location": [
                "DeployEthereum.s.sol::#L62-L86"
            ],
            "files": [
                "box/script/DeployEthereum.s.sol"
            ]
        }
    ],
    "affected_files": {
        "DeployEthereum.s.sol": "// SPDX-License-Identifier: GPL-2.0-or-later\npragma solidity ^0.8.13;\n\nimport {Script, console} from \"forge-std/Script.sol\";\nimport {BoxFactory} from \"../src/factories/BoxFactory.sol\";\nimport {BoxAdapterFactory} from \"../src/factories/BoxAdapterFactory.sol\";\nimport {MorphoVaultV1AdapterFactory} from \"@vault-v2/src/adapters/MorphoVaultV1AdapterFactory.sol\";\nimport {MorphoMarketV1AdapterFactory} from \"@vault-v2/src/adapters/MorphoMarketV1AdapterFactory.sol\";\nimport {IMetaMorpho} from \"@vault-v2/lib/metamorpho/src/interfaces/IMetaMorpho.sol\";\nimport {MarketParams, IMorpho, Id} from \"@vault-v2/lib/morpho-blue/src/interfaces/IMorpho.sol\";\nimport {Id as MetaId} from \"@vault-v2/lib/metamorpho/lib/morpho-blue/src/interfaces/IMorpho.sol\";\nimport {MarketParams as MarketParamsBlue, IMorpho as IMorphoBlue} from \"@morpho-blue/interfaces/IMorpho.sol\";\nimport {VaultV2Factory} from \"@vault-v2/src/VaultV2Factory.sol\";\nimport {IERC20} from \"@openzeppelin/contracts/token/ERC20/IERC20.sol\";\nimport {IERC4626} from \"@openzeppelin/contracts/interfaces/IERC4626.sol\";\nimport {IOracle} from \"../src/interfaces/IOracle.sol\";\nimport {IVaultV2} from \"@vault-v2/src/interfaces/IVaultV2.sol\";\nimport {IBoxAdapter} from \"../src/interfaces/IBoxAdapter.sol\";\nimport {IBox} from \"../src/interfaces/IBox.sol\";\nimport {MorphoVaultV1Adapter} from \"@vault-v2/src/adapters/MorphoVaultV1Adapter.sol\";\nimport {MorphoMarketV1Adapter} from \"@vault-v2/src/adapters/MorphoMarketV1Adapter.sol\";\nimport {MorphoVaultV1AdapterLib} from \"../src/periphery/MorphoVaultV1AdapterLib.sol\";\nimport {VaultV2Lib} from \"../src/periphery/VaultV2Lib.sol\";\nimport {BoxLib} from \"../src/periphery/BoxLib.sol\";\nimport {FundingMorpho} from \"../src/FundingMorpho.sol\";\nimport {VaultV2} from \"@vault-v2/src/VaultV2.sol\";\nimport {BoxAdapterFactory} from \"../src/factories/BoxAdapterFactory.sol\";\nimport {BoxAdapterCachedFactory} from \"../src/factories/BoxAdapterCachedFactory.sol\";\nimport {FundingMorphoFactory} from \"../src/factories/FundingMorphoFactory.sol\";\nimport {FundingAaveFactory} from \"../src/factories/FundingAaveFactory.sol\";\nimport {FlashLoanMorpho} from \"../src/periphery/FlashLoanMorpho.sol\";\nimport \"@vault-v2/src/libraries/ConstantsLib.sol\";\nimport {ISwapper} from \"../src/interfaces/ISwapper.sol\";\nimport {FlashLoanMorpho} from \"../src/periphery/FlashLoanMorpho.sol\";\nimport {Box} from \"../src/Box.sol\";\n\n///@dev This script deploys the necessary contracts for the Peaty product on Base.\n///@dev Default factories are hardcoded, but can be overridden using run() which will deploy fresh contracts.\ncontract DeployEthereumScript is Script {\n    using BoxLib for IBox;\n    using VaultV2Lib for VaultV2;\n    using MorphoVaultV1AdapterLib for MorphoVaultV1Adapter;\n\n    VaultV2Factory vaultV2Factory = VaultV2Factory(0xA1D94F746dEfa1928926b84fB2596c06926C0405);\n    MorphoVaultV1AdapterFactory mv1AdapterFactory = MorphoVaultV1AdapterFactory(0xD1B8E2dee25c2b89DCD2f98448a7ce87d6F63394);\n    MorphoMarketV1AdapterFactory mm1AdapterFactory = MorphoMarketV1AdapterFactory(0xb049465969ac6355127cDf9E88deE63d25204d5D);\n\n    BoxFactory boxFactory = BoxFactory(0xA1eD8959EF9cCbd57C6b1362938E1DAee96f4473);\n    BoxAdapterFactory boxAdapterFactory = BoxAdapterFactory(0x767fa3827d7aA8F69C937689C5ab09412FFc1a2A);\n    BoxAdapterCachedFactory boxAdapterCachedFactory = BoxAdapterCachedFactory(0xb5d69fE3149ba4549f5234851d9DaAb83A3c2bE9);\n    FundingMorphoFactory fundingMorphoFactory = FundingMorphoFactory(address(0));\n    FundingAaveFactory fundingAaveFactory = FundingAaveFactory(address(0));\n\n    address owner = address(0x0000aeB716a0DF7A9A1AAd119b772644Bc089dA8);\n    address curator = address(0x0000aeB716a0DF7A9A1AAd119b772644Bc089dA8);\n    address guardian = address(0x0000aeB716a0DF7A9A1AAd119b772644Bc089dA8);\n    address allocator1 = address(0x0000aeB716a0DF7A9A1AAd119b772644Bc089dA8);\n    address allocator2 = address(0xfeed46c11F57B7126a773EeC6ae9cA7aE1C03C9a);\n\n    IERC20 usdc = IERC20(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48);\n\n    // Ethena\n    IERC20 ptsusde25sep = IERC20(0x9F56094C450763769BA0EA9Fe2876070c0fD5F77);\n    IOracle ptsusde25sepOracle = IOracle(0x5139aa359F7F7FdE869305e8C7AD001B28E1C99a);\n\n    IERC20 ptusde25sep = IERC20(0xBC6736d346a5eBC0dEbc997397912CD9b8FAe10a);\n    IOracle ptusde25sepOracle = IOracle(0xe6aBD3B78Abbb1cc1Ee76c5c3689Aa9646481Fbb);\n\n    IERC20 ptsusde27nov = IERC20(0xe6A934089BBEe34F832060CE98848359883749B3);\n    IOracle ptsusde27novOracle = IOracle(0x639c6f403822E1bDA434BEb2034Beb54f725BA0c);\n\n    IERC20 ptusde27nov = IERC20(0x62C6E813b9589C3631Ba0Cdb013acdB8544038B7);\n    IOracle ptusde27novOracle = IOracle(0x0beC5A0f7Bea1D14efC2663054D6D1E2B764b630);\n\n    IERC20 usde = IERC20(0x4c9EDD5852cd905f086C759E8383e09bff1E68B3);\n    IOracle usdeOracle = IOracle(0x6779b2F08611906FcE70c70c596e05859701235d);\n\n    IERC20 susde = IERC20(0x9D39A5DE30e57443BfF2A8307A4256c8797A3497);\n    IOracle susdeOracle = IOracle(0x873CD44b860DEDFe139f93e12A4AcCa0926Ffb87);\n\n    // Reservoir\n    IERC20 ptwsrusd30oct = IERC20(0x10a099BAf814B5FDa138c4e6b60eD42c0d975be8);\n    IOracle ptwsrusd30octOracle = IOracle(0x211Cd125045A395c7054D132F3aC53e21D9A2C25);\n\n    IERC20 wsrusd = IERC20(0xd3fD63209FA2D55B07A0f6db36C2f43900be3094);\n    IOracle wsrusdOracle = IOracle(0x938D2eDb20425cF80F008E7ec314Eb456940Da15);\n\n    // Coinshift\n    IERC20 ptcusdl30oct = IERC20(0xDBf6feC5A012A13c456Bac3B67C3B9CF2830A122);\n    IOracle ptcusdl30octOracle = IOracle(0x82dBE10a7D516D8F8b532570134faA81eA63FC51);\n\n    // cUSDO\n    IERC20 ptcusdo20nov = IERC20(0xB10DA2F9147f9cf2B8826877Cd0c95c18A0f42dc);\n    IOracle ptcusdo20novOracle = IOracle(0x0dF910a47452B995F545D66eb135f38D0FbB142E);\n\n    IMorpho morpho = IMorpho(0xBBBBBbbBBb9cC5e90e3b3Af64bdAF62C37EEFFCb);\n    IMetaMorpho bbqusdc = IMetaMorpho(0xBEeFFF209270748ddd194831b3fa287a5386f5bC);\n\n    ISwapper swapper = ISwapper(0x732ca7E5b02f3E9Fe8D5CA7B17B1D1ea47A57A1B);\n    FlashLoanMorpho flashLoanMorpho = FlashLoanMorpho(address(0));\n\n    ///@dev This script deploys the necessary contracts for the Peaty product on Base.\n    function run() public {\n        boxFactory = deployBoxFactory();\n        boxAdapterFactory = deployBoxAdapterFactory();\n        boxAdapterCachedFactory = deployBoxAdapterCachedFactory();\n    }\n\n    function deployBoxFactory() public returns (BoxFactory) {\n        vm.startBroadcast();\n        BoxFactory boxFactory_ = new BoxFactory();\n        console.log(\"BoxFactory deployed at:\", address(boxFactory_));\n        new Box(address(usdc), address(1), address(1), \"test\", \"test\", 1, 1, 1, 1); // Just for basescan to have the source code\n        vm.stopBroadcast();\n        return boxFactory_;\n    }\n\n    function deployBoxAdapterFactory() public returns (BoxAdapterFactory) {\n        vm.startBroadcast();\n        BoxAdapterFactory boxAdapterFactory_ = new BoxAdapterFactory();\n        console.log(\"BoxAdapterFactory deployed at:\", address(boxAdapterFactory_));\n        vm.stopBroadcast();\n        return boxAdapterFactory_;\n    }\n\n    function deployBoxAdapterCachedFactory() public returns (BoxAdapterCachedFactory) {\n        vm.startBroadcast();\n        BoxAdapterCachedFactory boxAdapterCachedFactory_ = new BoxAdapterCachedFactory();\n        console.log(\"BoxAdapterCachedFactory deployed at:\", address(boxAdapterCachedFactory_));\n        vm.stopBroadcast();\n        return boxAdapterCachedFactory_;\n    }\n\n    function deployFlashLoanMorpho() public {\n        vm.startBroadcast();\n        FlashLoanMorpho flm = new FlashLoanMorpho(address(morpho));\n        console.log(\"FlashLoanMorpho deployed at:\", address(flm));\n        vm.stopBroadcast();\n    }\n\n    function addMarketsToAdapterFromVault(VaultV2 vault, MorphoMarketV1Adapter mm1Adapter, IMetaMorpho vaultv1) public {\n        uint256 length = vaultv1.withdrawQueueLength();\n        vault.addCollateralInstant(\n            address(mm1Adapter),\n            abi.encode(\"this\", address(mm1Adapter)),\n            1_000_000_000 * 10 ** 6, // 1_000_000_000 USDC absolute cap\n            1 ether // 100% relative cap\n        );\n        for (uint256 i = 0; i < length; i++) {\n            Id id = Id.wrap(MetaId.unwrap(vaultv1.withdrawQueue(i)));\n            MarketParams memory marketParams = morpho.idToMarketParams(id);\n            // We skip Idle markets\n            if (marketParams.collateralToken != address(0)) {\n                continue;\n            }\n            vault.addCollateralInstant(\n                address(mm1Adapter),\n                abi.encode(\"collateralToken\", marketParams.collateralToken),\n                100_000_000 * 10 ** 6, // 100_000_000 USDC absolute cap\n                1 ether // 100% relative cap\n            );\n            vault.addCollateralInstant(\n                address(mm1Adapter),\n                abi.encode(\"this/marketParams\", address(mm1Adapter), marketParams),\n                100_000_000 * 10 ** 6, // 100_000_000 USDC absolute cap\n                1 ether // 100% relative cap\n            );\n        }\n    }\n\n    function deployPeaty() public returns (IVaultV2) {\n        vm.startBroadcast();\n\n        bytes32 salt = \"42\";\n\n        VaultV2 vault = VaultV2(vaultV2Factory.createVaultV2(address(tx.origin), address(usdc), salt));\n        console.log(\"Peaty deployed at:\", address(vault));\n\n        vault.setCurator(address(tx.origin));\n\n        vault.addAllocatorInstant(address(tx.origin));\n        vault.addAllocatorInstant(address(allocator1));\n        vault.addAllocatorInstant(address(allocator2));\n\n        vault.setName(\"Peaty USDC\");\n        vault.setSymbol(\"ptUSDC\");\n\n        vault.setMaxRate(MAX_MAX_RATE);\n\n        address adapterMV1 = mv1AdapterFactory.createMorphoVaultV1Adapter(address(vault), address(bbqusdc));\n        console.log(\"MorphoVaultV1Adapter deployed at:\", adapterMV1);\n\n        vault.addCollateralInstant(\n            adapterMV1,\n            abi.encode(\"this\", adapterMV1),\n            1_000_000_000 * 10 ** 6, // 1_000_000_000 USDC absolute cap\n            1 ether // 100% relative cap\n        );\n\n        // Creating Box which will invest in Ethena ecosystem\n        string memory name = \"Box Ethena\";\n        string memory symbol = \"BOX_ETHENA\";\n        uint256 maxSlippage = 0.0025 ether; // 0.25%\n        uint256 slippageEpochDuration = 7 days;\n        uint256 shutdownSlippageDuration = 10 days;\n        uint256 shutdownWarmup = 7 days;\n        IBox box = boxFactory.createBox(\n            usdc,\n            address(tx.origin),\n            address(tx.origin),\n            name,\n            symbol,\n            maxSlippage,\n            slippageEpochDuration,\n            shutdownSlippageDuration,\n            shutdownWarmup,\n            salt\n        );\n        console.log(\"Box Ethena deployed at:\", address(box));\n        // Creating the ERC4626 adapter between the vault and box\n        IBoxAdapter adapter = boxAdapterFactory.createBoxAdapter(address(vault), box);\n\n        box.addTokenInstant(ptsusde25sep, ptsusde25sepOracle);\n        box.addTokenInstant(ptusde25sep, ptusde25sepOracle);\n        box.addTokenInstant(ptsusde27nov, ptsusde27novOracle);\n        box.addTokenInstant(ptusde27nov, ptusde27novOracle);\n        box.addTokenInstant(usde, usdeOracle);\n        box.addTokenInstant(susde, susdeOracle);\n\n        box.abdicateTimelock(box.addFunding.selector);\n\n        box.setIsAllocator(address(allocator1), true);\n        box.setIsAllocator(address(allocator2), true);\n        box.addFeederInstant(address(adapter));\n        box.setCurator(address(curator));\n        box.transferOwnership(address(owner));\n        vault.addCollateralInstant(address(adapter), adapter.adapterData(), 100_000_000 * 10 ** 6, 0.9 ether); // 1,000,000 USDC absolute cap and 90% relative cap\n        vault.setForceDeallocatePenaltyInstant(address(adapter), 0.0 ether); // 0% penalty\n\n        IBox boxEthena = box;\n        address boxEthenaAdapter = address(adapter);\n\n        // Creating Box which will invest in Reservoir ecosystem\n        name = \"Box Reservoir\";\n        symbol = \"BOX_RESERVOIR\";\n        maxSlippage = 0.0025 ether; // 0.25%\n        slippageEpochDuration = 7 days;\n        shutdownSlippageDuration = 10 days;\n        shutdownWarmup = 7 days;\n        box = boxFactory.createBox(\n            usdc,\n            address(tx.origin),\n            address(tx.origin),\n            name,\n            symbol,\n            maxSlippage,\n            slippageEpochDuration,\n            shutdownSlippageDuration,\n            shutdownWarmup,\n            salt\n        );\n        console.log(\"Box Reservoir deployed at:\", address(box));\n        // Creating the ERC4626 adapter between the vault and box2\n        adapter = boxAdapterFactory.createBoxAdapter(address(vault), box);\n\n        // Allow box 2 to invest in PT-WSR-USD-30OCT\n        box.addTokenInstant(ptwsrusd30oct, ptwsrusd30octOracle);\n        box.addTokenInstant(wsrusd, wsrusdOracle);\n        box.abdicateTimelock(box.addFunding.selector);\n\n        box.setIsAllocator(address(allocator1), true);\n        box.setIsAllocator(address(allocator2), true);\n        box.addFeederInstant(address(adapter));\n        box.setCurator(address(curator));\n        box.transferOwnership(address(owner));\n        vault.addCollateralInstant(address(adapter), adapter.adapterData(), 100_000_000 * 10 ** 6, 0.9 ether); // 1,000,000 USDC absolute cap and 90% relative cap\n        vault.setForceDeallocatePenaltyInstant(address(adapter), 0.0 ether); // 0% penalty\n\n        IBox boxReservoir = box;\n        address boxReservoirAdapter = address(adapter);\n\n        // Creating Box which will invest in csUSDL ecosystem\n        name = \"Box csUSDL\";\n        symbol = \"BOX_CSUSDL\";\n        maxSlippage = 0.0025 ether; // 0.25%\n        slippageEpochDuration = 7 days;\n        shutdownSlippageDuration = 10 days;\n        shutdownWarmup = 7 days;\n        box = boxFactory.createBox(\n            usdc,\n            address(tx.origin),\n            address(tx.origin),\n            name,\n            symbol,\n            maxSlippage,\n            slippageEpochDuration,\n            shutdownSlippageDuration,\n            shutdownWarmup,\n            salt\n        );\n        console.log(\"Box csUSDL deployed at:\", address(box));\n        // Creating the ERC4626 adapter between the vault and box2\n        adapter = boxAdapterFactory.createBoxAdapter(address(vault), box);\n\n        // Allow box 2 to invest in PT-CUSDL-30OCT\n        box.addTokenInstant(ptcusdl30oct, ptcusdl30octOracle);\n        box.abdicateTimelock(box.addFunding.selector);\n\n        box.setIsAllocator(address(allocator1), true);\n        box.setIsAllocator(address(allocator2), true);\n        box.addFeederInstant(address(adapter));\n        box.setCurator(address(curator));\n        box.transferOwnership(address(owner));\n        vault.addCollateralInstant(address(adapter), adapter.adapterData(), 100_000_000 * 10 ** 6, 0.9 ether); // 1,000,000 USDC absolute cap and 90% relative cap\n        vault.setForceDeallocatePenaltyInstant(address(adapter), 0.0 ether); // 0% penalty\n\n        IBox boxCoinshift = box;\n        address boxCoinshiftAdapter = address(adapter);\n\n        // Creating Box which will invest in cUSDO ecosystem\n        name = \"Box cUSDO\";\n        symbol = \"BOX_CUSDO\";\n        maxSlippage = 0.0025 ether; // 0.25%\n        slippageEpochDuration = 7 days;\n        shutdownSlippageDuration = 10 days;\n        shutdownWarmup = 7 days;\n        box = boxFactory.createBox(\n            usdc,\n            address(tx.origin),\n            address(tx.origin),\n            name,\n            symbol,\n            maxSlippage,\n            slippageEpochDuration,\n            shutdownSlippageDuration,\n            shutdownWarmup,\n            salt\n        );\n        console.log(\"Box cUSDO deployed at:\", address(box));\n        // Creating the ERC4626 adapter between the vault and box2\n        adapter = boxAdapterFactory.createBoxAdapter(address(vault), box);\n\n        // Allow box 2 to invest in PT-CUSDO-20NOV\n        box.addTokenInstant(ptcusdo20nov, ptcusdo20novOracle);\n        box.abdicateTimelock(box.addFunding.selector);\n\n        box.setIsAllocator(address(allocator1), true);\n        box.setIsAllocator(address(allocator2), true);\n        box.addFeederInstant(address(adapter));\n        box.setCurator(address(curator));\n        box.transferOwnership(address(owner));\n        vault.addCollateralInstant(address(adapter), adapter.adapterData(), 100_000_000 * 10 ** 6, 0.9 ether); // 1,000,000 USDC absolute cap and 90% relative cap\n        vault.setForceDeallocatePenaltyInstant(address(adapter), 0.0 ether); // 0% penalty\n\n        IBox boxUSDO = box;\n        address boxUSDOAdapter = address(adapter);\n\n        //========== Seeding some USDC to the vault for testing ==========\n        usdc.approve(address(vault), 10 * 10 ** 6);\n        vault.deposit(10 * 10 ** 6, address(vault));\n\n        vault.allocate(adapterMV1, \"\", 1 * 10 ** 6);\n\n        vault.allocate(boxEthenaAdapter, \"\", 2 * 10 ** 6);\n        boxEthena.allocate(ptusde25sep, 1.6 * 10 ** 6, swapper, \"\");\n        boxEthena.allocate(ptsusde25sep, 0.2 * 10 ** 6, swapper, \"\");\n        boxEthena.allocate(ptusde27nov, 0.1 * 10 ** 6, swapper, \"\");\n        boxEthena.allocate(ptsusde27nov, 0.1 * 10 ** 6, swapper, \"\");\n\n        vault.allocate(boxReservoirAdapter, \"\", 2 * 10 ** 6);\n        boxReservoir.allocate(ptwsrusd30oct, 1.9 * 10 ** 6, swapper, \"\");\n        boxReservoir.allocate(wsrusd, 0.1 * 10 ** 6, swapper, \"\");\n\n        vault.allocate(boxCoinshiftAdapter, \"\", 1 * 10 ** 6);\n        boxCoinshift.allocate(ptcusdl30oct, 1 * 10 ** 6, swapper, \"\");\n\n        vault.allocate(boxUSDOAdapter, \"\", 2 * 10 ** 6);\n        boxUSDO.allocate(ptcusdo20nov, 2 * 10 ** 6, swapper, \"\");\n\n        //========== Preprod settings ==========\n        vault.setCurator(address(curator));\n        vault.setOwner(address(owner));\n\n        // To fail the script\n        // boxEthena.abdicateTimelock(Box.setGuardian.selector);\n\n        vm.stopBroadcast();\n        return vault;\n    }\n}\n"
    }
}