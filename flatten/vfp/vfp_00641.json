{
    "vfp_id": "vfp_00641",
    "project_name": "2025-08-starkware-starkex-diff-review-securityreview.pdf",
    "findings": [
        {
            "id": 0,
            "category": {
                "1": [
                    "CWE-435"
                ],
                "2": [
                    "CWE-439"
                ]
            },
            "title": "Change of program output offsets breaks compatibility with old programs",
            "description": "1. **Description:** The structure of data and offsets in the program output was modified by introducing a new field for the data availability mode at offset 1, which shifts all subsequent fields by one position. This change renders old program outputs incompatible with the new contract version.\n2. **Cause:** The root cause is the insertion of a new field at the beginning of the data structure instead of appending it, which breaks backward compatibility. As a result, previously valid program outputs are now misinterpretedâ€”specifically, the old N_ASSET_CONFIGS field is now read as DATA_AVAILABILITY_MODE.\n3. **Exploitation:** An attacker or malfunctioning operator could submit legacy program outputs that are now incorrectly parsed, potentially leading to state corruption or failed state updates if the system attempts to process outdated formats.\n4. **Impact:** The primary impact is a breaking change that prevents interoperability with older versions of the system, requiring all operators to upgrade and strictly adhere to the new output format. This could lead to operational failures or delays during the transition period.\n",
            "severity": "Informational",
            "location": [
                "scalable-dex/contracts/src/perpetual/ProgramOutputOffsets.sol"
            ],
            "files": [
                "starkex-contracts/scalable-dex/contracts/src/perpetual/ProgramOutputOffsets.sol"
            ]
        }
    ],
    "affected_files": {
        "ProgramOutputOffsets.sol": "// SPDX-License-Identifier: Apache-2.0.\npragma solidity ^0.6.12;\n\ncontract ProgramOutputOffsets {\n    // The following constants are offsets of data expected in the program output.\n    // The offsets here are of the fixed fields.\n    uint256 internal constant PROG_OUT_GENERAL_CONFIG_HASH = 0;\n    uint256 internal constant PROG_OUT_DATA_AVAILABILTY_MODE = 1;\n    uint256 internal constant PROG_OUT_N_ASSET_CONFIGS = 2;\n    uint256 internal constant PROG_OUT_ASSET_CONFIG_HASHES = 3;\n\n    /*\n      Additional mandatory fields of a single word:\n      - Previous state size         3\n      - New state size              4\n      - Vault tree height           5\n      - Order tree height           6\n      - Expiration timestamp        7\n      - No. of Modifications        8.\n    */\n    uint256 internal constant PROG_OUT_N_WORDS_MIN_SIZE = 9;\n\n    uint256 internal constant PROG_OUT_N_WORDS_PER_ASSET_CONFIG = 2;\n    uint256 internal constant PROG_OUT_N_WORDS_PER_MODIFICATION = 3;\n\n    uint256 internal constant ASSET_CONFIG_OFFSET_ASSET_ID = 0;\n    uint256 internal constant ASSET_CONFIG_OFFSET_CONFIG_HASH = 1;\n\n    uint256 internal constant MODIFICATIONS_OFFSET_STARKKEY = 0;\n    uint256 internal constant MODIFICATIONS_OFFSET_POS_ID = 1;\n    uint256 internal constant MODIFICATIONS_OFFSET_BIASED_DIFF = 2;\n\n    uint256 internal constant STATE_OFFSET_VAULTS_ROOT = 0;\n    uint256 internal constant STATE_OFFSET_VAULTS_HEIGHT = 1;\n    uint256 internal constant STATE_OFFSET_ORDERS_ROOT = 2;\n    uint256 internal constant STATE_OFFSET_ORDERS_HEIGHT = 3;\n    uint256 internal constant STATE_OFFSET_N_FUNDING = 4;\n    uint256 internal constant STATE_OFFSET_FUNDING = 5;\n\n    // Data availability mode.\n    uint256 internal constant VALIDIUM_MODE = 0;\n    uint256 internal constant ROLLUP_MODE = 1;\n\n    // The following constants are offsets of data expected in the application data.\n    uint256 internal constant APP_DATA_BATCH_ID_OFFSET = 0;\n    uint256 internal constant APP_DATA_PREVIOUS_BATCH_ID_OFFSET = 1;\n    uint256 internal constant APP_DATA_N_CONDITIONAL_TRANSFER = 2;\n    uint256 internal constant APP_DATA_CONDITIONAL_TRANSFER_DATA_OFFSET = 3;\n    uint256 internal constant APP_DATA_N_WORDS_PER_CONDITIONAL_TRANSFER = 2;\n}\n"
    }
}