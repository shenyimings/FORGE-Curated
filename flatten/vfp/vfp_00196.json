{
    "vfp_id": "vfp_00196",
    "project_name": "2025-03-offchain-custom-fee-erc20-bridge-securityreview.pdf",
    "findings": [
        {
            "id": 0,
            "category": {
                "1": [
                    "CWE-691"
                ],
                "2": [
                    "CWE-841"
                ]
            },
            "title": "An invalid upgrade for non-BoLD rollup is possible",
            "description": "1. **Description:** The Orbit action allows an invalid upgrade path from version 3.x.x to 2.2.3, which constitutes a downgrade rather than a valid upgrade. This could lead to undefined behavior or loss of expected functionality in the upgraded contracts.\n2. **Cause:** The vulnerability arises because the upgrade logic checks for versions below 2.x.x using the presence of the `nativeTokenDecimals` function, but it does not verify that the current version is not already above 2.2.3 (e.g., 3.x.x). Since the function exists in later versions, the check passes even when downgrading.\n3. **Exploitation:** An attacker or misconfigured user could invoke the upgrade action on a contract already at version 3.x.x, causing it to be downgraded to 2.2.3. This would revert any improvements or fixes present in the newer version.\n4. **Impact:** The impact includes potential disruption of contract functionality, incorrect state transitions, and possible financial loss if critical logic changes between versions are reverted. While not directly leading to fund theft, it introduces operational risk and undefined behavior.\n",
            "severity": "Informational",
            "location": [
                "NitroContracts2Point1Point3UpgradeAction.sol"
            ],
            "files": [
                "f4f878e101e54170080532ad3ba6e70dab56a2b9/orbit-actions/contracts/parent-chain/contract-upgrades/NitroContracts2Point1Point3UpgradeAction.sol"
            ]
        }
    ],
    "affected_files": {
        "NitroContracts2Point1Point3UpgradeAction.sol": "// SPDX-License-Identifier: Apache-2.0\npragma solidity 0.8.16;\n\nimport {ProxyAdmin} from \"@openzeppelin/contracts/proxy/transparent/ProxyAdmin.sol\";\nimport {TransparentUpgradeableProxy} from \"@openzeppelin/contracts/proxy/transparent/TransparentUpgradeableProxy.sol\";\nimport {Address} from \"@openzeppelin/contracts/utils/Address.sol\";\n\ninterface IInbox {\n    function bridge() external view returns (address);\n    function sequencerInbox() external view returns (address);\n}\n\ninterface IERC20Bridge {\n    function nativeToken() external view returns (address);\n}\n\ninterface IERC20Bridge_v2 {\n    function nativeTokenDecimals() external view returns (uint8);\n}\n\n/**\n * @title   NitroContracts2Point1Point3UpgradeAction\n * @notice  Upgrade the bridge to Inbox and SequencerInbox to v2.1.3\n *          Will revert if the bridge is an ERC20Bridge below v2.x.x\n */\ncontract NitroContracts2Point1Point3UpgradeAction {\n    address public immutable newEthInboxImpl;\n    address public immutable newERC20InboxImpl;\n    address public immutable newSequencerInboxImpl;\n\n    constructor(address _newEthInboxImpl, address _newERC20InboxImpl, address _newSequencerInboxImpl) {\n        require(\n            Address.isContract(_newEthInboxImpl),\n            \"NitroContracts2Point1Point3UpgradeAction: _newEthInboxImpl is not a contract\"\n        );\n        require(\n            Address.isContract(_newERC20InboxImpl),\n            \"NitroContracts2Point1Point3UpgradeAction: _newERC20InboxImpl is not a contract\"\n        );\n        require(\n            Address.isContract(_newSequencerInboxImpl),\n            \"NitroContracts2Point1Point3UpgradeAction: _newSequencerInboxImpl is not a contract\"\n        );\n\n        newEthInboxImpl = _newEthInboxImpl;\n        newERC20InboxImpl = _newERC20InboxImpl;\n        newSequencerInboxImpl = _newSequencerInboxImpl;\n    }\n\n    function perform(address inbox, ProxyAdmin proxyAdmin) external {\n        address bridge = IInbox(inbox).bridge();\n        address sequencerInbox = IInbox(inbox).sequencerInbox();\n\n        bool isERC20 = false;\n\n        // if the bridge is an ERC20Bridge below v2.x.x, revert\n        try IERC20Bridge(bridge).nativeToken() returns (address) {}\n        catch {\n            isERC20 = true;\n            // it is an ERC20Bridge, check if it is on v2.x.x\n            try IERC20Bridge_v2(address(bridge)).nativeTokenDecimals() returns (uint8) {}\n            catch {\n                // it is not on v2.x.x, revert\n                revert(\"NitroContracts2Point1Point3UpgradeAction: bridge is an ERC20Bridge below v2.x.x\");\n            }\n        }\n\n        // upgrade the sequencer inbox\n        proxyAdmin.upgrade({\n            proxy: TransparentUpgradeableProxy(payable((sequencerInbox))),\n            implementation: newSequencerInboxImpl\n        });\n\n        // upgrade the inbox\n        proxyAdmin.upgrade({\n            proxy: TransparentUpgradeableProxy(payable((inbox))),\n            implementation: isERC20 ? newERC20InboxImpl : newEthInboxImpl\n        });\n    }\n}\n"
    }
}