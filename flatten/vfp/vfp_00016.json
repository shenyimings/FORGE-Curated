{
    "vfp_id": "vfp_00016",
    "project_name": "cantina_level_money_february2025.pdf",
    "findings": [
        {
            "id": 1,
            "category": {
                "1": [
                    "CWE-693"
                ],
                "2": [
                    "CWE-182"
                ]
            },
            "title": "Implications of defaulting to $1 for Oracle Pricing",
            "description": "The oracle defaults to a price of $1 (1e18) when it is paused by the PAUSER address or otherwise fails. This behavior is intended to protect borrowers by maintaining collateral valuations during outages. The root cause is a design choice in the oracle logic to default to a fixed value instead of reverting or using alternative data sources. While this protects borrowers, it disadvantages lenders if the true market price is below $1, as liquidations may not occur appropriately. An attacker could exploit governance or PAUSER privileges to pause the oracle at an inopportune time, leading to unfair liquidation outcomes. The impact is informational, as the behavior is intentional but should be clearly communicated to users.\n",
            "severity": "Informational",
            "location": [],
            "files": [
                "contracts/src/lens/LevelReserveLensChainlinkOracle.sol"
            ]
        }
    ],
    "affected_files": {
        "LevelReserveLensChainlinkOracle.sol": "// SPDX-License-Identifier: BUSL-1.1\npragma solidity >=0.8.21;\n\nimport {ILevelReserveLensChainlinkOracle} from \"../interfaces/lens/ILevelReserveLensChainlinkOracle.sol\";\nimport {ILevelReserveLens} from \"../interfaces/lens/ILevelReserveLens.sol\";\nimport {SingleAdminAccessControl} from \"../auth/v5/SingleAdminAccessControl.sol\";\n\nimport {Pausable} from \"@openzeppelin/contracts/utils/Pausable.sol\";\n\nimport {SafeCast} from \"@openzeppelin/contracts/utils/math/SafeCast.sol\";\nimport {Math} from \"@openzeppelin/contracts/utils/math/Math.sol\";\n\n/**\n *                                     .-==+=======+:\n *                                      :---=-::-==:\n *                                      .-:-==-:-==:\n *                    .:::--::::::.     .--:-=--:--.       .:--:::--..\n *                   .=++=++:::::..     .:::---::--.    ....::...:::.\n *                    :::-::..::..      .::::-:::::.     ...::...:::.\n *                    ...::..::::..     .::::--::-:.    ....::...:::..\n *                    ............      ....:::..::.    ------:......\n *    ...........     ........:....     .....::..:..    ======-......      ...........\n *    :------:.:...   ...:+***++*#+     .------:---.    ...::::.:::...   .....:-----::.\n *    .::::::::-:..   .::--..:-::..    .-=+===++=-==:   ...:::..:--:..   .:==+=++++++*:\n *\n * @title LevelReserveLensChainlinkOracle\n * @author Level (https://level.money)\n * @notice The LevelReserveLensChainlinkOracle contract is a thin wrapper around LevelReserveLens that implements the Chainlink AggregatorV3Interface.\n */\ncontract LevelReserveLensChainlinkOracle is ILevelReserveLensChainlinkOracle, SingleAdminAccessControl, Pausable {\n    using Math for uint256;\n    using SafeCast for uint256;\n\n    bytes32 public constant PAUSER_ROLE = keccak256(\"PAUSER_ROLE\");\n\n    ILevelReserveLens public immutable lens;\n\n    /**\n     * @param _lens The address of the LevelReserveLens contract.\n     * @param _admin The address of the admin.\n     * @param _pauser The address of the pauser.\n     */\n    constructor(address _admin, address _pauser, address _lens) {\n        if (_lens == address(0) || _admin == address(0)) revert(\"Address cannot be zero\");\n\n        lens = ILevelReserveLens(_lens);\n\n        _grantRole(DEFAULT_ADMIN_ROLE, _admin);\n\n        if (_pauser != address(0)) {\n            _grantRole(PAUSER_ROLE, _pauser);\n        }\n    }\n\n    /**\n     * @dev Returns the number of decimals; use Chainlink's default for USD pairs.\n     * @return decimals The number of decimals.\n     */\n    function decimals() public pure override returns (uint8) {\n        return 8;\n    }\n\n    /**\n     * @dev Returns a short description of the aggregator.\n     * @return description A description of the aggregator.\n     */\n    function description() external pure override returns (string memory) {\n        return \"Chainlink interface compliant oracle for Level USD\";\n    }\n\n    /**\n     * @dev Returns the version of the interface; hard-coded to 0.\n     * @return version The version of the interface.\n     */\n    function version() external pure override returns (uint256) {\n        return 0;\n    }\n\n    /**\n     * @inheritdoc ILevelReserveLensChainlinkOracle\n     */\n    function setPaused(bool _paused) external onlyRole(PAUSER_ROLE) {\n        if (_paused) {\n            _pause();\n        } else {\n            _unpause();\n        }\n    }\n\n    /**\n     * @dev Returns a default price of $1 (1e18). Intended to be used when the oracle cannot fetch the price from the lens contract, or if the contract is paused.\n     */\n    function defaultRoundData()\n        public\n        view\n        returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound)\n    {\n        return (0, int256(10 ** decimals()), block.timestamp, block.timestamp, 0);\n    }\n\n    /**\n     * @dev Returns the latest round data (since this oracle does not require data to be pushed). See latestRoundData for more details.\n     */\n    function getRoundData(uint80 /* _roundId */ )\n        external\n        view\n        override\n        returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound)\n    {\n        return this.latestRoundData();\n    }\n\n    /**\n     * @dev Returns the price of lvlUSD. This function should always return some value.\n     * @dev Invariants: answer > 0, answer <= this.decimals()\n     * @return roundId non-meaningful value\n     * @return answer The price of lvlUSD, where 1e18 means 1 USD. Returns $1 (1e18) if the reserves are overcollateralized, if the contract is paused, or the underlying lens contract reverts. Otherwise, returns the ratio of USD reserves to lvlUSD supply.\n     * @return startedAt non-meaningful value\n     * @return updatedAt the timestamp of the current block\n     * @return answeredInRound non-meaningful value\n     */\n    function latestRoundData()\n        external\n        view\n        override\n        returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound)\n    {\n        if (paused()) {\n            return defaultRoundData();\n        }\n\n        (bool reservePriceSuccess, bytes memory reservePriceData) =\n            address(lens).staticcall(abi.encodeWithSignature(\"getReservePrice()\"));\n        (bool reserveDecimalsSuccess, bytes memory reserveDecimalsData) =\n            address(lens).staticcall(abi.encodeWithSignature(\"getReservePriceDecimals()\"));\n\n        if (!reservePriceSuccess || !reserveDecimalsSuccess) {\n            return defaultRoundData();\n        }\n\n        // Decode the returned value\n        uint256 reservePrice = abi.decode(reservePriceData, (uint256));\n        uint8 reserveDecimals = abi.decode(reserveDecimalsData, (uint8));\n\n        answer = int256(reservePrice.mulDiv(10 ** decimals(), 10 ** reserveDecimals, Math.Rounding.Ceil));\n        return (0, answer, block.timestamp, block.timestamp, 0);\n    }\n}\n"
    }
}