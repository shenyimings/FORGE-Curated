// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.26;

import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import {IntegrationTestBase} from "../IntegrationTestBase.t.sol";
import {IVeloraAdapter} from "src/interfaces/periphery/IVeloraAdapter.sol";
import {VeloraAdapter} from "src/periphery/VeloraAdapter.sol";

contract VeloraAdapterForkTest is IntegrationTestBase {
    uint256 outputAmountOffset = 132;
    uint256 maxInputAmountOffset = 100;
    uint256 quotedInputAmountOffset = 164;

    function testFork_buy_WithAdjustment() public {
        // Receiver on calldata is the VeloraAdapter
        // Exact output swap to 1 WETH from USDC
        bytes memory buyCalldata =
            hex"7f4576750000000000000000000000000e5891850bb3f03090f03010000806f080040100000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000042000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000110ffa6880000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000110ffa68800485a84a6d14423ae944d420c400f630000000000000000000000000211e5160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011e0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000012000000016000000000000000000000008c000000000000006c000000000000019076578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef80000000000000000000000008c644e586252fc0f77bf933bb3e2ca3a59a24a4e000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000008e1bc9bf040000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000008c000000000000006c000000000000019076578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef800000000000000000000000048bee101ebbd0cdf9ab398e464eae4677317a149000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000008e1bc9bf040000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000028000000000000000000000022c000000000000010c00000000000000c885a80afee867adf27b50bdb7b76da70f1e85306202600124010401e40000000b000000000000000000000000000000000000000000000000000000008eb1b65e0000000000000000000000000000000000000000000000000000000000000080ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000575c55000000000000000000000000000000000000000000000000000470de4df8200000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000c768c589647798a6ee01a91fde98ef2ed046dbd6000000000000000000000000c768c589647798a6ee01a91fde98ef2ed046dbd60000000000000000000000000000000000000000000000000000000000000001000000000000000000000000ec3fc48038bb7cdaca1f7ab7590c5e1a45f7a4c30000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000008c000000000000006c00000000000000c876578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef80000000000000000000000007f0852cd8380e6cb88e91f817ebc8dc9ac163d93000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000470de4df820000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000008c000000000000006c000000000000019076578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef800000000000000000000000083817734f5b62b68985d994b9d8e9364c6c35f60000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000008e1bc9bf040000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000008c000000000000006c000000000000032076578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef8000000000000000000000000a3f21dd38a0e734cb079a42340c2598f63225b04000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000011c37937e080000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000008c000000000000006c000000000000025876578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef8000000000000000000000000b4d2d1f24064f21531eee256c42a1dfa98214e74000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000d529ae9e860000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000008c000000000000006c000000000000032076578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef80000000000000000000000003b3ef4a7c1ac118848777bbe6d7413f41775c5a7000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000011c37937e080000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000008c000000000000006c000000000000032076578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef800000000000000000000000088c044fb203b58b12252be7242926b1eeb113b4a000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000011c37937e080000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000120000000000000013700000000000013881b81d678ffb9c0263b24a97847620c99d213eb140140008400a400d80000000b00000000000000000000000000000000000000000000000000000000f28c0498000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000e5891850bb3f03090f03010000806f0800401000000000000000000000000000000000000000000000000000000000068b7619000000000000000000000000000000000000000000000000006f05b59d3b2000000000000000000000000000000000000000000000000000000000000888071e0000000000000000000000000000000000000000000000000000000000000002b4200000000000000000000000000000000000006000064833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000016000000000000000000000012000000000000001370000000000000190aee2b8d4a154e36f479daece3fb3e6c3c03d396e0140008400a400d80000000b00000000000000000000000000000000000000000000000000000000f28c0498000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000e5891850bb3f03090f03010000806f0800401000000000000000000000000000000000000000000000000000000000068b76190000000000000000000000000000000000000000000000000008e1bc9bf040000000000000000000000000000000000000000000000000000000000000aeb7fb1000000000000000000000000000000000000000000000000000000000000002b4200000000000000000000000000000000000006000064833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000";

        // We need to update the block for the fork test because the calldata doesn't work on the forked block in setup.
        // This is because one of the pools used is not available on the forked block in setup. This could also happen
        // if the size of a pool used in the calldata in the block from setup is too small.
        vm.rollFork(34727190);
        _deployIntegrationTestContracts();

        uint256 initialBalance = 1_000_000_000e6;
        uint256 newOutputAmount = 1.1 ether;

        deal(address(USDC), address(this), initialBalance);
        USDC.transfer(address(veloraAdapter), initialBalance);

        // Since the receiver on the calldata is the velora adapter, expect the outputToken to be transfered
        // from the adapter to the user
        vm.expectEmit(true, true, true, true);
        emit IERC20.Transfer(address(veloraAdapter), user, newOutputAmount);
        veloraAdapter.buy(
            AUGUSTUS_V6_2,
            buyCalldata,
            address(USDC),
            address(WETH),
            newOutputAmount,
            IVeloraAdapter.Offsets(outputAmountOffset, maxInputAmountOffset, quotedInputAmountOffset),
            user
        );

        uint256 sold = initialBalance - IERC20(USDC).balanceOf(user);
        assertEq(sold, 5038.378251e6, "sold");

        assertEq(IERC20(WETH).balanceOf(user), newOutputAmount, "bought");
    }

    function testFork_buy_NoAdjustment() public {
        // Slippage on quote amount set to 10%, required in order for the swap to not revert
        // Exact output swap to 1 WETH from USDC
        bytes memory buyCalldata =
            hex"7f4576750000000000000000000000000e5891850bb3f03090f03010000806f080040100000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000001274aa09d0000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000010c72637716b8a0044b514f0e9d256b43b4dab958000000000000000000000000021322530000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004e000000160000000000000000000000120000000000000013700000000000002581b2b6ce813b99b840fe632c63bca5394938ef01e0140008400a400000000000300000000000000000000000000000000000000000000000000000000f28c0498000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000e5891850bb3f03090f03010000806f0800401000000000000000000000000000000000000000000000000000000000068b9dc0b00000000000000000000000000000000000000000000000000d529ae9e86000000000000000000000000000000000000000000000000000000000000101b3a41000000000000000000000000000000000000000000000000000000000000002b4200000000000000000000000000000000000006000001833589fcd6edb6e08f4c7c32d4f71b54bda0291300000000000000000000000000000000000000000000000160000000000000000000000120000000000000013700000000000022601b81d678ffb9c0263b24a97847620c99d213eb140140008400a400000000000300000000000000000000000000000000000000000000000000000000f28c0498000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000e5891850bb3f03090f03010000806f0800401000000000000000000000000000000000000000000000000000000000068b9dc0b0000000000000000000000000000000000000000000000000c3663566a58000000000000000000000000000000000000000000000000000000000000ec3bec9c000000000000000000000000000000000000000000000000000000000000002b4200000000000000000000000000000000000006000064833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000000000000000000000000000016000000000000000000000012000000000000001370000000000000258aee2b8d4a154e36f479daece3fb3e6c3c03d396e0140008400a400000000000300000000000000000000000000000000000000000000000000000000f28c0498000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000e5891850bb3f03090f03010000806f0800401000000000000000000000000000000000000000000000000000000000068b9dc0b00000000000000000000000000000000000000000000000000d529ae9e86000000000000000000000000000000000000000000000000000000000000101b3c9a000000000000000000000000000000000000000000000000000000000000002b4200000000000000000000000000000000000006000064833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000";
        uint256 outputAmount = 1 ether;

        // vm.rollFork does not work here, we run into reverts on the buy.
        // We need to update the block for the fork test because the calldata doesn't work on the forked block in setup.
        // This is because one of the pools used is not available on the forked block in setup. This could also happen
        // if the size of a pool used in the calldata in the block from setup is too small.
        vm.rollFork(34808340);
        _deployIntegrationTestContracts();

        uint256 initialBalance = 1_000_000_000e6;

        deal(address(USDC), address(this), initialBalance);
        USDC.transfer(address(veloraAdapter), initialBalance);

        veloraAdapter.buy(
            AUGUSTUS_V6_2,
            buyCalldata,
            address(USDC),
            address(WETH),
            0,
            IVeloraAdapter.Offsets(outputAmountOffset, maxInputAmountOffset, 0),
            user
        );

        uint256 sold = initialBalance - IERC20(USDC).balanceOf(user);
        assertEq(sold, 4503.790455e6, "sold");

        assertEq(IERC20(WETH).balanceOf(user), outputAmount, "bought");
    }

    function testFork_buy_CallDataReceiverIsNotVeloraAdapter() public {
        // Receiver on calldata is not the VeloraAdapter
        // Exact output swap to 1 WETH from USDC
        bytes memory buyCalldata =
            hex"7f4576750000000000000000000000000e5891850bb3f03090f03010000806f080040100000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000010d2c88800000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000010d2c8880e84a0e6de891413eb7e8b2d33cd22dcd000000000000000000000000021310f70000000000000000000000006ca6d1e2d5347bfab1d91e883f1915560e09129d000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004c0000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004e00000016000000000000000000000008c000000000000006c00000000000000c876578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef8000000000000000000000000f0b95abb49055cf3204b2d5ffe97df570c47cea6000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000470de4df820000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000016000000000000000000000008c000000000000006c000000000000019076578ecf9a141296ec657847fb45b0585bcda3a601400064012500440000000b0000000000000000000000000000000000000000000000000000000094e86ef800000000000000000000000088c044fb203b58b12252be7242926b1eeb113b4a000000000000000000000000833589fcd6edb6e08f4c7c32d4f71b54bda029130000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000008e1bc9bf040000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000160000000000000000000000120000000000000013700000000000024b81b81d678ffb9c0263b24a97847620c99d213eb140140008400a400d80000000b00000000000000000000000000000000000000000000000000000000f28c0498000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000e5891850bb3f03090f03010000806f0800401000000000000000000000000000000000000000000000000000000000068b9b9520000000000000000000000000000000000000000000000000d0b8d0508de000000000000000000000000000000000000000000000000000000000000fd06389b000000000000000000000000000000000000000000000000000000000000002b4200000000000000000000000000000000000006000064833589fcd6edb6e08f4c7c32d4f71b54bda02913000000000000000000000000000000000000000000";

        // vm.rollFork does not work here, we run into reverts on the buy.
        // We need to update the block for the fork test because the calldata doesn't work on the forked block in setup.
        // This is because one of the pools used is not available on the forked block in setup. This could also happen
        // if the size of a pool used in the calldata in the block from setup is too small.
        vm.rollFork(34803707);
        _deployIntegrationTestContracts();

        uint256 initialBalance = 1_000_000_000e6;
        uint256 newOutputAmount = 1.0001 ether;

        deal(address(USDC), address(this), initialBalance);
        USDC.transfer(address(veloraAdapter), initialBalance);

        veloraAdapter.buy(
            AUGUSTUS_V6_2,
            buyCalldata,
            address(USDC),
            address(WETH),
            newOutputAmount,
            IVeloraAdapter.Offsets(outputAmountOffset, maxInputAmountOffset, quotedInputAmountOffset),
            user
        );

        uint256 sold = initialBalance - IERC20(USDC).balanceOf(user);
        assertEq(sold, 4516.44123e6, "sold");

        assertEq(IERC20(WETH).balanceOf(user), newOutputAmount, "bought");
    }
}
